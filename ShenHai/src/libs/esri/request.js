// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ./core/tsSupport/assignHelper ./core/tsSupport/awaiterHelper ./core/tsSupport/generatorHelper ./config ./kernel ./core/Error ./core/global ./core/has ./core/lang ./core/promiseUtils ./core/string ./core/urlUtils @dojo/framework/shim/Promise".split(" "),function(E,ga,K,u,C,y,v,I,z,A,M,B,S,n){function w(a,b){var c=B.createAbortController();return B.create(function(d,h){T(c.signal,a,b).then(d).catch(h)},function(){c.abort()})}function T(a,b,c){return u(this,void 0,void 0,function(){var d,
h,e,f,k,g,l,m;return C(this,function(t){switch(t.label){case 0:return d=n.isDataProtocol(b),(h=n.isBlobProtocol(b))||d||(b=n.normalize(b)),e={url:b,requestOptions:K({},c)},(f=n.getInterceptor(b))?[4,U(f,e)]:[3,2];case 1:k=t.sent();if(null!=k)return[2,{data:k,getHeader:J,requestOptions:e.requestOptions,url:e.url}];f.after||f.error||(f=null);t.label=2;case 2:b=e.url;c=e.requestOptions;if("image"===c.responseType){if(A("host-webworker"))throw x("request:invalid-parameters",Error("responseType 'image' is not supported in Web Workers or Node environment"),
e);}else if(d)throw x("request:invalid-parameters",Error("Data URLs are not supported for responseType \x3d "+c.responseType),e);if("head"===c.method){if(c.body)throw x("request:invalid-parameters",Error("body parameter cannot be set when method is 'head'"),e);if(d||h)throw x("request:invalid-parameters",Error("data and blob URLs are not supported for method 'head'"),e);}return[4,V()];case 3:t.sent();if(F)return[2,F.execute(b,c)];g=B.createAbortController();B.onAbort(a,function(){return g.abort()});
B.onAbort(c,function(){return g.abort()});l={controller:g,credential:null,credentialToken:null,fetchOptions:null,hasToken:!1,interceptor:f,params:e,redoRequest:!1,useIdentity:y.request.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1};return[4,W(l)];case 4:return m=t.sent(),f&&f.after&&f.after(m),[2,m]}})})}function X(a){n.isBlobProtocol(a)||n.isDataProtocol(a)||(a=n.getOrigin(a))&&-1===w._corsServers.indexOf(a)&&w._corsServers.push(a)}function Y(a){a=n.getOrigin(a);return!a||S.endsWith(a,".arcgis.com")||
-1!==w._corsServers.indexOf(a)||n.isTrustedServer(a)}function N(){var a;try{a=new DOMException("Aborted","AbortError")}catch(b){a=Error("Aborted"),a.name="AbortError"}return a}function x(a,b,c,d){var h="Error",e={url:c.url,requestOptions:c.requestOptions,getHeader:J,ssl:!1};if(b instanceof I)return b.details?(b.details=M.clone(b.details),b.details.url=c.url,b.details.requestOptions=c.requestOptions):b.details=e,b;if(b){c=d&&function(a){return d.headers.get(a)};var f=d&&d.status,k=b.message;k&&(h=
k);c&&(e.getHeader=c);e.httpStatus=(null!=b.httpCode?b.httpCode:b.code)||f||0;e.subCode=b.subcode;e.messageCode=b.messageCode;e.messages="string"===typeof b.details?[b.details]:b.details}a=new I(a,h,e);b&&"cancel"===b.dojoType&&(a.dojoType="cancel");return a}function V(){return u(this,void 0,void 0,function(){var a;return C(this,function(b){switch(b.label){case 0:return A("host-webworker")?F?[3,2]:[4,new Promise(function(a,b){E(["./core/workers/request"],a,b)})]:[3,3];case 1:F=b.sent(),b.label=2;
case 2:return[3,6];case 3:if(w._abortableFetch)return[3,6];if(!A("esri-abortable-fetch")||!A("esri-native-promise")&&(13>A("safari")||13>A("ios")))return[3,4];w._abortableFetch=z.fetch.bind(z);return[3,6];case 4:return a=w,[4,new Promise(function(a,b){E(["whatwg-fetch"],a,b)})];case 5:a._abortableFetch=b.sent().fetch,b.label=6;case 6:return[2]}})})}function G(){return u(this,void 0,void 0,function(){return C(this,function(a){switch(a.label){case 0:return v.id?[3,2]:[4,new Promise(function(a,c){E(["./identity/IdentityManager"],
a,c)})];case 1:a.sent(),a.label=2;case 2:return[2]}})})}function Z(a){return u(this,void 0,void 0,function(){var b,c,d,h,e,f,k,g;return C(this,function(l){switch(l.label){case 0:b=a.params.url;c=a.params.requestOptions;d=a.controller.signal;h=c.body;k=f=e=null;O&&"HTMLFormElement"in z&&(h instanceof FormData?e=h:h instanceof HTMLFormElement&&(f=h,e=new FormData(f)));"string"===typeof h&&(k=h);a.fetchOptions={cache:c.cacheBust&&!w._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",
headers:c.headers||{},method:"head"===c.method?"HEAD":"GET",mode:"cors",redirect:"follow",signal:d};if(e||k)a.fetchOptions.body=e||k;"anonymous"===c.authMode&&(a.useIdentity=!1);a.hasToken=!!(/token=/i.test(b)||c.query&&c.query.token||e&&e.get&&e.get("token")||f&&f.elements.token);if(!a.useIdentity||a.hasToken||a.credentialToken||P(b)||B.isAborted(d))return[3,11];g=void 0;return"immediate"!==c.authMode?[3,3]:[4,G()];case 1:return l.sent(),[4,v.id.getCredential(b,{signal:d})];case 2:return g=l.sent(),
a.credential=g,[3,10];case 3:return"no-prompt"!==c.authMode?[3,9]:[4,G()];case 4:l.sent(),l.label=5;case 5:return l.trys.push([5,7,,8]),[4,v.id.getCredential(b,{prompt:!1,signal:d})];case 6:return g=l.sent(),a.credential=g,[3,8];case 7:return l.sent(),[3,8];case 8:return[3,10];case 9:v.id&&(g=v.id.findCredential(b)),l.label=10;case 10:g&&(a.credentialToken=g.token,a.useSSL=!!g.ssl),l.label=11;case 11:return[2]}})})}function P(a){return aa.some(function(b){return b.test(a)})}function ba(a){return u(this,
void 0,void 0,function(){var b,c,d,h,e,f,k,g,l,m,t,q,u,z,F,H,E,D,p,I,J,G,L;return C(this,function(r){switch(r.label){case 0:b=a.params.url;c=a.params.requestOptions;d=a.fetchOptions;h=n.isBlobProtocol(b)||n.isDataProtocol(b);e=c.responseType||"json";f=h?0:null!=c.timeout?c.timeout:y.request.timeout;k=!1;if(!h){a.useSSL&&(b=n.toHTTPS(b));c.cacheBust&&"default"===d.cache&&(b=n.addQueryParameter(b,"request.preventCache",Date.now()));g=K({},c.query);a.credentialToken&&(g.token=a.credentialToken);l=n.objectToQuery(g);
A("esri-url-encodes-apostrophe")&&(l=l.replace(/'/g,"%27"));m=b.length+1+l.length;t=void 0;k="post"===c.method||!!c.body||m>y.request.maxUrlLength;if(q=c.useProxy||!!n.getProxyRule(b))u=n.getProxyUrl(b),t=u.path,!k&&t.length+1+m>y.request.maxUrlLength&&(k=!0),u.query&&(g=K({},u.query,g));if("HEAD"===d.method&&(k||q)){if(k){if(m>y.request.maxUrlLength)throw x("request:invalid-parameters",Error("URL exceeds maximum length"),a.params);throw x("request:invalid-parameters",Error("cannot use POST request when method is 'head'"),
a.params);}if(q)throw x("request:invalid-parameters",Error("cannot use proxy when method is 'head'"),a.params);}k?(d.method="POST",c.body?b=n.addQueryParameters(b,g):(d.body=n.objectToQuery(g),d.headers["Content-Type"]="application/x-www-form-urlencoded")):b=n.addQueryParameters(b,g);q&&(a.useProxy=!0,b=t+"?"+b);g.token&&O&&d.body instanceof FormData&&(z=d.body,z.set?z.set("token",g.token):z.append("token",g.token));c.hasOwnProperty("withCredentials")?a.withCredentials=c.withCredentials:n.isTrustedServer(b)?
a.withCredentials=!0:v.id&&(F=v.id.findServerInfo(b))&&F.webTierAuth&&(a.withCredentials=!0);a.withCredentials&&(d.credentials="include")}H=0;E=!1;0<f&&(H=setTimeout(function(){E=!0;a.controller.abort()},f));r.label=1;case 1:return r.trys.push([1,18,19,20]),"image"!==c.responseType||"default"!==d.cache||"GET"!==d.method||k||ca(c.headers)||!h&&!a.useProxy&&y.request.proxyUrl&&!Y(b)?[3,3]:[4,Q(b,a)];case 2:return p=r.sent(),[3,17];case 3:return[4,w._abortableFetch(b,d)];case 4:D=r.sent();a.useProxy||
X(b);if(!D.ok||"HEAD"===d.method)return[3,17];I=e;switch(I){case "array-buffer":return[3,5];case "blob":return[3,7];case "image":return[3,7]}return[3,9];case 5:return[4,D.arrayBuffer()];case 6:return p=r.sent(),[3,11];case 7:return[4,D.blob()];case 8:return p=r.sent(),[3,11];case 9:return[4,D.text()];case 10:return p=r.sent(),[3,11];case 11:H&&(clearTimeout(H),H=0);if("json"===e||"xml"===e||"document"===e)if(p)switch(e){case "json":p=JSON.parse(p);break;case "xml":p=R(p,"application/xml");break;case "document":p=
R(p,"text/html")}else p=null;J=D.headers.get("Content-Type");if(!/application\/json|text\/plain/i.test(J)||!(p instanceof ArrayBuffer&&750>=p.byteLength||p instanceof Blob&&750>=p.size))return[3,15];r.label=12;case 12:return r.trys.push([12,14,,15]),[4,(new Response(p)).json()];case 13:return G=r.sent(),G.error&&(p=G),[3,15];case 14:return r.sent(),[3,15];case 15:return"image"===e&&p instanceof Blob?[4,Q(URL.createObjectURL(p),a,!0)]:[3,17];case 16:p=r.sent(),r.label=17;case 17:return[3,20];case 18:L=
r.sent();if("AbortError"===L.name){if(E)throw Error("Timeout exceeded");throw B.createAbortError("Request canceled");}if(!D&&L instanceof TypeError&&y.request.proxyUrl&&!c.body&&"post"!==c.method&&"head"!==c.method&&!a.useProxy)a.redoRequest=!0,n.addProxyRule({proxyUrl:y.request.proxyUrl,urlPrefix:n.removeFile(n.urlToObject(b).path)});else throw L;return[3,20];case 19:return H&&clearTimeout(H),[7];case 20:return[2,[D,p]]}})})}function U(a,b){return u(this,void 0,void 0,function(){var c,d,h;return C(this,
function(e){switch(e.label){case 0:if(null!=a.responseData)return[2,a.responseData];a.headers&&(b.requestOptions.headers=K({},b.requestOptions.headers,a.headers));a.query&&(b.requestOptions.query=K({},b.requestOptions.query,a.query));if(!a.before)return[3,5];d=c=void 0;e.label=1;case 1:return e.trys.push([1,3,,4]),[4,a.before(b)];case 2:return d=e.sent(),[3,4];case 3:return h=e.sent(),c=x("request:interceptor",h,b),[3,4];case 4:if(d instanceof Error||d instanceof I)c=x("request:interceptor",d,b);
if(c)throw a.error&&a.error(c),c;return[2,d];case 5:return[2]}})})}function ca(a){if(a)for(var b=0,c=Object.getOwnPropertyNames(a);b<c.length;b++)if(a[c[b]])return!0;return!1}function R(a,b){var c;try{c=(new DOMParser).parseFromString(a,b)}catch(d){}if(!c||c.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return c}function W(a){return u(this,void 0,void 0,function(){var b,c,d,h,e,f,k,g,l,m,t;return C(this,function(q){switch(q.label){case 0:return[4,Z(a)];case 1:q.sent(),
q.label=2;case 2:q.trys.push([2,8,,9]),q.label=3;case 3:return[4,ba(a)];case 4:b=q.sent(),c=b[0],d=b[1],q.label=5;case 5:return[4,da(a,c,d)];case 6:if(!q.sent())return[3,3];q.label=7;case 7:return[3,9];case 8:throw h=q.sent(),e=x("request:server",h,a.params,c),e.details.ssl=a.useSSL,a.interceptor&&a.interceptor.error&&a.interceptor.error(e),e;case 9:return f=a.params.url,/\/sharing\/rest\/(accounts|portals)\/self/i.test(f)&&!a.hasToken&&!a.credentialToken&&d&&d.user&&d.user.username&&!n.isTrustedServer(f)&&
(k=n.getOrigin(f,!0))&&y.request.trustedServers.push(k),(g=a.credential)&&v.id&&(m=(l=v.id.findServerInfo(g.server))&&l.owningSystemUrl)&&(m=m.replace(/\/?$/,"/sharing"),(t=v.id.findCredential(m,g.userId))&&-1===v.id._getIdenticalSvcIdx(m,t)&&t.resources.unshift(m)),[2,{data:d,getHeader:c?function(a){return c.headers.get(a)}:J,requestOptions:a.params.requestOptions,ssl:a.useSSL,url:a.params.url}]}})})}function da(a,b,c){return u(this,void 0,void 0,function(){var d,h,e,f,k,g,l;return C(this,function(m){switch(m.label){case 0:if(a.redoRequest)return a.redoRequest=
!1,[2,!1];if(!b)return[2,!0];if(!b.ok)throw Error("Unable to load "+b.url+" status: "+b.status);c&&c.error&&(d=M.mixin(Error(),c.error));d&&(h=Number(d.code),e=d.hasOwnProperty("subcode")?Number(d.subcode):null,f=(f=d.messageCode)&&f.toUpperCase());k=a.params.requestOptions.authMode;return 403===h&&(4===e||d.message&&-1<d.message.toLowerCase().indexOf("ssl")&&-1===d.message.toLowerCase().indexOf("permission"))?a.useSSL?[3,6]:(a.useSSL=!0,[2,!1]):[3,1];case 1:return!a.useIdentity||"no-prompt"===k&&
498!==h||-1===ea.indexOf(h)||P(a.params.url)||!(403!==h||-1===fa.indexOf(f)&&(null==e||2===e&&a.credentialToken))?[3,6]:[4,G()];case 2:m.sent(),m.label=3;case 3:return m.trys.push([3,5,,6]),[4,v.id.getCredential(a.params.url,{error:x("request:server",d,a.params),prompt:"no-prompt"!==k,signal:a.controller.signal,token:a.credentialToken})];case 4:return g=m.sent(),a.credential=g,a.credentialToken=g.token,a.useSSL=a.useSSL||g.ssl,[2,!1];case 5:l=m.sent();if("no-prompt"===k)return a.credential=null,a.credentialToken=
null,[2,!1];d=l;return[3,6];case 6:if(d)throw d;return[2,!0]}})})}function Q(a,b,c){void 0===c&&(c=!1);return B.create(function(d,h){var e=b.controller.signal;if(B.isAborted(e))throw N();var f=new Image;f.crossOrigin=b.withCredentials?"use-credentials":"anonymous";var k=function(){m();h(Error("Unable to load "+a))},g=function(){var a=f;m();d(a)},l=function(){if(f){var a=f;m();a.src="";h(N())}},m=function(){A("esri-image-decode")||(f.removeEventListener("error",k),f.removeEventListener("load",g));
f=g=k=null;e.removeEventListener("abort",l);l=null;c&&URL.revokeObjectURL(a)};f.alt="";f.src=a;e.addEventListener("abort",l);A("esri-image-decode")?f.decode().then(g,k):(f.addEventListener("error",k),f.addEventListener("load",g))})}var F,O="FormData"in z,ea=[499,498,403,401],fa=["COM_0056","COM_0057","SB_0008"],aa=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],J=function(){return null};w._abortableFetch=null;w._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"];
return w});