// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
require({cache:{"esri/views/2d/engine/vectorTiles/TileHandler":function(){define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../request ../../../../core/has ../../../../core/ItemCache ../../../../core/maybe ../../../../core/MemCache ../../../../core/promiseUtils ../../../../core/requireUtils ../../../../core/workers ../../../../geometry/support/aaBoundingRect ../vectorTiles/VectorTile ./GeometryUtils ./GlyphMosaic ./GlyphSource ./SpriteMosaic ./TileIndex ../../tiling/TileKey module".split(" "),
function(p,k,m,g,b,f,a,c,e,d,h,n,x,C,w,t,r,E,B,z,u,q){Object.defineProperty(k,"__esModule",{value:!0});var l=new c(10),y=new Map;c=function(){function c(a,d,e,h,n){this._vectorTileLayer=a;this.devicePixelRatio=d;this.allowUpdates=e;this._container=h;this._memCache=n;this._connection=this._glyphMosaic=this._spriteMosaic=null;this._updateToAbortController=new Map;this._ongoingTileRequests=new Map;this._ongoingRequestToController=new Map}c.prototype.destroy=function(){this._updateToAbortController&&
this._updateToAbortController.forEach(function(a){return a.abort()});this._ongoingTileRequests&&this.abortAll();this._connection&&(this._connection.close(),this._connection=null);this._vectorTileLayer=null;this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null);this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null)};Object.defineProperty(c.prototype,"spriteMosaic",{get:function(){var a=this;return this._spriteSourcePromise.then(function(){return a._spriteMosaic})},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"glyphMosaic",{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0});c.prototype.start=function(a){return b(this,void 0,void 0,function(){var d,e,c,v,l,b=this;return g(this,function(f){d=this._vectorTileLayer.sourceNameToSource;e=[];for(c in d)e.push(this._fetchTileMap(d[c],a));this._spriteSourcePromise=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio,a);this._spriteSourcePromise.then(function(a){b._spriteMosaic=
new B(1024,1024,250);b._spriteMosaic.setSpriteSource(a)});v=this._vectorTileLayer.styleRepository;l=new E(v.glyphs);this._glyphMosaic=new r(1024,1024,l);this._broadcastPromise=x.open(n.getAbsMid("../vectorTiles/WorkerTileHandler",p,q),{client:this,scheduler:a.scheduler,signal:a.signal}).then(function(d){b._connection=d;return h.all(b._connection.broadcast("setLayers",v.styleJSON,m({},a)))});return[2,h.all(e)]})})};c.prototype.updateStyle=function(){return b(this,void 0,void 0,function(){var a,d=this;
return g(this,function(e){switch(e.label){case 0:return[4,this._broadcastPromise];case 1:return e.sent(),this._updateToAbortController.forEach(function(a){return a.abort()}),this._updateToAbortController.clear(),a=this._vectorTileLayer.styleRepository,this._broadcastPromise=h.create(function(e,c){h.all(d._connection.broadcast("updateStyle",a.styleJSON)).then(e,c)}),[2,this._broadcastPromise]}})})};c.prototype.abortTileUpdate=function(a){this._updateToAbortController.has(a)&&(this._updateToAbortController.get(a).abort(),
this._updateToAbortController.delete(a))};c.prototype.updateTile=function(a,e){return b(this,void 0,void 0,function(){var d,c,n,l,b=this;return g(this,function(v){switch(v.label){case 0:return this.allowUpdates&&a.isReady?[4,this._broadcastPromise]:[2];case 1:v.sent();d=Math.round(t.degToByte(e.state.rotation));if(a.rotation===d)return[2,null];n=a.key;this._updateToAbortController.has(n.id)&&(c=this._updateToAbortController.get(n.id),c.abort(),this._updateToAbortController.delete(n.id));c=h.createAbortController();
a.rotation=d;l=a.client.invoke("updateSymbols",{key:a.id,rotation:d},{signal:c.signal}).then(function(d){b._updateToAbortController.delete(n.id);a.isReady&&a.updateSymbolData(d)}).catch(function(a){h.isAbortError(a)||b._updateToAbortController.delete(n.id)});this._updateToAbortController.set(a.id,c);return[2,l]}})})};c.prototype.updateTileData=function(a){for(var d=a.tileId,e=this._container.children,c,n=0;n<e.length;n++)if(c=e[n],c.id===d){c.updateTileData(a.tileData);break}};c.prototype.getVectorTile=
function(a,c,n){return b(this,void 0,void 0,function(){var h,l,b,v,f,A,q;return g(this,function(y){switch(y.label){case 0:return h=new u(a,c,n,0),e.isSome(this._memCache)&&(l=this._memCache.get(h.id))?(l.reference(),[2,l]):[4,this._getVectorTileData(h,null)];case 1:b=y.sent();if(e.isSome(this._memCache)&&(v=this._memCache.get(h.id)))return v.reference(),[2,v];f=this._vectorTileLayer.tileInfo;A=f.getTileBounds(C.create(),h);q=new w.VectorTile(h,this._vectorTileLayer.styleRepository,A,[512,512]);b&&
b.tileData?(q.setData(b.tileData,b.client),e.isSome(this._memCache)&&(q.reference(),this._memCache.put(q.key.id,q,q.getMemoryUsage()*q.referenced,d.MIN_PRIORITY))):q.setData(null,null);return[2,q]}})})};c.prototype.releaseVectorTile=function(a){e.isNone(this._memCache)||a.release()||this._memCache.updateSize(a.key.id,a,a.getMemoryUsage()*a.referenced)};c.prototype.fetchTileData=function(a,d){return b(this,void 0,void 0,function(){var e,c,n,h;return g(this,function(b){switch(b.label){case 0:return[4,
this._getRefKeys(a,d)];case 1:e=b.sent();c=this._vectorTileLayer.sourceNameToSource;n=[];for(h in c)n.push(h);return[2,this._getSourcesData(n,e,d)]}})})};c.prototype.parseTileData=function(d,e,c){return b(this,void 0,void 0,function(){var n,h,b,l,v,f,q,A;return g(this,function(y){switch(y.label){case 0:n=d&&d.data;if(!n)return[2,null];h=n.sourceName2DataAndRefKey;b=n.transferList;return 0===Object.keys(h).length?[2,null]:[4,this._broadcastPromise];case 1:return y.sent(),l=Math.round(t.degToByte(e)),
v=this._connection.getAvailableClient(),[4,v.invoke("createTileAndParse",{key:d.key.id,rotation:l,cacheTile:this.allowUpdates,sourceName2DataAndRefKey:h},m({},c,{transferList:b})).catch(function(){v.invoke("destructTileData",d.key.id);return null})];case 2:f=y.sent();if(a("esri-vector-tiles-debug")){q={};for(A in h)q[A]=h[A].refKey;return[2,{tileData:f,client:v,refKeys:q}]}return[2,{tileData:f,client:v}]}})})};Object.defineProperty(c.prototype,"updating",{get:function(){return 0<this._ongoingTileRequests.size},
enumerable:!0,configurable:!0});c.prototype.abortAll=function(){this._ongoingRequestToController.forEach(function(a){return a.abort()});this._ongoingRequestToController.clear();this._ongoingTileRequests.clear()};c.prototype.getSprites=function(a){return b(this,void 0,void 0,function(){return g(this,function(d){switch(d.label){case 0:return[4,this._spriteSourcePromise];case 1:return d.sent(),[2,this._spriteMosaic.getSpriteItems(a)]}})})};c.prototype.getGlyphs=function(a){return this._glyphMosaic.getGlyphItems(a.font,
a.codePoints)};c.prototype.getStyleRepository=function(){return this._vectorTileLayer.styleRepository};c.prototype._getTilePayload=function(a,d,e){return b(this,void 0,void 0,function(){var n,c,h,b,l;return g(this,function(v){switch(v.label){case 0:return n=u.pool.acquire(a.id),c=this._vectorTileLayer.sourceNameToSource,h=c[d],b=h.getSourceTileUrl(n.level,n.row,n.col),u.pool.release(n),[4,f(b,m({responseType:"array-buffer"},e))];case 1:return l=v.sent(),[2,{protobuff:l.data,sourceName:d}]}})})};c.prototype._fetchTileMap=
function(a,d){if(a.capabilities.operations.supportsTileMap&&a.tileIndex||!a.tileMapURL)return h.resolve();var e=l.get(a.tileMapURL);if(e)return a.tileIndex=e,h.resolve();if(y.has(a.tileMapURL))return y.get(a.tileMapURL).then(function(d){a.tileIndex=new z(d.data)});d=f(a.tileMapURL,d);d.then(function(d){a.tileIndex=new z(d.data);y["delete"](a.tileMapURL);l.put(a.tileMapURL,a.tileIndex)});y.set(a.tileMapURL,d);return d};c.prototype._getRefKeys=function(a,d){return b(this,void 0,void 0,function(){var e,
n,c,b,l;return g(this,function(f){e=this._vectorTileLayer.sourceNameToSource;n=[];for(c in e)b=e[c],l=b.getRefKey(a,d),n.push(l);return[2,h.eachAlways(n)]})})};c.prototype._getSourcesData=function(a,d,e){return b(this,void 0,void 0,function(){var n,c,b,l,f,v,q;return g(this,function(A){switch(A.label){case 0:n=[];for(c=0;c<d.length;c++)null==d[c].value||null==a[c]?n.push(null):(b=this._getTilePayload(d[c].value,a[c],e),n.push(b));return[4,h.eachAlways(n)];case 1:l=A.sent();f={};v=[];for(c=0;c<l.length;c++)l[c].value&&
l[c].value&&l[c].value.protobuff&&0<l[c].value.protobuff.byteLength&&(q=d[c].value.id,f[l[c].value.sourceName]={refKey:q,protobuff:l[c].value.protobuff},v.push(l[c].value.protobuff));return[2,{sourceName2DataAndRefKey:f,transferList:v}]}})})};c.prototype._getVectorTileData=function(a,d){return b(this,void 0,void 0,function(){var c,e,n,l,b,f=this;return g(this,function(q){c=a.id;if(this._ongoingTileRequests.has(c))return[2,this._ongoingTileRequests.get(c)];e=new AbortController;n={signal:e.signal};
l=d&&d.signal;b=this._getParsedVectorTileData(a,n).then(function(a){f._ongoingTileRequests.delete(c);f._ongoingRequestToController.delete(c);return a}).catch(function(){f._ongoingTileRequests.delete(c);f._ongoingRequestToController.delete(c);return null});this._ongoingTileRequests.set(c,b);this._ongoingRequestToController.set(c,e);if(l)h.onAbort(l,function(){e.abort();f._ongoingTileRequests.delete(c);f._ongoingRequestToController.delete(c)});return[2,b]})})};c.prototype._getParsedVectorTileData=function(a,
d){return b(this,void 0,void 0,function(){var c;return g(this,function(e){switch(e.label){case 0:return[4,this.fetchTileData(a,d)];case 1:return c=e.sent(),[2,this.parseTileData({key:a,data:c},0,d)]}})})};return c}();k.TileHandler=c})},"esri/core/ItemCache":function(){define(["require","exports","./MemCache"],function(p,k,m){return function(){function g(b,f){this._storage=new m.MemCacheStorage;this._storage.maxSize=b;f&&this._storage.registerRemoveFunc("",f)}g.prototype.put=function(b,f){this._storage.put(b,
f,1,1)};g.prototype.pop=function(b){return this._storage.pop(b)};g.prototype.get=function(b){return this._storage.get(b)};g.prototype.clear=function(){this._storage.clearAll()};g.prototype.destroy=function(){this._storage.clearAll()};return g}()})},"esri/views/2d/engine/vectorTiles/VectorTile":function(){define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/now ../../../webgl ./RenderBucket ../webgl/TiledDisplayObject".split(" "),function(p,k,m,g,b,f,a){Object.defineProperty(k,
"__esModule",{value:!0});p=function(a){function d(d,e,b,h){b=a.call(this,d,b,h,[4096,4096])||this;b._referenced=0;b._symbolFadeHold=null;b._vectorTileData=null;b._setData=!1;b._symbolUpdateData=null;b._memoryUsed=c;b.rotation=0;b.layerData={};b.status="loading";b._referenced=1;b.styleLayers=e;b.id=d.id;return b}m(d,a);Object.defineProperty(d.prototype,"hasSymbolBuckets",{get:function(){return!1},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"isHoldingForFade",{get:function(){return null!==
this._symbolFadeHold},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"isSymbolFadeDone",{get:function(){return!this._symbolFadeHold||this._symbolFadeHold<g()},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"wasRequested",{get:function(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status},enumerable:!0,configurable:!0});d.prototype.setData=function(a,d,e){this._vectorTileData=a;this.client=d;this.refKeys=e;this._memoryUsed=c;this.ready();
this._setData=!0};d.prototype.updateSymbolData=function(a){a&&(this._symbolUpdateData=a,this.requestRender())};d.prototype.updateTileData=function(a){this._vectorTileData=a;this.stage.requestRender();this._memoryUsed=c};d.prototype.clearSymbolFadeHold=function(){this._symbolFadeHold=null};d.prototype.setSymbolHoldDuration=function(a){this._symbolFadeHold=g()+a};d.prototype.hasData=function(){return 0<Object.keys(this.layerData).length};d.prototype.dispose=function(){this._deleteBufferMemory();this.destroy();
this._memoryUsed=c};d.prototype.release=function(){return 0===--this._referenced?(this.dispose(),this.attached=!1,this.stage=null,!0):!1};d.prototype.reference=function(){++this._referenced};Object.defineProperty(d.prototype,"referenced",{get:function(){return this._referenced},enumerable:!0,configurable:!0});d.prototype.getMemoryUsage=function(){var a=this;this._memoryUsed===c&&(this._memoryUsed=e.reduce(function(d,c){return a[c]?d+a[c].size:d},0),this.texture&&(this._memoryUsed+=this.texture.descriptor.width*
this.texture.descriptor.height*4),this._vectorTileData&&this._vectorTileData.bufferData&&(this._memoryUsed+=this._vectorTileData.bufferData.reduce(function(a,d){return a+d.byteLength},this._vectorTileData.bufferDataInfo.byteLength+this._vectorTileData.bucketDataInfo.byteLength)));return this._memoryUsed/(this._referenced||1)};d.prototype.commitChanges=function(){if(this._vectorTileData||this._symbolUpdateData)this._vectorTileData?(this._deleteBufferMemory(),this._createRenderBuckets(),this._createBufferObjects(),
this._vectorTileData=null):this._symbolUpdateData&&(this._updateSymbolData(this._symbolUpdateData),this._symbolUpdateData=null)};d.prototype._deleteBufferMemory=function(){for(var a=0,d="fillVertexArrayObject fillDDVertexArrayObject outlineVertexArrayObject lineVertexArrayObject lineDDVertexArrayObject iconVertexArrayObject iconDDVertexArrayObject textVertexArrayObject textDDVertexArrayObject circleVertexArrayObject fillVertexBuffer fillDDVertexBuffer fillIndexBuffer outlineVertexBuffer outlineDDVertexBuffer outlineIndexBuffer lineVertexBuffer lineDDVertexBuffer lineIndexBuffer iconVertexBuffer iconDDVertexBuffer iconIndexBuffer textVertexBuffer textDDVertexBuffer textIndexBuffer circleVertexBuffer circleIndexBuffer texture".split(" ");a<
d.length;a++){var c=d[a];this[c]&&(this[c].dispose(),this[c]=null)}this.layerData={};this.triangleCount=0};d.prototype._createRenderBuckets=function(){for(var a=new Uint32Array(this._vectorTileData.bucketDataInfo),d=a.length,c=0;c<d;){var e=a[c];switch(a[c+1]){case 0:(new f.BackgroundRenderBucket).layerID=e;c+=2;break;case 1:var b=new f.FillRenderBucket;b.layerID=e;b.triangleElementStart=a[c+2];b.triangleElementCount=a[c+3];b.outlineElementStart=a[c+4];b.outlineElementCount=a[c+5];if(0!==b.triangleElementCount||
0!==b.outlineElementCount)this.layerData[e]=b;c+=6;break;case 2:b=new f.LineRenderBucket;b.layerID=e;b.triangleElementStart=a[c+2];b.triangleElementCount=a[c+3];0<b.triangleElementCount&&(this.layerData[e]=b);c+=4;break;case 3:b=new f.SymbolRenderBucket;b.layerID=e;b.isSDF=0!==a[c+2];var h=c+3,g=a[h];h++;for(var m=0;m<g;m++){var k=a[h],u=a[h+1],q=a[h+2];b.iconPerPageElementsMap.set(k,[u,q]);h+=3}var l=a[h];h++;for(m=0;m<l;m++)k=a[h],u=a[h+1],q=a[h+2],b.glyphPerPageElementsMap.set(k,[u,q]),h+=3;if(0<
b.iconPerPageElementsMap.size||0<b.glyphPerPageElementsMap.size)this.layerData[e]=b;c+=5+3*g+3*l;break;case 4:b=new f.CircleRenderBucket;b.layerID=e;b.triangleElementStart=a[c+2];b.triangleElementCount=a[c+3];0<b.triangleElementCount&&(this.layerData[e]=b);c+=4;break;default:console.error("Bad bucket type!"),c+=2}}};d.prototype.attach=function(){return this._setData};d.prototype.attachWithContext=function(a){this.stage={context:a};this.attached=this.attach()};d.prototype.detach=function(){this.isReady&&
this.client&&this.client.invoke("destructTileData",this.id);this.dispose();a.prototype.detach.call(this)};d.prototype._updateSymbolData=function(a){if(!a||!a.bucketDataInfo)return!0;var d=new Uint32Array(a.bucketDataInfo),c=d.length;if(0===c)return!0;if(!this.isReady)return this.requestRender(),!1;for(var e=this.stage.context,h=new Uint32Array(a.bufferDataInfo),n=h.length,g=0,m=0;m<n;m+=2,g++)switch(h[m]){case 10:this.iconVertexBuffer&&(this.iconVertexBuffer.dispose(),this.iconVertexBuffer=null);
this.iconVertexBuffer=b.BufferObject.createVertex(e,35044,a.bufferData[g]);break;case 11:this.iconDDVertexBuffer&&(this.iconDDVertexBuffer.dispose(),this.iconDDVertexBuffer=null);this.iconDDVertexBuffer=b.BufferObject.createVertex(e,35044,a.bufferData[g]);break;case 12:this.iconIndexBuffer&&(this.iconIndexBuffer.dispose(),this.iconIndexBuffer=null);this.iconIndexBuffer=b.BufferObject.createIndex(e,35044,a.bufferData[g]);break;case 13:this.textVertexBuffer&&(this.textVertexBuffer.dispose(),this.textVertexBuffer=
null);this.textVertexBuffer=b.BufferObject.createVertex(e,35044,a.bufferData[g]);break;case 14:this.textDDVertexBuffer&&(this.textDDVertexBuffer.dispose(),this.textDDVertexBuffer=null);this.textDDVertexBuffer=b.BufferObject.createVertex(e,35044,a.bufferData[g]);break;case 15:this.textIndexBuffer&&(this.textIndexBuffer.dispose(),this.textIndexBuffer=null),this.textIndexBuffer=b.BufferObject.createIndex(e,35044,a.bufferData[g])}a={};for(var k in this.layerData)3!==this.layerData[k].type&&(a[k]=this.layerData[k]);
this.layerData=a;e=this.styleLayers.layers;for(h=0;h<c;){k=d[h];n=new f.SymbolRenderBucket;n.layerID=k;n.isSDF=0!==d[h+2];e.length>n.layerID&&e[n.layerID].type===n.type&&(a[n.layerID]=n);var u=h+3;k=d[u];u++;for(g=0;g<k;g++){var m=d[u],q=d[u+1],l=d[u+2];n.iconPerPageElementsMap.set(m,[q,l]);u+=3}var y=d[u];u++;for(g=0;g<y;g++)m=d[u],q=d[u+1],l=d[u+2],n.glyphPerPageElementsMap.set(m,[q,l]),u+=3;h+=5+3*k+3*y}this.iconVertexArrayObject&&(this.iconVertexArrayObject.dispose(),this.iconVertexArrayObject=
null);this.iconDDVertexArrayObject&&(this.iconDDVertexArrayObject.dispose(),this.iconDDVertexArrayObject=null);this.textVertexArrayObject&&(this.textVertexArrayObject.dispose(),this.textVertexArrayObject=null);this.textDDVertexArrayObject&&(this.textDDVertexArrayObject.dispose(),this.textDDVertexArrayObject=null);return!0};d._createBufferToObject=function(){var a=[];a[1]={create:b.BufferObject.createVertex,var:"fillVertexBuffer"};a[2]={create:b.BufferObject.createVertex,var:"fillDDVertexBuffer"};
a[3]={create:b.BufferObject.createIndex,var:"fillIndexBuffer"};a[4]={create:b.BufferObject.createVertex,var:"outlineVertexBuffer"};a[5]={create:b.BufferObject.createVertex,var:"outlineDDVertexBuffer"};a[6]={create:b.BufferObject.createIndex,var:"outlineIndexBuffer"};a[7]={create:b.BufferObject.createVertex,var:"lineVertexBuffer"};a[8]={create:b.BufferObject.createVertex,var:"lineDDVertexBuffer"};a[9]={create:b.BufferObject.createIndex,var:"lineIndexBuffer"};a[10]={create:b.BufferObject.createVertex,
var:"iconVertexBuffer"};a[11]={create:b.BufferObject.createVertex,var:"iconDDVertexBuffer"};a[12]={create:b.BufferObject.createIndex,var:"iconIndexBuffer"};a[13]={create:b.BufferObject.createVertex,var:"textVertexBuffer"};a[14]={create:b.BufferObject.createVertex,var:"textDDVertexBuffer"};a[15]={create:b.BufferObject.createIndex,var:"textIndexBuffer"};a[16]={create:b.BufferObject.createVertex,var:"circleVertexBuffer"};a[17]={create:b.BufferObject.createIndex,var:"circleIndexBuffer"};return a};d.prototype._createBufferObjects=
function(){for(var a=this.stage.context,c=new Uint32Array(this._vectorTileData.bufferDataInfo),e=c.length,b=0;b<e;b+=2){var h=b/2;if(!(0>=c[b+1]||0===this._vectorTileData.bufferData[h].byteLength)){var f=c[b],g=d.bufferToObject[f];g?this[g.var]?this[g.var].setData(this._vectorTileData.bufferData[h]):this[g.var]=g.create(a,35044,this._vectorTileData.bufferData[h]):console.error("Bad buffer type "+f)}}};d.bufferToObject=d._createBufferToObject();return d}(a.TiledDisplayObject);k.VectorTile=p;var c=
-1,e="fillVertexBuffer fillDDVertexBuffer fillIndexBuffer outlineVertexBuffer outlineDDVertexBuffer outlineIndexBuffer lineVertexBuffer lineDDVertexBuffer lineIndexBuffer iconVertexBuffer iconDDVertexBuffer iconIndexBuffer textVertexBuffer textDDVertexBuffer textIndexBuffer circleVertexBuffer circleIndexBuffer".split(" ")})},"esri/views/2d/engine/vectorTiles/RenderBucket":function(){define(["require","exports","../../../../core/tsSupport/extendsHelper"],function(p,k,m){Object.defineProperty(k,"__esModule",
{value:!0});p=function(){return function(b){this.type=b}}();k.RenderBucket=p;var g=function(b){function f(){var a=b.call(this,2)||this;a.triangleElementStart=0;a.triangleElementCount=0;return a}m(f,b);f.prototype.hasData=function(){return 0<this.triangleElementCount};f.prototype.triangleCount=function(){return this.triangleElementCount/3};return f}(p);k.LineRenderBucket=g;g=function(b){function f(){var a=b.call(this,1)||this;a.triangleElementStart=0;a.triangleElementCount=0;a.outlineElementStart=
0;a.outlineElementCount=0;return a}m(f,b);f.prototype.hasData=function(){return 0<this.triangleElementCount||0<this.outlineElementCount};f.prototype.triangleCount=function(){return(this.triangleElementCount+this.outlineElementCount)/3};return f}(p);k.FillRenderBucket=g;g=function(b){function f(){var a=b.call(this,3)||this;a.iconPerPageElementsMap=new Map;a.glyphPerPageElementsMap=new Map;a.isSDF=!1;return a}m(f,b);f.prototype.hasData=function(){return 0<this.iconPerPageElementsMap.size||0<this.glyphPerPageElementsMap.size};
f.prototype.triangleCount=function(){var a=0;this.iconPerPageElementsMap.forEach(function(c){a+=c[1]});this.glyphPerPageElementsMap.forEach(function(c){a+=c[1]});return a/3};return f}(p);k.SymbolRenderBucket=g;g=function(b){function f(){var a=b.call(this,4)||this;a.triangleElementStart=0;a.triangleElementCount=0;return a}m(f,b);f.prototype.hasData=function(){return 0<this.triangleElementCount};f.prototype.triangleCount=function(){return this.triangleElementCount/3};return f}(p);k.CircleRenderBucket=
g;p=function(b){function f(){return b.call(this,0)||this}m(f,b);f.prototype.hasData=function(){return!0};f.prototype.triangleCount=function(){return 2};return f}(p);k.BackgroundRenderBucket=p})},"esri/views/2d/engine/vectorTiles/GlyphMosaic":function(){define("require exports ../../../../core/has ../../../../core/promiseUtils ../../../webgl ./RectangleBinPack ../webgl/Rect".split(" "),function(p,k,m,g,b,f,a){return function(){function c(a,d,c){this.height=this.width=0;this._dirties=[];this._glyphData=
[];this._currentPage=0;this._glyphIndex={};this._textures=[];this._rangePromises=new Map;this.width=a;this.height=d;this._glyphSource=c;this._binPack=new f(a-4,d-4);this._glyphData.push(new Uint8Array(a*d));this._dirties.push(!0);this._textures.push(void 0)}c.prototype.getGlyphItems=function(c,d){for(var b=this,e=[],m=this._glyphSource,k=new Set,w=1/256,t=0;t<d.length;t++)k.add(Math.floor(d[t]*w));var r=[];k.forEach(function(a){if(256>=a){var d=c+a;b._rangePromises.has(d)?r.push(b._rangePromises.get(d)):
(a=m.getRange(c,a).then(function(){b._rangePromises["delete"](d)},function(){b._rangePromises["delete"](d)}),b._rangePromises.set(d,a),r.push(a))}});return g.all(r).then(function(){var h,n=b._glyphIndex[c];n||(n={},b._glyphIndex[c]=n);for(var g=0;g<d.length;g++){h=d[g];var r=n[h];if(r)e[h]={sdf:!0,rect:r.rect,metrics:r.metrics,page:r.page};else{var q=m.getGlyph(c,h);if(q&&q.metrics){var r=q.metrics,l=void 0;if(0===r.width)l=new a.default(0,0,0,0);else{var y=r.width+6,A=r.height+6,v=y%4?4-y%4:4,D=
A%4?4-A%4:4;1===v&&(v=5);1===D&&(D=5);l=b._binPack.allocate(y+v,A+D);l.isEmpty&&(b._dirties[b._currentPage]||(b._glyphData[b._currentPage]=null),b._currentPage=b._glyphData.length,b._glyphData.push(new Uint8Array(b.width*b.height)),b._dirties.push(!0),b._textures.push(void 0),b._binPack=new f(b.width-4,b.height-4),l=b._binPack.allocate(y+v,A+D));var v=b._glyphData[b._currentPage],q=q.bitmap,x=D=void 0;if(q)for(var k=0;k<A;k++)for(var D=y*k,x=b.width*(l.y+k+1)+l.x,t=0;t<y;t++)v[x+t+1]=q[D+t]}n[h]=
{rect:l,metrics:r,tileIDs:null,page:b._currentPage};e[h]={sdf:!0,rect:l,metrics:r,page:b._currentPage};b._dirties[b._currentPage]=!0}}}return e})};c.prototype.removeGlyphs=function(a){for(var d in this._glyphIndex){var c=this._glyphIndex[d];if(c){var b=void 0,e;for(e in c)if(b=c[e],b.tileIDs["delete"](a),0===b.tileIDs.size){for(var f=this._glyphData[b.page],g=b.rect,m=void 0,r=void 0,k=0;k<g.height;k++)for(m=this.width*(g.y+k)+g.x,r=0;r<g.width;r++)f[m+r]=0;delete c[e];this._dirties[b.page]=!0}}}};
c.prototype.bind=function(a,d,c,f){void 0===f&&(f=0);this._textures[c]||(this._textures[c]=new b.Texture(a,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height)));var e=this._textures[c];e.setSamplingMode(d);this._dirties[c]&&e.setData(this._glyphData[c]);a.bindTexture(e,f);this._dirties[c]=!1};c.prototype.dispose=function(){this._binPack=null;for(var a=0,d=this._textures;a<d.length;a++){var c=d[a];c&&c.dispose()}this._textures.length=0};return c}()})},
"esri/views/2d/engine/vectorTiles/RectangleBinPack":function(){define(["require","exports","../webgl/Rect"],function(p,k,m){return function(){function g(b,f){this._height=this._width=0;this._free=[];this._width=b;this._height=f;this._free.push(new m.default(0,0,b,f))}Object.defineProperty(g.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0});Object.defineProperty(g.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0});g.prototype.allocate=
function(b,f){if(b>this._width||f>this._height)return new m.default;for(var a=null,c=-1,e=0;e<this._free.length;++e){var d=this._free[e];b<=d.width&&f<=d.height&&(null===a||d.y<=a.y&&d.x<=a.x)&&(a=d,c=e)}if(null===a)return new m.default;this._free.splice(c,1);a.width<a.height?(a.width>b&&this._free.push(new m.default(a.x+b,a.y,a.width-b,f)),a.height>f&&this._free.push(new m.default(a.x,a.y+f,a.width,a.height-f))):(a.width>b&&this._free.push(new m.default(a.x+b,a.y,a.width-b,a.height)),a.height>f&&
this._free.push(new m.default(a.x,a.y+f,b,a.height-f)));return new m.default(a.x,a.y,b,f)};g.prototype.release=function(b){for(var f=0;f<this._free.length;++f){var a=this._free[f];if(a.y===b.y&&a.height===b.height&&a.x+a.width===b.x)a.width+=b.width;else if(a.x===b.x&&a.width===b.width&&a.y+a.height===b.y)a.height+=b.height;else if(b.y===a.y&&b.height===a.height&&b.x+b.width===a.x)a.x=b.x,a.width+=b.width;else if(b.x===a.x&&b.width===a.width&&b.y+b.height===a.y)a.y=b.y,a.height+=b.height;else continue;
this._free.splice(f,1);this.release(b)}this._free.push(b)};return g}()})},"esri/views/2d/engine/vectorTiles/GlyphSource":function(){define("require exports ../../../../request ../../../../core/has ../../../../core/pbf ../../../../core/promiseUtils".split(" "),function(p,k,m,g,b,f){var a=function(){function a(a){this._metrics=[];this._bitmaps=[];if(a)for(;a.next();)switch(a.tag()){case 1:for(var d=a.getMessage();d.next();)switch(d.tag()){case 3:for(var c=d.getMessage(),b=void 0,e=void 0,f=void 0,g=
void 0,m=void 0,k=void 0,p=void 0;c.next();)switch(c.tag()){case 1:b=c.getUInt32();break;case 2:e=c.getBytes();break;case 3:f=c.getUInt32();break;case 4:g=c.getUInt32();break;case 5:m=c.getSInt32();break;case 6:k=c.getSInt32();break;case 7:p=c.getUInt32();break;default:c.skip()}c.release();b&&(this._metrics[b]={width:f,height:g,left:m,top:k,advance:p},this._bitmaps[b]=e);break;default:d.skip()}d.release();break;default:a.skip()}}a.prototype.getMetrics=function(a){return this._metrics[a]};a.prototype.getBitmap=
function(a){return this._bitmaps[a]};return a}(),c=function(){function a(){this._ranges=[]}a.prototype.getRange=function(a){return this._ranges[a]};a.prototype.addRange=function(a,c){this._ranges[a]=c};return a}();return function(){function e(a){this._glyphInfo={};this._baseURL=a}e.prototype.getRange=function(c,e){var d=this._getFontStack(c);if(d.getRange(e))return f.resolve();var h=256*e,g=h+255;c=this._baseURL.replace("{fontstack}",c).replace("{range}",h+"-"+g);return m(c,{responseType:"array-buffer"}).then(function(c){d.addRange(e,
new a(new b(new Uint8Array(c.data),new DataView(c.data))))}).catch(function(){d.addRange(e,new a)})};e.prototype.getGlyph=function(a,c){if(a=this._getFontStack(a)){var b=Math.floor(c/256);if(!(256<b)&&(a=a.getRange(b)))return{metrics:a.getMetrics(c),bitmap:a.getBitmap(c)}}};e.prototype._getFontStack=function(a){var b=this._glyphInfo[a];b||(b=this._glyphInfo[a]=new c);return b};return e}()})},"esri/views/2d/engine/vectorTiles/SpriteMosaic":function(){define(["require","exports","../../../webgl","./RectangleBinPack",
"../webgl/Rect"],function(p,k,m,g,b){return function(){function f(a,c,b){void 0===b&&(b=0);this._size=[];this._mosaicsData=[];this._textures=[];this._dirties=[];this._pageHeight=this._pageWidth=this._currentPage=this._maxItemSize=0;this._mosaicRects={};this.pixelRatio=1;(0>=a||0>=c)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!");this._pageWidth=a;this._pageHeight=c;0<b&&(this._maxItemSize=b);this._binPack=new g(a-4,c-4)}f.prototype.getWidth=function(a){return a>=
this._size.length?-1:this._size[a][0]};f.prototype.getHeight=function(a){return a>=this._size.length?-1:this._size[a][1]};f.prototype.setSpriteSource=function(a){this.dispose();this.pixelRatio=a.devicePixelRatio;if(0===this._mosaicsData.length){this._binPack=new g(this._pageWidth-4,this._pageHeight-4);var c=new Uint32Array(Math.floor(this._pageWidth)*Math.floor(this._pageHeight));this._mosaicsData[0]=c;this._dirties.push(!0);this._size.push([this._pageWidth,this._pageHeight]);this._textures.push(void 0)}this._sprites=
a};f.prototype.getSpriteItem=function(a,c){void 0===c&&(c=!1);var b=this._mosaicRects[a];if(b)return b;if(!this._sprites||"loaded"!==this._sprites.loadStatus)return null;b=this._sprites.getSpriteInfo(a);if(!b||!b.width||!b.height||0>b.width||0>b.height)return null;var d=b.width,f=b.height,n=this._allocateImage(d,f),g=n[0],m=n[1];if(0>=g.width)return null;this._copy(g,b,m,n[2],c);b={rect:g,width:d,height:f,sdf:b.sdf,simplePattern:!1,pixelRatio:b.pixelRatio,page:m};return this._mosaicRects[a]=b};f.prototype.preloadSpriteItems=
function(){for(var a=0,c=this._sprites.spriteNames;a<c.length;a++)this.getSpriteItem(c[a],!0)};f.prototype.getSpriteItems=function(a){for(var c={},b=0;b<a.length;b++){var d=a[b];c[d]=this.getSpriteItem(d)}return c};f.prototype.getMosaicItemPosition=function(a,b){b=(a=this.getSpriteItem(a,b))&&a.rect;if(!b)return null;b.width=a.width;b.height=a.height;return{size:[a.width,a.height],tl:[(b.x+2)/this._size[a.page][0],(b.y+2)/this._size[a.page][1]],br:[(b.x+2+a.width)/this._size[a.page][0],(b.y+2+a.height)/
this._size[a.page][1]],page:a.page}};f.prototype.bind=function(a,b,e,d){void 0===e&&(e=0);void 0===d&&(d=0);this._textures[e]||(this._textures[e]=new m.Texture(a,{pixelFormat:6408,dataType:5121,wrapMode:33071,width:this._size[e][0],height:this._size[e][1]},new Uint8Array(this._mosaicsData[e].buffer)));var c=this._textures[e];c.setSamplingMode(b);this._dirties[e]&&c.setData(new Uint8Array(this._mosaicsData[e].buffer));a.bindTexture(c,d);this._dirties[e]=!1};f._copyBits=function(a,b,e,d,f,n,g,m,k,t,
r){var c=d*b+e;g=m*n+g;if(r)for(g-=n,r=-1;r<=t;r++,c=((r+t)%t+d)*b+e,g+=n)for(m=-1;m<=k;m++)f[g+m]=a[c+(m+k)%k];else for(r=0;r<t;r++){for(m=0;m<k;m++)f[g+m]=a[c+m];c+=b;g+=n}};f.prototype._copy=function(a,b,e,d,g,n){if(this._sprites&&"loaded"===this._sprites.loadStatus&&!(e>=this._mosaicsData.length)){var c=new Uint32Array(n?n.buffer:this._sprites.image.buffer),h=this._mosaicsData[e];h&&c||console.error("Source or target images are uninitialized!");f._copyBits(c,n?b.width:this._sprites.width,b.x,
b.y,h,d[0],a.x+2,a.y+2,b.width,b.height,g);this._dirties[e]=!0}};f.prototype._allocateImage=function(a,c){a+=2;c+=2;var e=Math.max(a,c);if(this._maxItemSize&&this._maxItemSize<e)return e=new b.default(0,0,a,c),this._mosaicsData.push(new Uint32Array(a*c)),this._dirties.push(!0),this._size.push([a,c]),this._textures.push(void 0),[e,this._mosaicsData.length-1,[a,c]];var e=a%4?4-a%4:4,d=c%4?4-c%4:4;1===e&&(e=5);1===d&&(d=5);e=this._binPack.allocate(a+e,c+d);return 0>=e.width?(this._dirties[this._currentPage]||
(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new g(this._pageWidth-4,this._pageHeight-4),this._allocateImage(a,c)):[e,this._currentPage,[this._pageWidth,this._pageHeight]]};f.prototype.dispose=function(){this._binPack=null;this._mosaicRects={};for(var a=0,b=this._textures;a<
b.length;a++){var e=b[a];e&&e.dispose()}this._textures.length=0};return f}()})},"esri/views/2d/engine/vectorTiles/TileIndex":function(){define(["require","exports","../../../../core/promiseUtils","../../../../layers/support/TilemapCache","../../tiling/TileKey"],function(p,k,m,g,b){return function(){function f(a){if(a instanceof g.TilemapCache)this._tilemapCache=a;else if(a&&"index"in a)this._tilemap=a.index;else throw Error("Invalid tilemap!");}f.prototype.dataKey=function(a,c){if(this._tilemapCache){var e=
a.level,d=a.row,f=a.col,g=new b(a);return this._tilemapCache.fetchAvailabilityUpsample(e,d,f,g,c).then(function(){return g}).catch(function(a){if(m.isAbortError(a))throw a;g.level=e;g.row=d;g.col=f;return g})}return this._getIndexedDataKey(a)};f.prototype.forEach=function(a,b,e,d,f){this._callback=f;this._maxLevel=b+a;this._forEach(this._tilemap,b,e,d)};f.prototype._forEach=function(a,b,e,d){0!==a&&(this._callback(b,e,d),b!==this._maxLevel&&"object"===typeof a&&(this._forEach(a[0],b+1,2*e,2*d),this._forEach(a[1],
b+1,2*e,2*d+1),this._forEach(a[2],b+1,2*e+1,2*d),this._forEach(a[3],b+1,2*e+1,2*d+1)))};f.prototype._getIndexedDataKey=function(a){var c=[a];if(0>a.level||0>a.row||0>a.col||0<a.row>>a.level||0<a.col>>a.level)return m.resolve(null);for(;0!==a.level;)a=new b(a.level-1,a.row>>1,a.col>>1,a.world),c.push(a);a=this._tilemap;var e=c.pop(),d,f;if(1===a)return m.resolve(e);for(;c.length;)if(d=c.pop(),f=(d.col&1)+((d.row&1)<<1),a){if(0===a[f]){e=null;break}if(1===a[f]){e=d;break}e=d;a=a[f]}return m.resolve(e)};
return f}()})},"esri/layers/support/TilemapCache":function(){define("require exports ../../core/tsSupport/assignHelper ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/generatorHelper ../../core/tsSupport/awaiterHelper ../../request ../../core/Accessor ../../core/Error ../../core/Handles ../../core/Logger ../../core/LRUCache ../../core/PooledArray ../../core/promiseUtils ../../core/scheduling ../../core/urlUtils ../../core/watchUtils ../../core/accessorSupport/decorators ./Tilemap".split(" "),
function(p,k,m,g,b,f,a,c,e,d,h,n,x,C,w,t,r,E,B,z){Object.defineProperty(k,"__esModule",{value:!0});k.TILEMAP_SIZE_EXP=5;var u=n.getLogger("esri.layers.support.TilemapCache");p=function(e){function l(a){a=e.call(this,a)||this;a._handles=new h;a._pendingTilemapRequests={};a._availableLevels={};a.levels=5;a.cacheByteSize=2097152;a.request=c;a._prefetchingEnabled=!0;return a}g(l,e);q=l;l.prototype.initialize=function(){var a=this;this._tilemapCache=new x(this.cacheByteSize);this._handles.add([this.watch(["layer.parsedUrl",
"layer.tileServers?"],function(){return a._initializeTilemapDefinition()}),E.init(this,"layer.tileInfo.lods",function(b){return a._initializeAvailableLevels(b)},!0)]);this._initializeTilemapDefinition()};l.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null)};l.prototype.castLevels=function(a){return 2>=a?(u.error("Minimum levels for Tilemap is 3, but got ",a),3):a};Object.defineProperty(l.prototype,"size",{get:function(){return 1<<this.levels},enumerable:!0,configurable:!0});
l.prototype.fetchTilemap=function(a,b,c,e){var l=this;if(!this._availableLevels[a])return w.reject(new d("tilemap-cache:level-unavailable","Level "+a+" is unavailable in the service"));var f=this._tmpTilemapDefinition;if(a=this._tilemapFromCache(a,b,c,f))return w.resolve(a);var q=e&&e.signal;e=m({},e,{signal:null});return w.create(function(a,b){w.onAbort(q,function(){return b(w.createAbortError())});var c=z.tilemapDefinitionId(f),d=l._pendingTilemapRequests[c];if(!d){var d=z.Tilemap.fromDefinition(f,
e).then(function(a){l._tilemapCache.put(c,a,a.byteSize);return a}),g=function(){return delete l._pendingTilemapRequests[c]};l._pendingTilemapRequests[c]=d;d.then(g,g)}d.then(a,b)})};l.prototype.getAvailability=function(a,b,c){return this._availableLevels[a]?(a=this._tilemapFromCache(a,b,c,this._tmpTilemapDefinition))?a.getAvailability(b,c):"unknown":"unavailable"};l.prototype.getAvailabilityUpsample=function(a,b,c,d){d.level=a;d.row=b;d.col=c;a=this.layer.tileInfo;for(a.updateTileInfo(d);;)if(b=this.getAvailability(d.level,
d.row,d.col),"unavailable"===b){if(!a.upsampleTile(d))return"unavailable"}else return b};l.prototype.fetchAvailability=function(a,b,c,e){return this._availableLevels[a]?this.fetchTilemap(a,b,c,e).catch(function(a){return a}).then(function(e){if(e instanceof z.Tilemap)return e=e.getAvailability(b,c),"unavailable"===e?w.reject(new d("tile-map:tile-unavailable","Tile is not available",{level:a,row:b,col:c})):e;if(w.isAbortError(e))throw e;return"unknown"}):w.reject(new d("tilemap-cache:level-unavailable",
"Level "+a+" is unavailable in the service"))};l.prototype.fetchAvailabilityUpsample=function(a,b,c,d,e){var l=this;d.level=a;d.row=b;d.col=c;var f=this.layer.tileInfo;f.updateTileInfo(d);var g=this.fetchAvailability(a,b,c,e).catch(function(a){if(w.isAbortError(a))throw a;if(f.upsampleTile(d))return l.fetchAvailabilityUpsample(d.level,d.row,d.col,d);throw a;});this._fetchAvailabilityUpsamplePrefetch(d.id,a,b,c,e,g);return g};l.prototype._fetchAvailabilityUpsamplePrefetch=function(b,c,d,e,l,g){return a(this,
void 0,void 0,function(){var a,h,n,v,y,A,k,r,D,u;return f(this,function(f){switch(f.label){case 0:if(!this._prefetchingEnabled)return[2];a="prefetch-"+b;if(this._handles.has(a))return[2];h=w.createAbortController();g.then(function(){return h.abort()},function(){return h.abort()});n=!1;v={remove:function(){n||(n=!0,h.abort())}};this._handles.add(v,a);f.label=1;case 1:return f.trys.push([1,3,,4]),[4,t.waitTicks(10,h.signal)];case 2:return f.sent(),[3,4];case 3:return f.sent(),[3,4];case 4:n||(n=!0,
this._handles.remove(a));if(w.isAborted(h))return[2];y={id:b,level:c,row:d,col:e};A=m({},l,{signal:h.signal});k=this.layer.tileInfo;r=function(a){var b=D.fetchAvailability(y.level,y.row,y.col,A);q._prefetches.push(b);a=function(){q._prefetches.removeUnordered(b)};b.then(a,a)};D=this;for(u=0;q._prefetches.length<q._maxPrefetch&&k.upsampleTile(y);++u)r(u);return[2]}})})};l.prototype._initializeTilemapDefinition=function(){if(this.layer.parsedUrl){var a=this.layer.parsedUrl,b=a.query;this._tilemapCache.clear();
this._tmpTilemapDefinition={service:{url:a.path,query:b?r.objectToQuery(b):null,tileServers:this.layer.tileServers,request:this.request,type:this.layer.type},width:this.size,height:this.size,level:0,row:0,col:0}}};l.prototype._tilemapFromCache=function(a,b,c,d){a=this._getTilemapDefinition(a,b,c,d);a=z.tilemapDefinitionId(a);return this._tilemapCache.get(a)};l.prototype._getTilemapDefinition=function(a,b,c,d){d.level=a;a=a>k.TILEMAP_SIZE_EXP;d.row=a?b-b%this.size:b;d.col=a?c-c%this.size:c;return d};
l.prototype._initializeAvailableLevels=function(a){var b=this;this._availableLevels={};a&&a.forEach(function(a){return b._availableLevels[a.level]=!0})};Object.defineProperty(l.prototype,"test",{get:function(){var a=this;return{get prefetchingEnabled(){return a._prefetchingEnabled},set prefetchingEnabled(b){a._prefetchingEnabled=b},hasTilemap:function(b,c,d){return!!a._tilemapFromCache(b,c,d,a._tmpTilemapDefinition)}}},enumerable:!0,configurable:!0});var q;l._maxPrefetch=4;l._prefetches=new C({initialSize:q._maxPrefetch});
b([B.property({constructOnly:!0,type:Number})],l.prototype,"levels",void 0);b([B.cast("levels")],l.prototype,"castLevels",null);b([B.property({readOnly:!0,dependsOn:["levels"],type:Number})],l.prototype,"size",null);b([B.property({constructOnly:!0,type:Number})],l.prototype,"cacheByteSize",void 0);b([B.property({constructOnly:!0})],l.prototype,"layer",void 0);b([B.property({constructOnly:!0})],l.prototype,"request",void 0);return l=q=b([B.subclass("esri.layers.support.TilemapCache")],l)}(B.declared(e));
k.TilemapCache=p})},"esri/layers/support/Tilemap":function(){define("require exports ../../core/tsSupport/assignHelper ../../request ../../core/arrayUtils ../../core/Error ../../core/lang".split(" "),function(p,k,m,g,b,f,a){function c(a){var b;"vector-tile"===a.service.type?b=a.service.url+"/tilemap/"+a.level+"/"+a.row+"/"+a.col+"/"+a.width+"/"+a.height:(b=a.service.tileServers,b=(b&&b.length?b[a.row%b.length]:a.service.url)+"/tilemap/"+a.level+"/"+a.row+"/"+a.col+"/"+a.width+"/"+a.height);(a=a.service.query)&&
(b=b+"?"+a);return b}Object.defineProperty(k,"__esModule",{value:!0});p=function(){function e(){this.location={left:0,top:0,width:0,height:0};this._allAvailability="unknown";this.byteSize=40}e.prototype.getAvailability=function(a,b){if("unknown"!==this._allAvailability)return this._allAvailability;a=(a-this.location.top)*this.location.width+(b-this.location.left);b=a>>3;var c=this._tileAvailabilityBitSet;return 0>b||b>c.length?"unknown":c[b]&1<<a%8?"available":"unavailable"};e.prototype._updateFromData=
function(a){for(var b=!0,c=!0,d=new Uint8Array(Math.ceil(this.location.width*this.location.height/8)),e=0,f=0;f<a.length;f++){var g=f%8;a[f]?(c=!1,d[e]|=1<<g):b=!1;7===g&&++e}c?this._allAvailability="unavailable":b?this._allAvailability="available":(this._allAvailability="unknown",this._tileAvailabilityBitSet=d,this.byteSize+=d.length)};e.fromDefinition=function(a,h){var d=a.service.request||g,k=a.row,p=a.col,w=a.width,t=a.height,r={query:{f:"json"}};h=h?m({},r,h):r;return d(c(a),h).then(function(a){return a.data}).catch(function(a){if(a&&
a.details&&422===a.details.httpStatus)return{location:{top:k,left:p,width:w,height:t},valid:!0,data:b.constant(w*t,0)};throw a;}).then(function(a){if(a.location&&(a.location.top!==k||a.location.left!==p||a.location.width!==w||a.location.height!==t))throw new f("tilemap:location-mismatch","Tilemap response for different location than requested",{response:a,definition:{top:k,left:p,width:w,height:t}});return e.fromJSON(a)})};e.fromJSON=function(b){e.validateJSON(b);var c=new e;c.location=Object.freeze(a.clone(b.location));
c._updateFromData(b.data);return Object.freeze(c)};e.validateJSON=function(a){if(!a||!a.location)throw new f("tilemap:missing-location","Location missing from tilemap response");if(!1===a.valid)throw new f("tilemap:invalid","Tilemap response was marked as invalid");if(!a.data)throw new f("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(a.data))throw new f("tilemap:data-mismatch","Data must be an array of numbers");if(a.data.length!==a.location.width*a.location.height)throw new f("tilemap:data-mismatch",
"Number of data items does not match width/height of tilemap");};return e}();k.Tilemap=p;k.tilemapDefinitionId=function(a){return a.level+"/"+a.row+"/"+a.col+"/"+a.width+"/"+a.height};k.tilemapDefinitionUrl=c;k.default=p})},"esri/views/2d/engine/vectorTiles/VectorTileContainer":function(){define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/iteratorUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../geometry/support/aaBoundingRect ../../../webgl ../../engine ../vectorTiles/VectorTile ./FadeRecorder ../webgl/definitions ../webgl/enums ../webgl/TiledDisplayObject ../../tiling/TileCoverage ../../tiling/TileKey".split(" "),
function(p,k,m,g,b,f,a,c,e,d,h,n,x,C,w,t,r,E,B){Object.defineProperty(k,"__esModule",{value:!0});p=function(n){function h(a,b){a=n.call(this,a,b)||this;a._backgroundTiles=[];a._fadeRecorder=new C.FadeRecorder(400);a._pointToCallbacks=new Map;a._parsedDataQueue=new Map;return a}m(h,n);h.prototype.destroy=function(){this.removeAllChildren();this.children.forEach(function(a){return a.destroy()})};h.prototype.dispose=function(){this._spriteMosaic&&this._spriteMosaic.dispose();this._glyphMosaic&&this._glyphMosaic.dispose();
n.prototype.dispose.call(this)};h.prototype.setStyleResources=function(a,b,c){this._spriteMosaic=a;this._glyphMosaic=b;this._styleRepository=c};h.prototype.hitTest=function(a,c){return f(this,void 0,void 0,function(){var d,l;return b(this,function(b){d=[a,c];l=e.createResolver();this._pointToCallbacks.set(d,l);this.requestRender();return[2,l.promise]})})};h.prototype.setTileData=function(a,b){var c=this.stage;c.dataUploadCounter<w.MAX_GPU_UPLOADS_PER_FRAME&&b?(a.setData(b.tileData,b.client,b.refKeys),
c.dataUploadCounter++):b?this._parsedDataQueue.set(a,b):a.setData(null,null)};h.prototype.createRenderParams=function(a){return g({},n.prototype.createRenderParams.call(this,a),{renderPass:null,styleLayer:null,styleLayerId:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,fadeRecorder:this._fadeRecorder,hasClipping:!!this._clippingInfos})};h.prototype.doRender=function(a){!this.visible||a.drawPhase!==t.WGLDrawPhase.MAP&&a.drawPhase!==t.WGLDrawPhase.DEBUG||void 0===this._spriteMosaic||
n.prototype.doRender.call(this,a)};h.prototype.createTile=function(a){var b=this._tileInfoView.getTileBounds(d.create(),a);a=new x.VectorTile(a,this._styleRepository,b,[512,512]);a.rotation=this.stage.state.rotation;return a};h.prototype.destroyTile=function(a){a.destroy()};h.prototype.removeChild=function(a){this._parsedDataQueue.has(a)&&this._parsedDataQueue.delete(a);return n.prototype.removeChild.call(this,a)};h.prototype.renderChildren=function(b){if(b.drawPhase===t.WGLDrawPhase.DEBUG)n.prototype.renderChildren.call(this,
b);else{var c=this.stage;if(0<this._parsedDataQueue.size&&c.dataUploadCounter<w.MAX_GPU_UPLOADS_PER_FRAME)for(var d=a.pairsOfMap(this._parsedDataQueue),e=0;e<d.length&&c.dataUploadCounter<w.MAX_GPU_UPLOADS_PER_FRAME;e++){var f=d[e][0],g=d[e][1];f.setData(g.tileData,g.client,g.refKeys);this._parsedDataQueue.delete(f);c.dataUploadCounter++}this._fadeRecorder.recordLevel(b.displayLevel);this._doRender(b);(0<this._parsedDataQueue.size||this._fadeRecorder.needsRedraw())&&this.requestRender();0<this._pointToCallbacks.size&&
(c=b.context,d=c.getBoundFramebufferObject(),b.drawPhase=t.WGLDrawPhase.HITTEST,e=b.painter.effects.hittest,e.bind(b),this._doRender(b),e.draw(b,this._pointToCallbacks,6),c.bindFramebuffer(d))}};h.prototype.removeAllChildren=function(){this._parsedDataQueue.clear();for(var a=0;a<this.children.length;a++)this.children[a].dispose();n.prototype.removeAllChildren.call(this)};h.prototype._doRender=function(a){var b=a.context,c=this._styleRepository,d=c.layers;0<c.backgroundBucketIds.length&&(a.renderPass=
"background",this._renderBackgroundLayers(a,c.backgroundBucketIds));n.prototype.renderChildren.call(this,a);for(var c=this.children.filter(function(a){return a.visible}),e=0;e<c.length;e++){var f=c[e];f.triangleCount=0;f.commitChanges()}b.setStencilWriteMask(0);b.setColorMask(!0,!0,!0,!0);b.setStencilOp(7680,7680,7681);b.setStencilTestEnabled(!0);b.setBlendingEnabled(!1);b.setDepthTestEnabled(!0);b.setDepthWriteEnabled(!0);b.setDepthFunction(515);b.setClearDepth(1);b.clear(b.gl.DEPTH_BUFFER_BIT);
a.renderPass="opaque";for(e=d.length-1;0<=e;e--)this._renderStyleLayer(e,a,c);b.setDepthWriteEnabled(!1);b.setBlendingEnabled(!0);b.setBlendFunctionSeparate(1,771,1,771);a.renderPass="translucent";for(e=0;e<d.length;e++)this._renderStyleLayer(e,a,c);b.setDepthTestEnabled(!1);a.renderPass="symbol";for(e=0;e<d.length;e++)this._renderStyleLayer(e,a,c);b.bindVAO();b.setStencilTestEnabled(!0)};h.prototype._renderStyleLayer=function(a,b,c){var d=b.painter,e=b.renderPass,f=this._styleRepository.layers[a];
if(void 0!==f){var l;switch(f.type){case 0:return;case 1:if("opaque"!==e&&"translucent"!==b.renderPass)return;l="vtlFill";break;case 2:if("translucent"!==e)return;l="vtlLine";break;case 4:if("symbol"!==e)return;l="vtlCircle";break;case 3:if("symbol"!==e)return;l="vtlSymbol"}e=b.displayLevel;if(!(0===c.length||void 0!==f.minzoom&&f.minzoom>=e+1E-6||void 0!==f.maxzoom&&f.maxzoom<e-1E-6))for(b.styleLayerId=a,b.styleLayer=f,f=0;f<c.length;f++)if(c[f].layerData[a]){d.renderObjects(b,c,l);break}}};h.prototype._renderBackgroundLayers=
function(a,b){var e=this._tileInfoView.getTileCoverage(a.state,0,"smallest"),f=e.spans,l=e.lodInfo,g=l.level,h=this._styleRepository,n=a.context,m=a.displayLevel,k=a.painter,q=a.state,t=d.create(),p=[];if(this._renderPasses){var u=this._renderPasses[0];c.isSome(this._clippingInfos)&&(u.brushes[0].prepareState(a,this._clippingInfos[0]),u.brushes[0].drawMany(a,this._clippingInfos))}for(var u=this._backgroundTiles,w=0,x,C=0;C<f.length;C++)for(var z=f[C],F=z.row,G=z.colTo,z=z.colFrom;z<=G;z++)w<u.length?
(x=u[w],x.key.set(g,F,l.normalizeCol(z),l.getWorldForColumn(z)),this._tileInfoView.getTileBounds(t,x.key,!1),x.bounds=t,x.coords[0]=t[0],x.coords[1]=t[3]):(x=new B(g,F,l.normalizeCol(z),l.getWorldForColumn(z)),x=new r.TiledDisplayObject(x,this._tileInfoView.getTileBounds(d.create(),x),[512,512],[4096,4096]),u.push(x)),x.setTransform(q,this._tileInfoView.getTileResolution(x.key)),p.push(x),w++;n.setStencilWriteMask(0);n.setColorMask(!0,!0,!0,!0);n.setStencilOp(7680,7680,7681);n.setStencilFunction(514,
0,255);n.setStencilTestEnabled(!0);for(f=0;f<b.length;f++)l=b[f],g=h.layers[l],!g||void 0!==g.minzoom&&g.minzoom>=m+1E-6||void 0!==g.maxzoom&&g.maxzoom<m-1E-6||(a.styleLayerId=l,a.styleLayer=g,k.renderObjects(a,p,"vtlBackground"));E.pool.release(e)};return h}(n.TileContainer);k.VectorTileContainer=p})},"esri/views/2d/engine/vectorTiles/FadeRecorder":function(){define(["require","exports","../../../../core/now"],function(p,k,m){Object.defineProperty(k,"__esModule",{value:!0});(function(){return function(g,
b){this.level=g;this.now=b}})();p=function(){return function(g,b,f,a){this.fadeSpeed=g;this.minfadeLevel=b;this.maxfadeLevel=f;this.fadeChange=a}}();k.FadeProperties=p;p=function(){function g(b,f){void 0===b&&(b=300);void 0===f&&(f=!1);this._levelSnapshots=[];this._duration=b;this._ignoreSpeed=f}g.prototype.recordLevel=function(b){var f=m(),a=this._levelSnapshots;0===a.length&&(a.push({level:b,now:0}),a.push({level:b,now:0}));2!==a.length&&a[0].level===b||a.push({level:b,now:f})};g.prototype.needsRedraw=
function(){if(0===this._levelSnapshots.length)return!1;for(var b=this._duration,f=this._levelSnapshots,a=f.length,c=f[a-1],e=-1;a>e+1&&f[e+1].now+b<c.now;)e++;for(0>e&&(e=0);e<a;e++)if(f[e].level!==c.level)return!0;return!1};g.prototype.getFadeValues=function(){for(var b=this._duration,f=m(),a=this._levelSnapshots;3<a.length&&a[1].now+b<f;)a.shift();a[1].now+b<f&&(a[0].level=a[1].level);var c=a[0].level,e=a[a.length-1],d=e.level,g=Math.min(c,d),c=Math.max(c,d),a=(e.level-a[1].level)/((e.now-a[1].now)/
b);return this._ignoreSpeed?{fadeSpeed:0,minfadeLevel:g,maxfadeLevel:c,fadeChange:0}:{fadeSpeed:a,minfadeLevel:g,maxfadeLevel:c,fadeChange:(f-e.now)/b*a}};return g}();k.FadeRecorder=p})},"esri/views/2d/layers/LayerView2D":function(){define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/Collection ../../../core/collectionUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../layers/support/ClipArea ../../layers/support/ClipRect ../../layers/support/Geometry ../../layers/support/Path".split(" "),
function(p,k,m,g,b,f,a,c,e,d,h,n){Object.defineProperty(k,"__esModule",{value:!0});var x=b.ofType({key:"type",base:e,typeMap:{rect:d,path:n,geometry:h}});k.LayerView2D=function(b){return function(b){function d(){var a=null!==b&&b.apply(this,arguments)||this;a.clips=new x;a.moving=!1;a.attached=!1;a.lastUpdateId=-1;a.updateRequested=!1;return a}m(d,b);d.prototype.initialize=function(){var b=this;this.when(function(){b.requestUpdate()},function(){});var c=function(){return b.notifyChange("rendering")};
this.handles.add([a.init(this,"suspended",function(a){b.container&&(b.container.visible=!a);b.view&&!a&&b.updateRequested&&b.view.requestLayerViewUpdate(b)},!0),a.init(this,["fullOpacity","container"],function(){b.container&&(b.container.opacity=b.fullOpacity)},!0),a.on(this,"container","post-render",c),a.on(this,"container","will-render",c)])};d.prototype.destroy=function(){this.attached&&(this.attached=!1,this.detach());this.handles.remove("initialize");this.updateRequested=!1;this.view=this.layer=
null};Object.defineProperty(d.prototype,"rendering",{get:function(){return this.attached&&!this.suspended&&(this.moving||this.container.renderRequested||this.isRendering())},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"updating",{get:function(){return!this.suspended&&(!this.attached||this.updateRequested||this.isUpdating())},enumerable:!0,configurable:!0});d.prototype.isVisibleAtScale=function(a){var b=!0,c=this.layer,d=c.minScale,c=c.maxScale;if(null!=d&&null!=c){var b=!d,e=
!c;!b&&a<=d&&(b=!0);!e&&a>=c&&(e=!0);b=b&&e}return b};d.prototype.requestUpdate=function(){this.updateRequested||(this.updateRequested=!0,this.suspended||this.view.requestLayerViewUpdate(this))};d.prototype.processUpdate=function(a){this.isFulfilled()&&!this.isResolved()?this.updateRequested=!1:(this._set("updateParameters",a),this.updateRequested&&!this.suspended&&(this.updateRequested=!1,this.update(a)))};d.prototype.isUpdating=function(){return!1};d.prototype.isRendering=function(){return!1};d.prototype.canResume=
function(){var a=this.inherited(arguments);a&&(a=this.isVisibleAtScale(this.view.scale));return a};g([c.property({type:x,set:function(a){a=f.referenceSetter(a,this._get("clips"),x);this._set("clips",a)}})],d.prototype,"clips",void 0);g([c.property()],d.prototype,"moving",void 0);g([c.property({dependsOn:["attached","suspended","moving"]})],d.prototype,"rendering",null);g([c.property()],d.prototype,"attached",void 0);g([c.property()],d.prototype,"container",void 0);g([c.property({dependsOn:["view.scale",
"layer.minScale","layer.maxScale"]})],d.prototype,"suspended",void 0);g([c.property({readOnly:!0})],d.prototype,"updateParameters",void 0);g([c.property()],d.prototype,"updateRequested",void 0);g([c.property({dependsOn:["updateRequested","attached","suspended"]})],d.prototype,"updating",null);g([c.property()],d.prototype,"view",void 0);return d=g([c.subclass("esri.views.2d.layers.LayerView2D")],d)}(c.declared(b))}})},"esri/views/layers/support/ClipArea":function(){define("require exports ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/declareExtendsHelper ../../../core/JSONSupport ../../../core/accessorSupport/decorators".split(" "),
function(p,k,m,g,b,f){return function(a){function b(){return null!==a&&a.apply(this,arguments)||this}g(b,a);return b=m([f.subclass("esri.views.layers.support.ClipArea")],b)}(f.declared(b.JSONSupport))})},"esri/views/layers/support/ClipRect":function(){define("require exports ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/declareExtendsHelper ../../../core/accessorSupport/decorators ./ClipArea".split(" "),function(p,k,m,g,b,f){return function(a){function c(){var b=null!==a&&a.apply(this,
arguments)||this;b.type="rect";b.left=null;b.right=null;b.top=null;b.bottom=null;return b}g(c,a);e=c;c.prototype.clone=function(){return new e({left:this.left,right:this.right,top:this.top,bottom:this.bottom})};Object.defineProperty(c.prototype,"version",{get:function(){return(this._get("version")||0)+1},enumerable:!0,configurable:!0});var e;m([b.property({type:[Number,String],json:{write:!0}})],c.prototype,"left",void 0);m([b.property({type:[Number,String],json:{write:!0}})],c.prototype,"right",
void 0);m([b.property({type:[Number,String],json:{write:!0}})],c.prototype,"top",void 0);m([b.property({type:[Number,String],json:{write:!0}})],c.prototype,"bottom",void 0);m([b.property({readOnly:!0,dependsOn:["left","right","top","bottom"]})],c.prototype,"version",null);return c=e=m([b.subclass("esri.views.layers.support.ClipRect")],c)}(b.declared(f))})},"esri/views/layers/support/Geometry":function(){define("require exports ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/declareExtendsHelper ../../../geometry ../../../core/accessorSupport/decorators ../../../geometry/Geometry ../../../geometry/support/jsonUtils ./ClipArea".split(" "),
function(p,k,m,g,b,f,a,c,e){var d={base:a,key:"type",typeMap:{extent:b.Extent,polygon:b.Polygon}};return function(a){function b(){var b=null!==a&&a.apply(this,arguments)||this;b.type="geometry";b.geometry=null;return b}g(b,a);e=b;Object.defineProperty(b.prototype,"version",{get:function(){return(this._get("version")||0)+1},enumerable:!0,configurable:!0});b.prototype.clone=function(){return new e({geometry:this.geometry.clone()})};var e;m([f.property({types:d,json:{read:c.fromJSON,write:!0}})],b.prototype,
"geometry",void 0);m([f.property({readOnly:!0,dependsOn:["geometry"]})],b.prototype,"version",null);return b=e=m([f.subclass("esri.views.layers.support.Geometry")],b)}(f.declared(e))})},"esri/views/layers/support/Path":function(){define("require exports ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/declareExtendsHelper ../../../core/accessorSupport/decorators ./ClipArea".split(" "),function(p,k,m,g,b,f){return function(a){function c(){var b=null!==a&&a.apply(this,arguments)||this;
b.type="path";b.path=[];return b}g(c,a);Object.defineProperty(c.prototype,"version",{get:function(){return(this._get("version")||0)+1},enumerable:!0,configurable:!0});m([b.property({type:[[[Number]]],json:{write:!0}})],c.prototype,"path",void 0);m([b.property({readOnly:!0,dependsOn:["path"]})],c.prototype,"version",null);return c=m([b.subclass("esri.views.layers.support.Path")],c)}(b.declared(f))})},"esri/views/2d/tiling/TileInfoViewPOT":function(){define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/decorateHelper ../../../layers/support/TileInfo ./TileInfoView ./TileKey".split(" "),
function(p,k,m,g,b,f,a){return function(c){function e(){var a=null!==c&&c.apply(this,arguments)||this;a._fullCacheLodInfos=null;a._levelByScale={};return a}m(e,c);e.prototype.getTileParentId=function(b){b=a.pool.acquire(b);var c=0===b.level?null:a.getId(b.level-1,b.row>>1,b.col>>1,b.world);a.pool.release(b);return c};e.prototype.getTileCoverage=function(a,b,e){a=c.prototype.getTileCoverage.call(this,a,b,e);if(!a)return a;var d=1<<a.lodInfo.level;a.spans=a.spans.filter(function(a){return 0<=a.row&&
a.row<d});return a};e.prototype.scaleToLevel=function(a){this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos);if(this._levelByScale[a])return this._levelByScale[a];var b=this._fullCacheLodInfos;if(a>b[0].scale)return b[0].level;for(var c=void 0,d=void 0,c=0;c<b.length-1;c++)if(d=b[c+1],a>d.scale)return c=b[c],c.level+(c.scale-a)/(c.scale-d.scale);return b[b.length-1].level};e.prototype._initializeFullCacheLODs=function(a){a=0===a[0].level?a.map(function(a){return{level:a.level,resolution:a.resolution,
scale:a.scale}}):b.create({size:this.tileInfo.size[0],spatialReference:this.tileInfo.spatialReference}).lods.map(function(a){return{level:a.level,resolution:a.resolution,scale:a.scale}});for(var c=0;c<a.length;c++)this._levelByScale[a[c].scale]=a[c].level;this._fullCacheLodInfos=a};return e}(f)})},"*noref":1}});
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../Graphic ../../../core/Error ../../../core/Handles ../../../core/Logger ../../../core/promiseUtils ../../../core/accessorSupport/decorators ../engine/vectorTiles/TileHandler ../engine/vectorTiles/VectorTileContainer ./LayerView2D ../tiling/TileInfoViewPOT ../tiling/TileQueue ../tiling/TileStrategy ../../layers/LayerView".split(" "),function(p,
k,m,g,b,f,a,c,e,d,h,n,x,C,w,t,r,E,B){var z=d.getLogger("esri.views.2d.layers.VectorTileLayerView2D");return function(d){function k(){var a=null!==d&&d.apply(this,arguments)||this;a._handles=new e;a._fetchQueue=null;a._parseQueue=null;a._isTileHandlerPromiseFulfilled=!1;a._invalidateStyle=!1;return a}m(k,d);k.prototype.initialize=function(){var a=this,b=this.layer.tileInfo;(b&&b.spatialReference).equals(this.view.spatialReference)?(this._tileInfoView=new t(this.layer.tileInfo,this.layer.fullExtent),
this.container=new C.VectorTileContainer(this._tileInfoView,this.clips),this._tileHandler=new x.TileHandler(this.layer,window.devicePixelRatio||1,!0,this.container,null),this.handles.add([this.watch("layer.currentStyleInfo",function(){return a._start()}),this.clips.on("change",function(){return a.container.setClips(a.clips)})])):this.addResolvingPromise(h.reject(new c("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer})))};
k.prototype.destroy=function(){this._stop();this.container.dispose();this._tileHandler&&(this._tileHandler.destroy(),this._tileHandler=null)};k.prototype.hitTest=function(c,d){return f(this,void 0,void 0,function(){var e,f,g,l,h;return b(this,function(b){switch(b.label){case 0:return this.suspended||!this._tileHandlerPromise?[2,null]:[4,this._tileHandlerPromise];case 1:return b.sent(),[4,this.container.hitTest(c,d)];case 2:e=b.sent();if(!e||0===e.length)return[2,null];f=e[0];g=this._tileHandler.getStyleRepository().layers;
if(f>=g.length)return[2,null];l=g[f];h=new a({attributes:{layerId:f,layerName:l.id}});h.layer=this.layer;h.sourceLayer=this.layer;return[2,h]}})})};k.prototype.update=function(a){var b=this;this.notifyChange("updating");var c=this._tileHandlerPromise;c&&c.then(function(){if(a.pixelRatio!==b._tileHandler.devicePixelRatio)b._start(),b._tileHandler.devicePixelRatio=a.pixelRatio;else{b._invalidateStyle?(b._issueStyleInvalidation(),b._invalidateStyle=!1):(b._fetchQueue.pause(),b._parseQueue.pause(),b._fetchQueue.state=
a.state,b._parseQueue.state=a.state,b._tileStrategy.update(a),b._parseQueue.resume(),b._fetchQueue.resume());for(var c=0,d=b.container.children;c<d.length;c++)b._tileHandler.updateTile(d[c],a)}})};k.prototype.attach=function(){var a=this;this._start();this._handles.add(this.layer.on("paint-change",function(){return a.container.requestRender()}));this._handles.add(this.layer.on("layout-change",function(){a._invalidateStyle=!0;a.requestUpdate()}))};k.prototype.detach=function(){this._stop();this._handles.removeAll()};
k.prototype.moveStart=function(){this.requestUpdate()};k.prototype.viewChange=function(){this.requestUpdate()};k.prototype.moveEnd=function(){this.requestUpdate()};k.prototype.canResume=function(){var a=this.inherited(arguments),b=this.layer;if(a&&b.currentStyleInfo){var c=this.view.scale;(b=b.currentStyleInfo)&&b.layerDefinition&&(b=b.layerDefinition,b.minScale&&b.minScale<c&&(a=!1),b.maxScale&&b.maxScale>c&&(a=!1))}return a};k.prototype.isUpdating=function(){return!this._isTileHandlerPromiseFulfilled||
this._fetchQueue.updating||this._parseQueue.updating};k.prototype.acquireTile=function(a){var b=this,c=this.container.createTile(a);this._tileHandlerPromise.then(function(){b.notifyChange("updating");b._fetchQueue.push(c.key).then(function(a){return b._parseQueue.push(a)}).then(function(a){c.once("attach",function(){return b.requestUpdate()});b.container.setTileData(c,a);b.container.addChild(c);b.notifyChange("updating")}).catch(function(a){b.notifyChange("updating");h.isAbortError(a)||z.error(a);
c.destroy()})});return c};k.prototype.releaseTile=function(a){var b=a.key.id;this._fetchQueue.abort(b);this._parseQueue.abort(b);this._tileHandler.abortTileUpdate(b);this.container.removeChild(a);this.requestUpdate();this.notifyChange("updating")};k.prototype._start=function(){var a=this;this._stop();if(this.layer.currentStyleInfo&&this.attached){var b=new AbortController,c=this._tileHandler.start({signal:b.signal}).then(function(){a._tileStrategy=new E({cachePolicy:"keep",coveragePolicy:"smallest",
acquireTile:function(b){return a.acquireTile(b)},releaseTile:function(b){return a.releaseTile(b)},tileInfoView:a._tileInfoView,cacheSize:40,buffer:0});a._fetchQueue=new r({tileInfoView:a._tileInfoView,process:function(b,c){return a._getTileData(b,c)},concurrency:15});a._parseQueue=new r({tileInfoView:a._tileInfoView,process:function(b,c){return a._parseTileData(b,c)},concurrency:8});a.requestUpdate();a._isTileHandlerPromiseFulfilled=!0});this._tileHandler.spriteMosaic.then(function(b){a.container.setStyleResources(b,
a._tileHandler.glyphMosaic,a.layer.styleRepository);a.requestUpdate()});this._tileHandlerAbortController=b;this._tileHandlerPromise=c}};k.prototype._stop=function(){if(this._tileHandlerAbortController){var a=this._tileHandlerAbortController;a&&a.abort();this._tileHandlerPromise=null;this._isTileHandlerPromiseFulfilled=!1;this._fetchQueue&&(this._fetchQueue.destroy(),this._fetchQueue=null);this._parseQueue&&(this._parseQueue.destroy(),this._parseQueue=null);this._tileStrategy&&(this._tileStrategy.destroy(),
this._tileStrategy=null);this.container.removeAllChildren()}};k.prototype._getTileData=function(a,c){return f(this,void 0,void 0,function(){var d;return b(this,function(b){switch(b.label){case 0:return[4,this._tileHandler.fetchTileData(a,c)];case 1:return d=b.sent(),this.notifyChange("updating"),[2,{key:a,data:d}]}})})};k.prototype._parseTileData=function(a,c){return f(this,void 0,void 0,function(){return b(this,function(b){return[2,this._tileHandler.parseTileData(a,this.updateParameters.state.rotation,
c)]})})};k.prototype._issueStyleInvalidation=function(){var a=this;this.notifyChange("updating");this._tileHandlerPromise=this._tileHandler.updateStyle().then(function(){a._tileHandler.spriteMosaic.then(function(b){return a.container.setStyleResources(b,a._tileHandler.glyphMosaic,a.layer.styleRepository)});a._fetchQueue.pause();a._parseQueue.pause();a._fetchQueue.clear();a._parseQueue.clear();a._parseQueue.resume();a._fetchQueue.resume();a.notifyChange("updating");a.requestUpdate()})};g([n.property({dependsOn:["view.scale",
"layer.currentStyleInfo"]})],k.prototype,"suspended",void 0);return k=g([n.subclass("esri.views.2d.layers.VectorTileLayerView2D")],k)}(n.declared(w.LayerView2D(B)))});