// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/extendsHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/Logger ../../../../../core/promiseUtils ../../../../../support/arcadeOnDemand ../../../../../symbols/support/cimSymbolUtils ../../../arcade/utils".split(" "),function(h,q,C,x,g,l,I,D,u,E){Object.defineProperty(q,"__esModule",{value:!0});var F=l.getLogger("esri/views/2d/engine/webgl/util/Matcher");h=function(){function e(){this._defaultResult=
null}e.fromBasicRenderer=function(b,a,k){return g(this,void 0,void 0,function(){var c,d,A;return x(this,function(f){switch(f.label){case 0:return[4,u.expandSymbols(b.getSymbols())];case 1:return c=f.sent(),d=new e,c.length?[4,a.createTemplateGroup(c[0],null,b,k)]:[3,3];case 2:A=f.sent(),d.setDefault(A),f.label=3;case 3:return[2,d]}})})};e.prototype.size=function(){return 1};e.prototype.getDefault=function(){return this._defaultResult};e.prototype.setDefault=function(b){this._defaultResult=b};e.prototype.match=
function(b,a,k,c,d){return this.getDefault()};e.prototype.analyze=function(b,a,k,c){return g(this,void 0,void 0,function(){return x(this,function(a){return[2]})})};return e}();q.FeatureMatcher=h;l=function(e){function b(a,k,c,d){var b=e.call(this)||this;b._intervals=[];b._isMaxInclusive=k;d?b._getValue=E.callWithFeature.bind(null,d):a&&a.length?"function"===typeof a?(b._field=null,b._getValue=a):(b._field=a,b._normalizationInfo=c,b._getValue=b._getValueFromField.bind(b)):b._field=null;return b}C(b,
e);b.fromCBRenderer=function(a,k,c){return g(this,void 0,void 0,function(){var d,A,e,y,z,G,H,n,p,r,t,v,w,B,h,m,g,q,l;return x(this,function(f){switch(f.label){case 0:return d=a.isMaxInclusive,A=a.normalizationField,e=a.normalizationTotal,y=a.normalizationType,z=a.field,G={normalizationField:A,normalizationTotal:e,normalizationType:y},(p=H=a.valueExpression)?[4,D.createRendererExpression(H,c.spatialReference,c.fields)]:[3,2];case 1:p=f.sent(),f.label=2;case 2:return n=p,r=new b(z,d,G,n),[4,u.expandSymbol(a.backgroundFillSymbol)];
case 3:t=f.sent(),v=0,w=a.classBreakInfos,f.label=4;case 4:if(!(v<w.length))return[3,8];B=w[v];return[4,u.expandSymbol(B.symbol)];case 5:return h=f.sent(),[4,k.createTemplateGroup(h,t,a,c)];case 6:m=f.sent(),g={min:B.minValue,max:B.maxValue},r.add(g,m),f.label=7;case 7:return v++,[3,4];case 8:return[4,u.expandSymbol(a.defaultSymbol)];case 9:return(q=f.sent())?[4,k.createTemplateGroup(q,t,a,c)]:[3,11];case 10:l=f.sent(),r.setDefault(l),f.label=11;case 11:return[2,r]}})})};b.prototype.add=function(a,
b){this._intervals.push({interval:a,result:b});this._intervals.sort(function(a,d){return a.interval.min-d.interval.min})};b.prototype.size=function(){return e.prototype.size.call(this)+this._intervals.length};b.prototype.match=function(a,b,c,d,e){if(!this._getValue)return this.getDefault();a=this._getValue(b,{$view:e},c,d);if(!a&&(null===a||void 0===a||isNaN(a)))return this.getDefault();for(b=0;b<this._intervals.length;b++)if(d=this._intervals[b],c=d.interval,d=d.result,e=this._isMaxInclusive?a<=
c.max:a<c.max,a>=c.min&&e)return d;return this.getDefault()};b.prototype._needsNormalization=function(){var a=this._normalizationInfo;return a&&(a.normalizationField||a.normalizationTotal||a.normalizationType)};b.prototype._getValueFromField=function(a){var b=a.attributes[this._field];if(!this._needsNormalization())return b;var c=this._normalizationInfo,d=c.normalizationField,e=c.normalizationTotal,c=c.normalizationType;a=!!d&&a.attributes[d];if(c)switch(c){case "field":return(a||void 0)&&b/a;case "log":return Math.log(b)*
Math.LOG10E;case "percent-of-total":return b/e*100;default:F.error("Found unknown normalization type: "+c)}else F.error("Normalization is required, but no type was set!")};return b}(h);q.IntervalMatcher=l;l=function(e){function b(a,b,c){var d=e.call(this)||this;d._nullResult=null;d._resultsMap=new Map;c?d._getValue=E.callWithFeature.bind(null,c):a&&a.length?"function"===typeof a[0]?(d._fields=null,d._getValue=a[0]):(d._fields=a,d._seperator=b||"",d._getValue=d._getValueFromFields.bind(d)):d._fields=
null;return d}C(b,e);b.fromUVRenderer=function(a,k,c){return g(this,void 0,void 0,function(){var d,e,f,y,z,h,g,n,p,r,t,v,w,q,l;return x(this,function(m){switch(m.label){case 0:return d=a.uniqueValueInfos,e=a.fieldDelimiter,f=[a.field],y=a.valueExpression,a.field2&&f.push(a.field2),a.field3&&f.push(a.field3),[4,u.expandSymbol(a.backgroundFillSymbol)];case 1:return z=m.sent(),(g=y)?[4,D.createRendererExpression(y,c.spatialReference,c.fields)]:[3,3];case 2:g=m.sent(),m.label=3;case 3:h=g,n=new b(f,e,
h),p=0,r=d,m.label=4;case 4:if(!(p<r.length))return[3,8];t=r[p];return[4,u.expandSymbol(t.symbol)];case 5:return v=m.sent(),[4,k.createTemplateGroup(v,z,a,c)];case 6:w=m.sent(),"\x3cNull\x3e"===t.value?n.setNullResult(w):n.add(t.value,w),m.label=7;case 7:return p++,[3,4];case 8:return[4,u.expandSymbol(a.defaultSymbol)];case 9:return(q=m.sent())?[4,k.createTemplateGroup(a.defaultSymbol,z,a,c)]:[3,11];case 10:l=m.sent(),n.setDefault(l),m.label=11;case 11:return[2,n]}})})};b.prototype.setNullResult=
function(a){this._nullResult=a};b.prototype.add=function(a,b){this._resultsMap.set(a.toString(),b)};b.prototype.size=function(){return e.prototype.size.call(this)+this._resultsMap.size};b.prototype.match=function(a,b,c,d,e){if(!this._getValue)return this.getDefault();a=this._getValue(b,{$view:e},c,d);if(null!==this._nullResult&&(null==a||""===a||"\x3cNull\x3e"===a))return this._nullResult;if(!a&&null==a)return this.getDefault();a=a.toString();return this._resultsMap.has(a)?this._resultsMap.get(a):
this.getDefault()};b.prototype._getValueFromFields=function(a){for(var b=[],c=0,d=this._fields;c<d.length;c++)b.push(a.attributes[d[c]]);return b.join(this._seperator)};return b}(h);q.MapMatcher=l;h=function(e){function b(a,b,c){var d=e.call(this)||this;d._fidToAttributeHash=new Map;d._attributeHashToGroup=new Map;d._renderer=a;d._fieldMap=a.fieldMap;d._templates=b;d._info=c;return d}C(b,e);b.fromDictionaryRenderer=function(a,e,c){return g(this,void 0,void 0,function(){return x(this,function(d){a.fetchResources({spatialReference:c.spatialReference,
fields:c.fields});return[2,new b(a,e,c)]})})};b.prototype.analyze=function(a,b,c,d){return g(this,void 0,void 0,function(){var e,f,k,h,g,l,n=this;return x(this,function(p){switch(p.label){case 0:e=[];f=function(b){var f=b.attributes[a],h=k._fidToAttributeHash.get(f),g=k._hashAttributes(b);if(h===g)return"continue";k._fidToAttributeHash.set(f,g);k._attributeHashToGroup.has(g)||(b=k._renderer.getSymbolAsync(b,{scale:c&&c.scale,viewingMode:c&&c.viewingMode,spatialReference:k._info.spatialReference,abortOptions:d,
fields:k._info.fields}).then(function(a){return n._templates.createTemplateGroup(a,null,n._renderer,n._info).then(function(a){return n._attributeHashToGroup.set(g,a)})}),e.push(b))};k=this;h=0;for(g=b;h<g.length;h++)l=g[h],f(l);return[4,I.all(e)];case 1:return p.sent(),[2]}})})};b.prototype.match=function(a,b){a=this._fidToAttributeHash.get(b.attributes[a]);return this._attributeHashToGroup.get(a)};b.prototype._hashAttributes=function(a){var b="",c;for(c in this._fieldMap)b+=". "+a.attributes[this._fieldMap[c]];
return b};return b}(h);q.DictionaryMatcher=h});