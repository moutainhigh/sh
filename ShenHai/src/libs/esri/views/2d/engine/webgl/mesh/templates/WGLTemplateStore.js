// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/awaiterHelper ../../../../../../core/tsSupport/generatorHelper ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/promiseUtils ../../../../../../support/arcadeOnDemand ../../../../../../symbols/cim/cimAnalyzer ../../../../../../symbols/support/defaults ../../../../arcade/utils ./WGLDynamicLineTemplate ./WGLDynamicMarkerTemplate ./WGLDynamicTextTemplate ./WGLFillTemplate ./WGLLineTemplate ./WGLMarkerTemplate ./WGLTextTemplate ../../util/BidiText ../../util/Lock ../../util/Result".split(" "),
function(x,r,g,h,D,E,k,F,G,t,H,I,J,K,q,y,u,z,L,A,n){function m(b,a){var e=b.length;b.push(null);a.then(function(a){return b[e]=a});return b}function B(b){return!!(b&1)}Object.defineProperty(r,"__esModule",{value:!0});var l=E.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),C=[];r.isDynamicId=B;x=function(){function b(a,e){this._templateIdCounter=this._idCounter=0;this._idToTemplateGroup=new Map;this._symbolToTemplate=new Map;this._fetchQueue=[];this._idToResolver=new Map;this._cimTemplateCache=
new Map;this._cimAnalyses=[];this._lock=new A.default;this._fetchResource=a;this._joinOnUTurn=e}Object.defineProperty(b.prototype,"_markerError",{get:function(){return this._errorTemplates.marker[0]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_fillError",{get:function(){return this._errorTemplates.fill[0]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_lineError",{get:function(){return this._errorTemplates.line[0]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"_textError",{get:function(){return this._errorTemplates.line[0]},enumerable:!0,configurable:!0});b.prototype.createTemplateGroup=function(a,e,c,d){return g(this,void 0,void 0,function(){var f,b,p;return h(this,function(v){switch(v.label){case 0:return[4,this._initErrorTemplates()];case 1:v.sent();f=JSON.stringify(a);if(this._symbolToTemplate.has(f))return[2,this._symbolToTemplate.get(f)];b=[];return e?[4,this._createMeshTemplates(b,e,c,d,!0)]:[3,3];case 2:v.sent(),v.label=3;case 3:return[4,this._createMeshTemplates(b,
a,c,d,!1)];case 4:return v.sent(),p=this._createGroupId("cim"===a.type),this._idToTemplateGroup.set(p,b),this._symbolToTemplate.set(f,p),[2,p]}})})};b.prototype.getCIMMosaicItem=function(a,e){var c=this,d=this._createTemplateId(),f=k.create(function(a){return c._idToResolver.set(d,a)});this._fetchQueue.push({symbol:a,id:d,glyphIds:e});return f};b.prototype.getTemplateGroup=function(a){return this._idToTemplateGroup.has(a)?this._idToTemplateGroup.get(a):C};b.prototype.getDynamicTemplateGroup=function(a){if(!this._idToTemplateGroup.has(a))return C;
B(a)||l.error("mapview-template-store","Id "+a+" does not refer to a dynamic template");return this._idToTemplateGroup.get(a)};b.prototype.finalize=function(a){return this._fetchQueue.length||this._lock.isHeld()?A.withLock(this._lock,this._fetchAllQueuedResources.bind(this),a):k.resolve()};b.prototype._initErrorTemplates=function(){return g(this,void 0,void 0,function(){var a,e,c,d;return h(this,function(f){switch(f.label){case 0:if(this._errorTemplates)return[2];a=this._createMeshTemplates([],t.errorPolygonSymbol2D,
null,null,!1);e=this._createMeshTemplates([],t.errorPointSymbol2D,null,null,!1);c=this._createMeshTemplates([],t.errorPolylineSymbol2D,null,null,!1);return[4,k.all([a,e,c])];case 1:return d=f.sent(),this._errorTemplates={fill:d[0],marker:d[1],line:d[2]},[2]}})})};b.prototype._fetchAllQueuedResources=function(a){var e=this;if(!this._fetchQueue.length)return k.resolve();var c=this._fetchQueue,d=this._cimAnalyses;this._fetchQueue=[];this._cimAnalyses=[];return k.all(d).then(function(){return e._fetchResource(c,
a).then(function(a){for(var c=0;c<a.length;c++){var d=a[c],f=d.id,d=d.mosaicItem;e._idToResolver.get(f)(d);e._idToResolver.delete(f)}})}).catch(function(a){k.isAbortError(a)?e._fetchQueue=e._fetchQueue.concat(c):l.error(D("mapview-template-store","Unable to fetch requested texture resources",a))})};b.prototype._createGroupId=function(a){return this._idCounter++<<1|(a?1:0)};b.prototype._createTemplateId=function(){return this._templateIdCounter++};b.prototype._getCodepoints=function(a){a=L.bidiText(a.text)[0];
for(var e=[],c=0;c<a.length;c++)e.push(a.charCodeAt(c));return e};b.prototype._getMosaicItem=function(a){var e=this,c=this._createTemplateId(),d="text"===a.type&&this._getCodepoints(a),f=k.create(function(a){return e._idToResolver.set(c,a)});this._fetchQueue.push({symbol:a.toJSON(),id:c,glyphIds:d});return f};b.prototype._createSMS=function(a,e){return g(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:return[4,this._getMosaicItem(a)];case 1:return c=d.sent().spriteMosaicItem,
n.ok(c,l)?[2,u.default.fromSimpleMarker(e,a,c)]:[2,this._markerError]}})})};b.prototype._createPMS=function(a,e){return g(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:return[4,this._getMosaicItem(a)];case 1:return c=d.sent().spriteMosaicItem,n.ok(c,l)?[2,u.default.fromPictureMarker(e,a,c)]:[2,this._markerError]}})})};b.prototype._createSFS=function(a,e,c){return g(this,void 0,void 0,function(){var d,f;return h(this,function(b){switch(b.label){case 0:return[4,
this._getMosaicItem(a)];case 1:return d=b.sent().spriteMosaicItem,f=a,n.ok(d,l)?[2,q.default.fromSimpleFill(e,f,d,c)]:[2,this._fillError]}})})};b.prototype._createPFS=function(a,e,c){return g(this,void 0,void 0,function(){var d,f;return h(this,function(b){switch(b.label){case 0:return[4,this._getMosaicItem(a)];case 1:return d=b.sent().spriteMosaicItem,f=a,n.ok(d,l)?[2,q.default.fromPictureFill(e,f,d,c)]:[2,this._fillError]}})})};b.prototype._createSLS=function(a,e,c){return g(this,void 0,void 0,function(){var d,
f;return h(this,function(b){switch(b.label){case 0:return[4,this._getMosaicItem(a)];case 1:return d=b.sent().spriteMosaicItem,f=a,n.ok(d,l)?[2,y.default.fromSimpleLine(e,c,f,d,this._joinOnUTurn)]:[2,this._lineError]}})})};b.prototype._createTS=function(a,e){return g(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:return[4,this._getMosaicItem(a)];case 1:return c=d.sent().glyphMosaicItems,[2,z.default.fromText(e,a,c)]}})})};b.prototype._createCIMText=function(a,
e,c){return g(this,void 0,void 0,function(){var d,f,b,p,g,m;return h(this,function(h){switch(h.label){case 0:if("function"===typeof a.materialHash||"function"===typeof c)return[2,k.resolve(K.default.fromCIMText(e,a,c))];d=[];if(f=a.text)for(b=f.length,p=0;p<b;p++)g=f.charCodeAt(p),d.push(g);a.cim.mosaicHash=a.materialHash;return[4,this.getCIMMosaicItem(a.cim,d)];case 1:return m=h.sent().glyphMosaicItems,n.ok(m,l)?[2,z.default.fromCIMText(e,a,c,m)]:[2,this._textError]}})})};b.prototype._createCIMFill=
function(a,e){return g(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:return a.cim.mosaicHash=a.materialHash,[4,this.getCIMMosaicItem(a.cim)];case 1:return c=d.sent().spriteMosaicItem,n.ok(c,l)?[2,q.default.fromCIMFill(e,a,c,!1)]:[2,this._fillError]}})})};b.prototype._createCIMLine=function(a,e,c){return g(this,void 0,void 0,function(){var d;return h(this,function(f){switch(f.label){case 0:if("function"===typeof a.materialHash||"function"===typeof c)return[2,
k.resolve(I.default.fromCIMLine(e,a,c))];a.cim.mosaicHash=a.materialHash;return[4,this.getCIMMosaicItem(a.cim)];case 1:return d=f.sent().spriteMosaicItem,n.ok(d,l)?[2,y.default.fromCIMLine(e,a,d,!1,this._joinOnUTurn,c)]:[2,this._lineError]}})})};b.prototype._createCIMMarker=function(a,e,c){return g(this,void 0,void 0,function(){var d;return h(this,function(f){switch(f.label){case 0:if("function"===typeof a.materialHash||"function"===typeof c)return[2,k.resolve(J.default.fromCIMMarker(e,a,c))];a.cim.mosaicHash=
a.materialHash;return[4,this.getCIMMosaicItem(a.cim)];case 1:return d=f.sent().spriteMosaicItem,n.ok(d,l)?[2,u.default.fromCIMMarker(e,a,d,c)]:[2,this._markerError]}})})};b.prototype._createCIM=function(a,e,c){return g(this,void 0,void 0,function(){var d,f,b=this;return h(this,function(g){d=a.templateHash;if(this._cimTemplateCache.has(d))return[2,this._cimTemplateCache.get(d)];switch(a.type){case "marker":f=this._createCIMMarker(a,e,c);break;case "line":f=this._createCIMLine(a,e,c);break;case "fill":f=
this._createCIMFill(a,e);break;case "text":f=this._createCIMText(a,e,c)}f.then(function(a){return b._cimTemplateCache.set(d,a)});return[2,f]})})};b.prototype._getCIMSymbolLayers=function(a,e,c){return g(this,void 0,void 0,function(){var d,b;return h(this,function(f){switch(f.label){case 0:return d=[],b=[],d.push(G.analyzeCIMSymbol(a.data,e,c,b)),[4,k.all(d)];case 1:return f.sent(),[2,b]}})})};b.prototype._createCIMMeshTemplates=function(a,e,c,d){return g(this,void 0,void 0,function(){var b,g,p,l,
k,n,r,t,w,q,u;return h(this,function(f){switch(f.label){case 0:g=(b=c)?b.fieldMap:null;p=e;if(!b||!b.scaleExpression)return[3,3];if(!isNaN(b.scaleExpression))return[3,2];n=b.scaleExpression;return[4,F.createRendererExpression(n,d.spatialReference,d.fields)];case 1:return r=f.sent(),l=function(a,c,b){a=H.callWithFeature(r,a,{$view:b},d.geometryType,c);return null!==a?a:1},[3,3];case 2:k=Number(b.scaleExpression),f.label=3;case 3:return[4,this._getCIMSymbolLayers(p,g,d)];case 4:t=f.sent();w=0;for(q=
t;w<q.length;w++)u=q[w],m(a,this._createCIM(u,c,k||l||1));return[2]}})})};b.prototype._createMeshTemplates=function(a,b,c,d,f){return g(this,void 0,void 0,function(){var e,g,k;return h(this,function(h){switch(h.label){case 0:if(-1!==b.type.indexOf("3d"))return l.error("3D symbols are not supported with MapView"),[2,a];e=b.type;switch(e){case "cim":return[3,1];case "simple-marker":return[3,3];case "picture-marker":return[3,4];case "simple-fill":return[3,5];case "picture-fill":return[3,6];case "simple-line":return[3,
7];case "text":return[3,8]}return[3,9];case 1:return[4,this._createCIMMeshTemplates(a,b,c,d)];case 2:return h.sent(),[2,a];case 3:return[2,m(a,this._createSMS(b,c))];case 4:return[2,m(a,this._createPMS(b,c))];case 5:return g=b,m(a,this._createSFS(g,c,f)),g.outline&&m(a,this._createSLS(g.outline,c,!0)),[2,a];case 6:return k=b,m(a,this._createPFS(k,c,f)),k.outline&&m(a,this._createSLS(k.outline,c,!0)),[2,a];case 7:return[2,m(a,this._createSLS(b,c,!1))];case 8:return[2,m(a,this._createTS(b,c))];case 9:return l.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),
[2,a]}})})};return b}();r.WGLTemplateStore=x});