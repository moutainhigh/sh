// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../request ../../../../core/has ../../../../core/ItemCache ../../../../core/maybe ../../../../core/MemCache ../../../../core/promiseUtils ../../../../core/requireUtils ../../../../core/workers ../../../../geometry/support/aaBoundingRect ../vectorTiles/VectorTile ./GeometryUtils ./GlyphMosaic ./GlyphSource ./SpriteMosaic ./TileIndex ../../tiling/TileKey module".split(" "),
function(B,w,t,n,l,x,C,u,q,D,p,E,F,G,H,y,I,J,K,z,v,L){Object.defineProperty(w,"__esModule",{value:!0});var A=new u(10),r=new Map;u=function(){function d(a,f,e,b,c){this._vectorTileLayer=a;this.devicePixelRatio=f;this.allowUpdates=e;this._container=b;this._memCache=c;this._connection=this._glyphMosaic=this._spriteMosaic=null;this._updateToAbortController=new Map;this._ongoingTileRequests=new Map;this._ongoingRequestToController=new Map}d.prototype.destroy=function(){this._updateToAbortController&&
this._updateToAbortController.forEach(function(a){return a.abort()});this._ongoingTileRequests&&this.abortAll();this._connection&&(this._connection.close(),this._connection=null);this._vectorTileLayer=null;this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null);this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null)};Object.defineProperty(d.prototype,"spriteMosaic",{get:function(){var a=this;return this._spriteSourcePromise.then(function(){return a._spriteMosaic})},
enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"glyphMosaic",{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0});d.prototype.start=function(a){return l(this,void 0,void 0,function(){var f,e,b,c,h,g=this;return n(this,function(k){f=this._vectorTileLayer.sourceNameToSource;e=[];for(b in f)e.push(this._fetchTileMap(f[b],a));this._spriteSourcePromise=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio,a);this._spriteSourcePromise.then(function(a){g._spriteMosaic=
new K(1024,1024,250);g._spriteMosaic.setSpriteSource(a)});c=this._vectorTileLayer.styleRepository;h=new J(c.glyphs);this._glyphMosaic=new I(1024,1024,h);this._broadcastPromise=F.open(E.getAbsMid("../vectorTiles/WorkerTileHandler",B,L),{client:this,scheduler:a.scheduler,signal:a.signal}).then(function(b){g._connection=b;return p.all(g._connection.broadcast("setLayers",c.styleJSON,t({},a)))});return[2,p.all(e)]})})};d.prototype.updateStyle=function(){return l(this,void 0,void 0,function(){var a,f=this;
return n(this,function(e){switch(e.label){case 0:return[4,this._broadcastPromise];case 1:return e.sent(),this._updateToAbortController.forEach(function(a){return a.abort()}),this._updateToAbortController.clear(),a=this._vectorTileLayer.styleRepository,this._broadcastPromise=p.create(function(b,c){p.all(f._connection.broadcast("updateStyle",a.styleJSON)).then(b,c)}),[2,this._broadcastPromise]}})})};d.prototype.abortTileUpdate=function(a){this._updateToAbortController.has(a)&&(this._updateToAbortController.get(a).abort(),
this._updateToAbortController.delete(a))};d.prototype.updateTile=function(a,f){return l(this,void 0,void 0,function(){var e,b,c,h,g=this;return n(this,function(k){switch(k.label){case 0:return this.allowUpdates&&a.isReady?[4,this._broadcastPromise]:[2];case 1:k.sent();e=Math.round(y.degToByte(f.state.rotation));if(a.rotation===e)return[2,null];c=a.key;this._updateToAbortController.has(c.id)&&(b=this._updateToAbortController.get(c.id),b.abort(),this._updateToAbortController.delete(c.id));b=p.createAbortController();
a.rotation=e;h=a.client.invoke("updateSymbols",{key:a.id,rotation:e},{signal:b.signal}).then(function(b){g._updateToAbortController.delete(c.id);a.isReady&&a.updateSymbolData(b)}).catch(function(a){p.isAbortError(a)||g._updateToAbortController.delete(c.id)});this._updateToAbortController.set(a.id,b);return[2,h]}})})};d.prototype.updateTileData=function(a){for(var f=a.tileId,e=this._container.children,b,c=0;c<e.length;c++)if(b=e[c],b.id===f){b.updateTileData(a.tileData);break}};d.prototype.getVectorTile=
function(a,f,e){return l(this,void 0,void 0,function(){var b,c,h,g,k,d,m;return n(this,function(n){switch(n.label){case 0:return b=new v(a,f,e,0),q.isSome(this._memCache)&&(c=this._memCache.get(b.id))?(c.reference(),[2,c]):[4,this._getVectorTileData(b,null)];case 1:h=n.sent();if(q.isSome(this._memCache)&&(g=this._memCache.get(b.id)))return g.reference(),[2,g];k=this._vectorTileLayer.tileInfo;d=k.getTileBounds(G.create(),b);m=new H.VectorTile(b,this._vectorTileLayer.styleRepository,d,[512,512]);h&&
h.tileData?(m.setData(h.tileData,h.client),q.isSome(this._memCache)&&(m.reference(),this._memCache.put(m.key.id,m,m.getMemoryUsage()*m.referenced,D.MIN_PRIORITY))):m.setData(null,null);return[2,m]}})})};d.prototype.releaseVectorTile=function(a){q.isNone(this._memCache)||a.release()||this._memCache.updateSize(a.key.id,a,a.getMemoryUsage()*a.referenced)};d.prototype.fetchTileData=function(a,f){return l(this,void 0,void 0,function(){var e,b,c,h;return n(this,function(g){switch(g.label){case 0:return[4,
this._getRefKeys(a,f)];case 1:e=g.sent();b=this._vectorTileLayer.sourceNameToSource;c=[];for(h in b)c.push(h);return[2,this._getSourcesData(c,e,f)]}})})};d.prototype.parseTileData=function(a,f,e){return l(this,void 0,void 0,function(){var b,c,h,g,d,l,m,p;return n(this,function(k){switch(k.label){case 0:b=a&&a.data;if(!b)return[2,null];c=b.sourceName2DataAndRefKey;h=b.transferList;return 0===Object.keys(c).length?[2,null]:[4,this._broadcastPromise];case 1:return k.sent(),g=Math.round(y.degToByte(f)),
d=this._connection.getAvailableClient(),[4,d.invoke("createTileAndParse",{key:a.key.id,rotation:g,cacheTile:this.allowUpdates,sourceName2DataAndRefKey:c},t({},e,{transferList:h})).catch(function(){d.invoke("destructTileData",a.key.id);return null})];case 2:l=k.sent();if(C("esri-vector-tiles-debug")){m={};for(p in c)m[p]=c[p].refKey;return[2,{tileData:l,client:d,refKeys:m}]}return[2,{tileData:l,client:d}]}})})};Object.defineProperty(d.prototype,"updating",{get:function(){return 0<this._ongoingTileRequests.size},
enumerable:!0,configurable:!0});d.prototype.abortAll=function(){this._ongoingRequestToController.forEach(function(a){return a.abort()});this._ongoingRequestToController.clear();this._ongoingTileRequests.clear()};d.prototype.getSprites=function(a){return l(this,void 0,void 0,function(){return n(this,function(f){switch(f.label){case 0:return[4,this._spriteSourcePromise];case 1:return f.sent(),[2,this._spriteMosaic.getSpriteItems(a)]}})})};d.prototype.getGlyphs=function(a){return this._glyphMosaic.getGlyphItems(a.font,
a.codePoints)};d.prototype.getStyleRepository=function(){return this._vectorTileLayer.styleRepository};d.prototype._getTilePayload=function(a,f,e){return l(this,void 0,void 0,function(){var b,c,d,g,k;return n(this,function(h){switch(h.label){case 0:return b=v.pool.acquire(a.id),c=this._vectorTileLayer.sourceNameToSource,d=c[f],g=d.getSourceTileUrl(b.level,b.row,b.col),v.pool.release(b),[4,x(g,t({responseType:"array-buffer"},e))];case 1:return k=h.sent(),[2,{protobuff:k.data,sourceName:f}]}})})};d.prototype._fetchTileMap=
function(a,f){if(a.capabilities.operations.supportsTileMap&&a.tileIndex||!a.tileMapURL)return p.resolve();var e=A.get(a.tileMapURL);if(e)return a.tileIndex=e,p.resolve();if(r.has(a.tileMapURL))return r.get(a.tileMapURL).then(function(b){a.tileIndex=new z(b.data)});f=x(a.tileMapURL,f);f.then(function(b){a.tileIndex=new z(b.data);r["delete"](a.tileMapURL);A.put(a.tileMapURL,a.tileIndex)});r.set(a.tileMapURL,f);return f};d.prototype._getRefKeys=function(a,f){return l(this,void 0,void 0,function(){var e,
b,c,d,g;return n(this,function(h){e=this._vectorTileLayer.sourceNameToSource;b=[];for(c in e)d=e[c],g=d.getRefKey(a,f),b.push(g);return[2,p.eachAlways(b)]})})};d.prototype._getSourcesData=function(a,f,e){return l(this,void 0,void 0,function(){var b,c,d,g,k,l,m;return n(this,function(h){switch(h.label){case 0:b=[];for(c=0;c<f.length;c++)null==f[c].value||null==a[c]?b.push(null):(d=this._getTilePayload(f[c].value,a[c],e),b.push(d));return[4,p.eachAlways(b)];case 1:g=h.sent();k={};l=[];for(c=0;c<g.length;c++)g[c].value&&
g[c].value&&g[c].value.protobuff&&0<g[c].value.protobuff.byteLength&&(m=f[c].value.id,k[g[c].value.sourceName]={refKey:m,protobuff:g[c].value.protobuff},l.push(g[c].value.protobuff));return[2,{sourceName2DataAndRefKey:k,transferList:l}]}})})};d.prototype._getVectorTileData=function(a,f){return l(this,void 0,void 0,function(){var e,b,c,d,g,k=this;return n(this,function(h){e=a.id;if(this._ongoingTileRequests.has(e))return[2,this._ongoingTileRequests.get(e)];b=new AbortController;c={signal:b.signal};
d=f&&f.signal;g=this._getParsedVectorTileData(a,c).then(function(a){k._ongoingTileRequests.delete(e);k._ongoingRequestToController.delete(e);return a}).catch(function(){k._ongoingTileRequests.delete(e);k._ongoingRequestToController.delete(e);return null});this._ongoingTileRequests.set(e,g);this._ongoingRequestToController.set(e,b);if(d)p.onAbort(d,function(){b.abort();k._ongoingTileRequests.delete(e);k._ongoingRequestToController.delete(e)});return[2,g]})})};d.prototype._getParsedVectorTileData=function(a,
d){return l(this,void 0,void 0,function(){var e;return n(this,function(b){switch(b.label){case 0:return[4,this.fetchTileData(a,d)];case 1:return e=b.sent(),[2,this.parseTileData({key:a,data:e},0,d)]}})})};return d}();w.TileHandler=u});