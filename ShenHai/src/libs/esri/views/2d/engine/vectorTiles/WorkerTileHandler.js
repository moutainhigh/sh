// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../core/promiseUtils","./WorkerTile","./style/StyleRepository"],function(p,q,f,n,k){return function(){function b(){this._tiles=new Map;this._spriteInfo={};this._glyphInfo={}}b.prototype.reset=function(){this._spriteInfo={};this._glyphInfo={};var a=this._tiles;a.forEach(function(a){return a.setObsolete()});a.clear();return f.resolve()};b.prototype.getLayers=function(){return this._layers};b.prototype.setLayers=function(a){this._layers=(new k(a)).layers;return f.resolve({data:""})};
b.prototype.createTileAndParse=function(a,b){for(var c=this,h=a.key,d=new n,g={},e=0,l=Object.keys(a.sourceName2DataAndRefKey);e<l.length;e++){var m=l[e];g[m]=a.sourceName2DataAndRefKey[m].refKey}d.initialize(h,g,this,a.rotation);return d.setDataAndParse(a.sourceName2DataAndRefKey,b).then(function(a){c._tiles.set(h,d);return a}).catch(function(a){d.setObsolete();d.release();throw a;})};b.prototype.updateSymbols=function(a,b){var c=this._tiles.get(a.key);return c?c.updateSymbols(a.rotation,b):f.reject()};
b.prototype.updateStyle=function(a,b){this._layers=(new k(a)).layers;this._tiles.forEach(function(a){a.reparse(b).then(function(c){b.client.invoke("updateTileData",{tileId:a.tileKey,tileData:c.result})})});return f.resolve({data:""})};b.prototype.destructTileData=function(a){this._tiles.has(a)&&(this._tiles.get(a).release(),this._tiles.delete(a));return f.resolve()};b.prototype.fetchSprites=function(a,b,c){var h=[],d=this._spriteInfo;a.forEach(function(a){void 0===d[a]&&h.push(a)});return 0===h.length?
f.resolve():b.invoke("getSprites",h,{signal:c&&c.signal}).then(function(a){for(var b in a)d[b]=a[b]})};b.prototype.getSpriteItems=function(){return this._spriteInfo};b.prototype.fetchGlyphs=function(a,b,c,k,d){var g=[],e=this._glyphInfo[b];e?c.forEach(function(a){e[a]||g.push(a)}):(e=this._glyphInfo[b]=[],c.forEach(function(a){return g.push(a)}));return 0===g.length?f.resolve():k.invoke("getGlyphs",{tileID:a,font:b,codePoints:g},d).then(function(a){for(var b=0;b<a.length;b++)a[b]&&(e[b]=a[b])})};
b.prototype.getGlyphItems=function(a){return this._glyphInfo[a]};return b}()});