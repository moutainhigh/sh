// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/mathUtils ../../../core/libs/gl-matrix-2/vec2 ../../../core/libs/gl-matrix-2/vec2f64 ../../../core/libs/gl-matrix-2/vec4 ../../2d/engine/vectorTiles/tileRendererHelper3D ../../2d/engine/vectorTiles/VectorTile ./BlendLayersTechnique ./BlendLayersTechnique ./terrainUtils ./support/FBOPool ../webgl-engine/lib/DefaultVertexBufferLayouts ../webgl-engine/lib/glUtil3D ../../webgl/Texture ../../webgl/Util".split(" "),function(I,J,B,w,x,t,C,y,z,D,E,F,G,q,r,H){function u(c,
a,b){b.layerIndex=a;var d=c.layerInfo[1][a];return d.data?(w.vec2.set(b.offset,0,0),b.tile=c,b.scale=1,b.sourceLod=c.lij,b.sourceLayerInfo=d,b):(c=d.upsampleInfo)?(a=c.tile.layerInfo[1][a],b.tile=c.tile,w.vec2.copy(b.offset,c.offset),b.scale=c.scale,b.sourceLod=c.tile.lij,b.sourceLayerInfo=a,b):null}var A=[],v={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};return function(){function c(a,b,d,e){this._context=a;this.tileSize=b;this._setNeedsRender=e;this._blackTex=
this._backgroundTexture=null;this._context.capabilities.textureFilterAnisotropic&&(this._maxAnisotropy=Math.min(8,this._context.parameters.maxMaxAnisotropy));this._vaoQuad=q.createQuadVAO(this._context,G.Pos3Tex);this._blendLayersTechniqueConfig=new D.BlendLayersTechniqueConfiguration;this._blendLayersTechniqueConfig.mode=2;this._blendLayersTechnique=d.acquireAndReleaseExisting(z.BlendLayersTechnique,this._blendLayersTechniqueConfig,this._blendLayersTechnique);this._blendLayersTechniqueConfig.mode=
1;this._applyOpacityTechnique=d.acquireAndReleaseExisting(z.BlendLayersTechnique,this._blendLayersTechniqueConfig,this._applyOpacityTechnique);this._blackTex=q.createColorTexture(this._context,[0,0,0,1]);this._fboPool=new F.FBOPool(this._context)}c.prototype.dispose=function(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null);this._vaoQuad&&(this._vaoQuad.dispose(),this._vaoQuad=null);this._backgroundTexture&&(this._backgroundTexture.dispose(),this._backgroundTexture=null);this._blackTex&&
(this._blackTex.dispose(),this._blackTex=null);this._blendLayersTechnique&&(this._blendLayersTechnique.dispose(),this._blendLayersTechnique=null);this._applyOpacityTechnique&&(this._applyOpacityTechnique.dispose(),this._applyOpacityTechnique=null)};c.prototype.updateTileTexture=function(a){for(var b=a.layerInfo[1],d=0;d<b.length;d++)b[d].pendingUpdates&=-33;if(a.renderData){var e=a.surface,c=e.baseOpacity,d=0,f=this.tileSize,h=!1,g,k,l=b.length;for(g=0;g<b.length&&!h;g++){var m=e.layerViewByIndex(g,
1),n=m.fullOpacity;k=m.view.pixelRatio;A[g]=n;this._isBaseLayer(m.layer)&&l>=b.length&&(l=g);0!==n&&u(a,g,v)&&(E.isVectorTileLayerView(m)?f=Math.max(f,this.tileSize*m.view.pixelRatio):m.isOpaque&&1===c&&1===n&&(h=!0),d++)}this._cleanupFBOPool(k,b.length);e=f;f=B.nextHighestPowerOfTwo(e);b=f*f;k=e*e;b===k?f=e:(e=f/2,f=b-k<k-e*e?f:e);b=f/this.tileSize;--g;0===d&&this._backgroundTexture?this._useBackgroundTexture(a):1===d&&h?this._useLayerTexture(a,g):this._composeMapLayers(a,g,l,h,A,f,b);this._setNeedsRender()}};
c.prototype.setBackground=function(a){this._backgroundTexture=a instanceof HTMLImageElement?this._buildTexture(a):q.createColorTexture(this._context,a)};c.prototype._buildTexture=function(a){var b={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},d=this._context,e;if("number"===typeof a)b.width=b.height=a,e=new r(d,b);else try{e=new r(d,b,a)}catch(K){e=q.createEmptyTexture(d),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}d.bindTexture(e);
e.generateMipmap();return e};c.prototype._drawRasterData=function(a,b,d,e,c){void 0===c&&(c=1);var f=this._context,h=a.program,g=this._vaoQuad;f.setPipelineState(a.pipeline);f.bindProgram(h);f.bindVAO(g);h.assertCompatibleVertexAttributeLocations(g);f.bindTexture(b,0);h.setUniform1i("tex",0);h.setUniform1f("scale",d);h.setUniform2f("offset",e[0],e[1]);h.setUniform1f("opacity",c);f.drawArrays(5,0,H.vertexCount(g,"geometry"))};c.prototype._drawVectorData=function(a,b,d,e,c,f,h){var g=this._context,
k=b.tile.surface.layerViewByIndex(b.layerIndex,1),l=b.sourceLayerInfo.data,m;g.setPipelineState(a.pipeline);var n=1>e;n?(m=this._fboPool.acquire(c),g.bindFramebuffer(m),g.setClearColor(1,1,1,0),g.clearSafe(16640)):h&&g.clearSafe(256);C.renderVectorTile(g,b.sourceLod,l,k.painter,k.layer.styleRepository,k.schemaHelper,Math.round(1/b.scale),b.offset,this.tileSize,d);return n?(g.bindFramebuffer(f),this._drawRasterData(a,m.colorTexture,1,[0,0],e),this._fboPool.release(m),!1):!0};c.prototype._useBackgroundTexture=
function(a){a.renderData.releaseTexture();a.renderData.opacity=a.surface.baseOpacity;a.renderData.textureReference=this._backgroundTexture;t.vec4.set(a.renderData.texOffsetAndScale,0,0,1,1)};c.prototype._useLayerTexture=function(a,b){a.renderData.releaseTexture();b=u(a,b,v);if(this._dataToTexture(b)){a.renderData.textureReference=b.sourceLayerInfo.data;var d=b.offset;t.vec4.set(a.renderData.texOffsetAndScale,d[0],d[1],b.scale,b.scale)}a.renderData.opacity=a.surface.baseOpacity};c.prototype._composeMapLayers=
function(a,b,d,c,q,f,h){var e=this,k=a.renderData.ensureTexture(f,function(){return e._buildTexture(f)}),l=this._context,m=this._fboPool.acquire(f);l.bindFramebuffer(m);l.setViewport(0,0,f,f);l.setClearColor(0,0,0,0);l.setClearDepth(1);l.clearSafe(16640);var n=!1;!c&&this._backgroundTexture&&this._drawRasterData(this._blendLayersTechnique,this._backgroundTexture,1,x.vec2f64.ZEROS);c=a.surface.baseOpacity;for(var r=!1;0<=b;b--){var p=u(a,b,v);p&&(b<d&&1>c&&!r&&(this._drawRasterData(this._applyOpacityTechnique,
this._blackTex,1,x.vec2f64.ZEROS,c),r=!0),0!==q[b]&&(p&&p.sourceLayerInfo&&p.sourceLayerInfo.data instanceof y.VectorTile?this._drawVectorData(this._blendLayersTechnique,p,h,q[b],f,m,n)&&(n=!0):this._dataToTexture(p)&&this._drawRasterData(this._blendLayersTechnique,p.sourceLayerInfo.data,p.scale,p.offset,q[b])))}l.bindTexture(k);d=k.descriptor;l.gl.copyTexImage2D(l.gl.TEXTURE_2D,0,d.pixelFormat,0,0,d.width,d.height,0);k.generateMipmap();l.bindFramebuffer(null);this._fboPool.release(m);a.renderData.opacity=
r?1:c;a.renderData.textureReference=k;t.vec4.set(a.renderData.texOffsetAndScale,0,0,1,1)};c.prototype._dataToTexture=function(a){if(a&&a.sourceLayerInfo&&a.sourceLayerInfo.data instanceof y.VectorTile)return!1;var b=a&&a.sourceLayerInfo&&a.sourceLayerInfo.data;if(b instanceof HTMLImageElement||b instanceof HTMLCanvasElement)this._rasterDataToTexture(a),a.tile.setMemoryDirty();return a&&a.sourceLayerInfo&&a.sourceLayerInfo.data instanceof r};c.prototype._rasterDataToTexture=function(a){a=a.sourceLayerInfo;
a.data=this._buildTexture(a.data)};c.prototype._isBaseLayer=function(a){return a.parent&&"esri.Basemap"===a.parent.declaredClass&&-1<a.parent.baseLayers.indexOf(a)};c.prototype._cleanupFBOPool=function(a,b){if(a!==this._lastPixelRatio||b!==this._lastNumLayers)this._fboPool.clear(),this._lastPixelRatio=a,this._lastNumLayers=b};return c}()});