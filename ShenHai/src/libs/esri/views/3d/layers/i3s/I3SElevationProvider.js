// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/Accessor ../../../../core/Evented ../../../../core/Logger ../../../../core/accessorSupport/decorators ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/aaBoundingRect ../../../../layers/graphics/dehydratedFeatures ../../webgl-engine/lib/Intersector".split(" "),
function(C,D,u,l,v,w,x,g,y,z,m,h,n,A,B){var e=n.empty(),p=z.mat4f64.create(),b=h.vec3f64.create(),q=h.vec3f64.create(),r=h.vec3f64.create(),k={spatialReference:null,extent:e,context:"scene"},t=x.getLogger("esri.views.3d.layers.i3s.I3SElevationProvider");return function(h){function c(a){return h.call(this,a)||this}u(c,h);c.prototype.initialize=function(){var a=this.layerView.view;this.view=a;this.renderCoordsHelper=a.renderCoordsHelper;this.intersector=new B(a.viewingMode);this.intersector.options.store=
0;a=this.layerView.layer.fullExtent;this.zmin=a.zmin;this.zmax=a.zmax};c.prototype.getElevation=function(a){if(A.isPoint(a)){if(!this.renderCoordsHelper.toRenderCoords(a,b))return t.error("could not project point for elevation alignment"),null}else if(!this.renderCoordsHelper.toRenderCoords(a,this.spatialReference,b))return t.error("could not project point for elevation alignment"),null;var c=this.layerView.elevationOffset;a=this.zmin+c;c=this.zmax+c;m.vec3.copy(q,b);m.vec3.copy(r,b);this.renderCoordsHelper.setAltitude(c,
q);this.renderCoordsHelper.setAltitude(a,r);this.intersector.reset(q,r);this.intersectionHandler.intersect(this.intersector,null,q,r);return this.intersector.results.min.getIntersectionPoint(b)?this.renderCoordsHelper.getAltitude(b):null};c.prototype.layerChanged=function(){this.spatialReference&&(k.extent=this.computeLayerExtent(),k.spatialReference=this.spatialReference,this.emit("elevation-change",k))};c.prototype.objectChanged=function(a){this.spatialReference&&(k.extent=this.computeObjectExtent(a),
k.spatialReference=this.spatialReference,this.emit("elevation-change",k))};c.prototype.computeObjectExtent=function(a){n.empty(e);this.expandExtent(a,e);return e};c.prototype.computeLayerExtent=function(){n.empty(e);for(var a=0,b=this.layerView.getLoadedNodes();a<b.length;a++)this.expandExtent(b[a],e);return e};c.prototype.expandExtent=function(a,c){var d=a.renderObb;if(d)for(y.mat4.fromQuat(p,d.quaternion),p[12]=d.center[0],p[13]=d.center[1],p[14]=d.center[2],a=0;8>a;++a)b[0]=a&1?d.halfSize[0]:-d.halfSize[0],
b[1]=a&2?d.halfSize[1]:-d.halfSize[1],b[2]=a&4?d.halfSize[2]:-d.halfSize[2],m.vec3.transformMat4(b,b,p),this.renderCoordsHelper.fromRenderCoords(b,b,this.spatialReference),n.expand(c,b);else if(a.renderMbs){var e=a.renderMbs[3],d=m.vec3.copy(q,a.renderMbs);d[0]-=e;d[1]-=e;d[2]-=e;var f=m.vec3.copy(r,a.renderMbs);f[0]+=e;f[1]+=e;f[2]+=e;for(a=0;8>a;++a)b[0]=a&1?d[0]:f[0],b[1]=a&2?d[1]:f[1],b[2]=a&4?d[2]:f[2],this.renderCoordsHelper.fromRenderCoords(b,b,this.spatialReference),n.expand(c,b)}return c};
l([g.property({constructOnly:!0})],c.prototype,"layerView",void 0);l([g.property({constructOnly:!0})],c.prototype,"intersectionHandler",void 0);l([g.property()],c.prototype,"view",void 0);l([g.property({readOnly:!0,aliasOf:"view.elevationProvider.spatialReference"})],c.prototype,"spatialReference",void 0);return c=l([g.subclass("esri.views.3d.layers.i3s.I3SElevationProvider")],c)}(g.declared(w.EventedMixin(v)))});