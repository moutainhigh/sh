// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/assignHelper ../../../../core/Error ../../../../core/maybe ../../../../core/libs/earcut/earcut ../../../../core/libs/gl-matrix-2/mat3 ../../../../core/libs/gl-matrix-2/mat3f64 ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../layers/graphics/dehydratedFeatures ../../../../renderers/support/renderingInfoUtils ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ../support/edgeUtils ../../support/projectionUtils ../../support/buffer/BufferView ../../support/buffer/math/vec3 ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Util ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/internal/MaterialUtil".split(" "),
function(N,O,ea,fa,ga,ha,ia,J,ja,ka,la,R,L,y,m,ma,na,oa,H,pa,S,qa,T,U,V,ra,sa,ta,C,ua,va){function wa(e,d,a,b,n,c,f,k,t,q,A,l,h,m){var z=a.length/3,r=0;A+=2*b.count;var g=b.index,x=b.count,p=t,w=A;y.vec3.copy(u,h);var v=0<l?1:-1,g=3*g,P=p;h=3*P;for(var B=p+x,p=3*B,D=0;D<x;++D)m&&(u[0]=e[g+0],u[1]=e[g+1],u[2]=e[g+2],y.vec3.normalize(u,u)),n[h+0]=e[g+0],n[h+1]=e[g+1],n[h+2]=e[g+2],c[h+0]=d[g+0],c[h+1]=d[g+1],c[h+2]=d[g+2],f[h+0]=-v*u[0],f[h+1]=-v*u[1],f[h+2]=-v*u[2],k[P]=0,n[p+0]=e[g+0]+l*u[0],n[p+
1]=e[g+1]+l*u[1],n[p+2]=e[g+2]+l*u[2],c[p+0]=d[g+0],c[p+1]=d[g+1],c[p+2]=d[g+2],f[p+0]=v*u[0],f[p+1]=v*u[1],f[p+2]=v*u[2],k[B]=l,h+=3,p+=3,g+=3,P+=1,B+=1;g=0;h=3*w;p=3*(w+z);h=3*(w+z);p=3*w;e=W;d=X;0>l&&(e=X,d=W);for(D=0;D<z;++D)q[h+0]=a[g+e[0]],q[h+1]=a[g+e[1]],q[h+2]=a[g+e[2]],q[p+0]=a[g+d[0]]+x,q[p+1]=a[g+d[1]]+x,q[p+2]=a[g+d[2]]+x,h+=3,p+=3,g+=3;t+=2*b.count;A=A+2*z-(2*b.count+2*z);Y(n,c,k,f,r,b.pathLengths[0],b.count,t,q,A,l);t+=4*b.pathLengths[0];A+=2*b.pathLengths[0];r+=b.pathLengths[0];for(a=
1;a<b.pathLengths.length;++a)Y(n,c,k,f,r,b.pathLengths[a],b.count,t,q,A,l),t+=4*b.pathLengths[a],A+=2*b.pathLengths[a],r+=b.pathLengths[a]}function M(e,d,a,b,n,c,f){b[c]=b[f];f*=3;c*=3;e[c+0]=e[f+0];e[c+1]=e[f+1];e[c+2]=e[f+2];d[c+0]=d[f+0];d[c+1]=d[f+1];d[c+2]=d[f+2];a[c+0]=n[0];a[c+1]=n[1];a[c+2]=n[2]}function Y(e,d,a,b,n,c,f,k,t,q,A){var l=n,h=n+1,u=n+f,z=n+f+1,r=k,g=k+1,x=k+2*c;k=k+2*c+1;0>A&&(l=n+f+1,z=n);q*=3;for(var p=0;p<c;++p){p===c-1&&(0<A?(h=n,z=n+f):(h=n,l=n+f));var w=e,v=l,m=h,B=u,D=
F,v=3*v,m=3*m,B=3*B;y.vec3.set(Q,w[v++],w[v++],w[v++]);y.vec3.set(Z,w[m++],w[m++],w[m++]);y.vec3.set(aa,w[B++],w[B++],w[B++]);y.vec3.subtract(ba,Z,Q);y.vec3.subtract(ca,aa,Q);y.vec3.cross(D,ca,ba);y.vec3.normalize(D,D);M(e,d,b,a,F,r,l);M(e,d,b,a,F,g,h);M(e,d,b,a,F,x,u);M(e,d,b,a,F,k,z);t[q++]=r;t[q++]=x;t[q++]=k;t[q++]=r;t[q++]=k;t[q++]=g;l++;h++;u++;z++;r+=2;g+=2;x+=2;k+=2}}function xa(e,d,a,b){e=e.stageObject;K.spatialReference=a.spatialReference;for(var n=e.geometryRecords,c=n.length,f="absolute-height"!==
d.mode,k=0,t=e.objectTransformation,q=R.mat4.invert(L.mat4f64.create(),t),m=0;m<c;m++){var l=n[m].geometry;l.invalidateBoundingInfo();for(var h=l.data.getVertexAttr(),l=h[C.VertexAttrConstants.POSITION].data,u=h[C.VertexAttrConstants.SIZE].data,h=h.mapPos.data,z=l.length/3,r=0,g=0,x=!1,p=0,w=0;w<z;w++){K.x=h[g];K.y=h[g+1];K.z=h[g+2];G[0]=l[r];G[1]=l[r+1];G[2]=l[r+2];var v=H.computeElevation(a,K,d,b,f?da:null);f&&(p+=da.terrainElevation);y.vec3.set(E,l[r+0],l[r+1],l[r+2]);y.vec3.transformMat4(E,E,
t);b.setAltitude(v+u[r/3],E);y.vec3.transformMat4(E,E,q);l[r]=E[0];l[r+1]=E[1];l[r+2]=E[2];v=.01/b.unitInMeters;if(Math.abs(G[0]-l[r])>v||Math.abs(G[1]-l[r+1])>v||Math.abs(G[2]-l[r+2])>v)x=!0;g+=3;r+=3}x&&e.geometryVertexAttrsUpdated(m);k+=p/z}return k/c}Object.defineProperty(O,"__esModule",{value:!0});var E=m.vec3f64.create(),u=m.vec3f64.create(),W=[0,2,1],X=[0,1,2],K=ma.makeDehydratedPoint(0,0,0,null),da={verticalDistanceToGround:0,terrainElevation:0};N=function(e){function d(a,b,d,c){return e.call(this,
a,b,d,c)||this}ea(d,e);d.prototype.doLoad=function(){return ga(this,void 0,void 0,function(){var a,b,d,c,f,k;return fa(this,function(e){if(!this._drivenProperties.size&&(a=S.validateSymbolLayerSize(this._getSymbolSize())))throw new ia("graphics3dextrudesymbollayer:invalid-size",a);b=J.get(this.symbolLayer,"material","color");d=this._getCombinedOpacityAndColor(b);c=m.vec3f64.fromArray(d);f=d[3];k={diffuse:c,ambient:c,opacity:f,transparent:1>f||this.needsDrivenTransparentPass,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,
castShadows:this.symbolLayer.castShadows};this._material=new ua(ha({},va.getDefaultPBRMaterialParameters(this._context.physicalBasedRenderingEnabled),k,{offsetTransparentBackfaces:!0}),this._getIdHint("_3dlinemat"));this._context.stage.add(3,this._material);return[2]})})};d.prototype.destroy=function(){e.prototype.destroy.call(this);this._material&&this._context.stage.remove(3,this._material.id)};d.prototype.createGraphics3DGraphic=function(a){var b=a.graphic;if(!this._validateGeometryType(b.geometry,
d.validGeometryTypes,this.symbolLayer.type)||!this._validateGeometry(b.geometry))return null;var e="graphic"+b.uid,c=this._getVertexOpacityAndColor(a.renderingInfo,Float32Array,255),f=this.getGraphicElevationContext(b);return this._createAs3DShape(b,a.renderingInfo,c,f,e,b.uid)};d.prototype.layerOpacityChanged=function(a,b){var d=this,c=J.get(this.symbolLayer,"material","color"),c=this._getCombinedOpacity(c);this._material.setParameterValues({opacity:c,transparent:1>c||this.needsDrivenTransparentPass});
var e=this._getLayerOpacity();a.forEach(function(a){a=b(a);J.isSome(a)&&a.layerOpacityChanged(e,d._context.isAsync)});return!0};d.prototype.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,H.needsElevationUpdates3D)};d.prototype.slicePlaneEnabledChanged=function(a,b){var d=this;this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});a.forEach(function(a){a=b(a);J.isSome(a)&&a.slicePlaneEnabledChanged(d._context.slicePlaneEnabled,
d._context.isAsync)});return!0};d.prototype.physicalBasedRenderingChanged=function(){this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled});return!0};d.prototype.pixelRatioChanged=function(){return!0};d.prototype._getExtrusionSize=function(a){a=a.size&&this._drivenProperties.size?na.getDriverAxisSizeValue(a.size,2):this._getSymbolSize();return a/=this._context.renderCoordsHelper.unitInMeters};d.prototype._getSymbolSize=function(){return this.symbolLayer.size||1};d.prototype._createAs3DShape=
function(a,b,d,c,e,k){var f=H.getGeometryAsPolygon(a.geometry);a=f.rings;var n=[],u=[],l=[],h=Array(6),y=this._context.renderSpatialReference===T.SphericalECEFSpatialReference,z=this._getExtrusionSize(b),r=m.vec3f64.create();y||this._context.renderCoordsHelper.worldUpAtPosition(null,r);b=H.getGeometryVertexData3D(a,f.hasZ,f.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,c,1);this._logGeometryCreationWarnings(b,a,"rings","ExtrudeSymbol3DLayer");
if(0===a.length||!a.some(function(a){return 0<a.length}))return null;var g=S.computeCentroid(f);if(J.isNone(g))return null;a=L.mat4f64.create();T.computeLinearTransformation(f.spatialReference,[g.x,g.y,0],a,this._context.renderSpatialReference);var x=L.mat4f64.create();R.mat4.invert(x,a);var p=la.mat3f64.create();ka.mat3.normalFromMat4(p,x);for(var w=b.geometryData.polygons,v=b.eleVertexData,C=b.vertexData,f=C.length/3,B=new Float64Array(18*f),D=new Float64Array(18*f),E=new Float64Array(18*f),G=new Float64Array(6*
f),I=0,f=function(a){var b=w[a],c=b.count,f=b.index;if(F._context.clippingExtent&&(H.computeBoundingBox(v,f,c,h),H.boundingBoxClipped(h,F._context.clippingExtent)))return"continue";var g=new Float64Array(v.buffer,3*f*B.BYTES_PER_ELEMENT,3*c),k=b.holeIndices.map(function(a){return a-f}),g=ja(g,k,3);if(0===g.length)return"continue";var k=new Uint32Array(6*c+2*g.length),m=6*c,q=3*B.BYTES_PER_ELEMENT,q=new U.BufferViewVec3f64(B.buffer,I*q,q,(I+m)*q),t=3*D.BYTES_PER_ELEMENT,t=new U.BufferViewVec3f64(D.buffer,
I*t,t,(I+m)*t),A=new Float64Array(E.buffer,3*I*E.BYTES_PER_ELEMENT,3*m),m=new Float64Array(G.buffer,1*I*G.BYTES_PER_ELEMENT,1*m);wa(C,v,g,b,q.typedBuffer,A,t.typedBuffer,m,0,k,0,z,r,y);V.transformMat4(q,q,x);V.transformMat3(t,t,p);I+=6*c;b=F._createExtrudeGeometry(k,{positions:q.typedBuffer,elevation:A,normals:t.typedBuffer,heights:m},d);a=new ra(b,e+"path"+a);a.singleUse=!0;n.push(a);u.push(F._material);l.push(L.mat4f64.create())},F=this,g=0;g<w.length;++g)f(g);if(0===n.length)return null;k=new ta({geometries:n,
materials:u,transformations:l,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:k,isElevationSource:!0},idHint:e});k.objectTransformation=a;a=this._createEdgeMaterial();a=J.isSome(a)?{baseMaterial:this._material,edgeMaterials:[a],slicePlaneEnabled:this._context.slicePlaneEnabled}:null;k=new oa(this,k,n,null,null,xa,c,a);k.alignedTerrainElevation=b.terrainElevation;k.needsElevationUpdates=H.needsElevationUpdates3D(c.mode);return k};d.prototype._createExtrudeGeometry=function(a,b,
d){for(var c=a.length,f=new Uint32Array(c),e=0;e<c;e++)f[e]=0;c={};e={};c[C.VertexAttrConstants.POSITION]=a;c[C.VertexAttrConstants.NORMAL]=a;c[C.VertexAttrConstants.COLOR]=f;e[C.VertexAttrConstants.POSITION]={size:3,data:b.positions};e[C.VertexAttrConstants.NORMAL]={size:3,data:b.normals};e[C.VertexAttrConstants.COLOR]={size:4,data:d};e[C.VertexAttrConstants.SIZE]={size:1,data:b.heights};b.elevation&&(e.mapPos={size:3,data:b.elevation},c.mapPos=a);return new sa.GeometryData(e,c)};d.prototype._createEdgeMaterial=
function(){var a={opacity:this._getLayerOpacity()};return qa.createMaterial(this.symbolLayer,a)};d.validGeometryTypes=["polygon","extent"];return d}(pa.default);O.Graphics3DExtrudeSymbolLayer=N;var F=m.vec3f64.create(),Q=m.vec3f64.create(),Z=m.vec3f64.create(),aa=m.vec3f64.create(),ba=m.vec3f64.create(),ca=m.vec3f64.create(),G=m.vec3f64.create();O.default=N});