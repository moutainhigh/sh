// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/Accessor ../../../../core/asyncUtils ../../../../core/Handles ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators ../../../../layers/graphics/dehydratedFeatures ../../../../layers/support/labelFormatUtils ../../../../layers/support/layerUtils ../../../../symbols/callouts/calloutUtils ./Graphics3DCalloutSymbolLayerFactory ./graphicSymbolUtils ./labelPlacement ../../support/debugFlags ../../webgl-engine/lib/Layer ../../webgl-engine/lib/MaterialCollection ../../webgl-engine/lib/TextRenderer ../../webgl-engine/lib/TextRenderParameters ../../webgl-engine/lib/TextTextureAtlas ../../../support/index".split(" "),
function(y,z,C,p,q,t,D,A,E,v,h,r,F,G,w,H,I,J,K,L,M,B,N,O,P,Q){Object.defineProperty(z,"__esModule",{value:!0});y=function(x){function b(){var a=null!==x&&x.apply(this,arguments)||this;a.idHint="__labeler";a._dirty=!1;a.labels=new Map;a.labelsToAdd=new Map;a.labelsToRemove=new Map;a.labelingContexts=[];return a}C(b,x);b.prototype.setup=function(){var a=this;this.handles||(this.handles=new E,this.handles.add([this.view.watch("state.camera",function(){return a.setDirty()}),this.view.watch("pixelRatio",
function(){return a.resetAllLabels()})]));this.textTextureAtlas||(this.textTextureAtlas=new P.default({idHint:this.idHint+"_atlas",view:this.view}),this.hudMaterialCollection=new B(this.view._stage),this.calloutMaterialCollection=new B(this.view._stage));this.handles.add(this.view.resourceController.scheduler.registerTask(Q.Task.LABELER,function(c){return a.update(c)},function(){return a.needsUpdate()}))};b.prototype.dispose=function(){this.handles&&(this.handles.destroy(),this.handles=null);this.textTextureAtlas&&
(this.textTextureAtlas.dispose(),this.textTextureAtlas=null);this.hudMaterialCollection&&(this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null);this.calloutMaterialCollection&&(this.calloutMaterialCollection.dispose(),this.calloutMaterialCollection=null);this.labelingContexts=[];this.labels.clear();this.labelsToAdd.clear();this.labelsToRemove.clear()};b.prototype.isActiveLabelingContext=function(a){return a.active&&w.areLabelsVisible(a.layer)};b.prototype.activateLabelingContext=function(a){var c=
this;a.labels.forEach(function(a,e){c.labels.set(e,a);a.graphics3DGraphic.setVisibilityFlag(0,!0,1)});a.active=!0};b.prototype.deactivateLabelingContext=function(a){var c=this;a.labels.forEach(function(a,e){a.graphics3DGraphic.setVisibilityFlag(0,!1,1);a.rendered&&c.labelsToRemove.set(e,a);c.labels.delete(e);c.labelsToAdd.delete(e)});a.active=!1};b.prototype.addLabelTextureToAtlas=function(a){for(var c=0;c<a.graphics3DGraphic._labelGraphics.length;c++){var d=a.graphics3DGraphic._labelGraphics[c];
if(d._labelClass){var e=a.textRenderers[d._labelIndex];e&&this.textTextureAtlas.addTextTexture(e,d.stageObject)}}a.rendered=!0};b.prototype.removeLabelTextureFromAtlas=function(a){for(var c=a.graphics3DGraphic,d=0;d<c._labelGraphics.length;d++){var e=c._labelGraphics[d];e._labelClass&&(e=a.textRenderers[e._labelIndex])&&this.textTextureAtlas.removeTextTexture(e,c._labelGraphics[d].stageObject)}a.rendered=!1};b.prototype.needsUpdate=function(){return this.view.ready&&this.isDirty};b.prototype.update=
function(a){for(var c=this,d=this._dirty=!1,e=function(e){if(!b.isActiveLabelingContext(e))return"continue";if(!b.hasValidLabelClassContext(e)){if(b.hasInvalidLabelClassContext(e))return b.deactivateLabelingContext(e),"continue";b.createLabelClassContext(e);if(b.hasPendingLabelClassContext(e))return b._dirty=!0,"continue";if(!b.hasValidLabelClassContext(e))return"continue"}e.labelsToInitialize.forEach(function(b,f){c.ensureGraphics3DResources(b)&&(c.labels.set(f,b),d=!0);(b.visible&&b.hasTextTextureResources||
!b.visible&&b.hasGraphics3DResources)&&e.labelsToInitialize.delete(f);a&&(a.madeProgress(),a.done&&(c._dirty=!0))})},b=this,g=0,k=this.labelingContexts;g<k.length;g++)e(k[g]);a&&d&&this.view.deconflictor.setDirty();this.labelsToRemove.forEach(function(a){return c.removeLabelTextureFromAtlas(a)});this.labelsToRemove.clear();this.labelsToAdd.forEach(function(a){return c.addLabelTextureToAtlas(a)});this.labelsToAdd.clear();this._dirty||this.notifyChange("updating")};b.prototype.hasPendingLabelClassContext=
function(a){return a.labelClassPromise&&!!a.labelClassAbortController};b.prototype.hasValidLabelClassContext=function(a){return a.labelClassContexts&&a.labelClassContexts.length};b.prototype.hasInvalidLabelClassContext=function(a){return null===a.labelClassContexts};b.prototype.createLabelClassContextAsync=function(a){return t(this,void 0,void 0,function(){var c,d,e,b,g,k=this;return q(this,function(f){switch(f.label){case 0:return c=a.labelClassAbortController.signal,[4,a.layer.when()];case 1:f.sent();
h.throwIfAborted(c);a.scaleVisibility&&a.scaleVisibility.updateScaleRangeActive();d=a.graphics3DCore;e=d.layer;b=e.labelingInfo&&e.labelingInfo.filter(function(a){return!!a.symbol});if(!b||0===b.length)return[2,null];g=Array(b.length);return[4,A.forEach(b,function(e,b){return t(k,void 0,void 0,function(){var f,u,k,n;return q(this,function(l){switch(l.label){case 0:return f=e.symbol,u=J.getGraphics3DSymbol(d.getOrCreateGraphics3DSymbol(f)),[4,u.load()];case 1:l.sent();h.throwIfAborted(c);k=null;if(!H.isCalloutSupport(f)||
!f.hasVisibleCallout())return[3,3];k=I.make(f,d.symbolCreationContext);return[4,k.load()];case 2:l.sent(),h.throwIfAborted(c),l.label=3;case 3:return[4,A.result(G.createLabelFunction(e,a.layer.fields.map(function(a){return a.toJSON()}),this.view.spatialReference))];case 4:return n=l.sent(),h.throwIfAborted(c),!0===n.ok&&(g[b]={labelClass:e,labelFunction:n.value,graphics3DSymbol:u,graphics3DCalloutSymbolLayer:k,calloutSymbolLayerIndex:0,textRenderParameters:this.createTextRenderParameters(u.symbol)}),
[2]}})})})];case 2:return f.sent(),h.throwIfAborted(c),a.labelClassContexts=g,[2]}})})};b.prototype.createLabelClassContext=function(a){return t(this,void 0,void 0,function(){var c=this;return q(this,function(d){a.labelClassPromise||(a.labelClassPromise=this.createLabelClassContextAsync(a).catch(function(c){if(h.isAbortError(c))throw c;a.labelClassContexts=null}).then(function(){a.labelClassAbortController=null;c.notifyChange("updating")}),this.notifyChange("updating"));return[2,a.labelClassPromise]})})};
b.prototype.createTextRenderParameters=function(a){return(a=a.symbolLayers.getItemAt(0))&&"text"===a.type?O.default.fromSymbol(a,this.view.pixelRatio):null};b.prototype.destroyLabelClassContext=function(a){for(var c=0,d=a.labelClassContexts;c<d.length;c++){var e=d[c];--e.graphics3DSymbol.referenced;e.graphics3DSymbol=null}c=a.labelClassAbortController;a.labelClassAbortController=h.createAbortController();c&&c.abort();a.labelClassContexts=[];a.labelClassPromise=null;this.notifyChange("updating")};
b.prototype.createTextSymbolGraphic=function(a,c,d,e,b){a={text:a.text,centerOffset:d.centerOffset,translation:d.translation,elevationOffset:d.elevationOffset,screenOffset:d.screenOffset,anchor:d.anchor,centerOffsetUnits:d.centerOffsetUnits,verticalOffset:d.verticalOffset,debugDrawBorder:L.LABELS_SHOW_BORDER,displayWidth:a.displayWidth,displayHeight:a.displayHeight};m.graphic=c;m.renderingInfo=null;m.layer=e;return b.createLabel(m,a,this.hudMaterialCollection,this.textTextureAtlas)};b.prototype.createLineCalloutGraphic=
function(a,c,d,e,b){c={symbol:c,translation:e.translation,elevationOffset:e.elevationOffset,screenOffset:e.screenOffset,centerOffset:e.centerOffset,centerOffsetUnits:e.centerOffsetUnits,materialCollection:this.calloutMaterialCollection};m.graphic=a;m.renderingInfo=c;m.layer=b;return d.createGraphics3DGraphic(m)};b.prototype.ensureGraphics3DResources=function(a){var c=a.graphics3DGraphic;if(c.destroyed||a.hasGraphics3DResources)return!1;this.ensureTextTextureResources(a);var d=a.labelingContext,e=
!1,b=c.graphic,g=d.labelClassContexts,k=d.layer,f=w.areLabelsVisible(d.layer);if(!g||0===g.length||!d.emptySymbolLabelSupported&&0===c._graphics.length)return!1;for(var n=0;n<g.length;n++){var h=g[n],m=h.labelClass,r=a.textRenderers[n];if(r){var l=h.graphics3DSymbol,p=null;l.symbol&&"label-3d"===l.symbol.type&&(p=l.symbol);var q=l.symbolLayers[0],l=K.get({graphics3DGraphic:c,labelSymbol:p,labelClass:h.labelClass,disablePlacement:d.disablePlacement});if(q&&!v.isNone(l)){q.setElevationInfoOverride(d.elevationInfoOverride);
if(e=this.createTextSymbolGraphic(r,b,l,k,q)){if(e._labelClass=m,e._labelIndex=n,c.addLabelGraphic(e,d.stageLayer,this.view._stage),c.setVisibilityFlag(0,f,1),c.clearVisibilityFlag(1,1),c.setVisibilityFlag(3,!1,1),e=!0,h.graphics3DCalloutSymbolLayer&&l.hasLabelVerticalOffset&&(b=this.createLineCalloutGraphic(b,p,h.graphics3DCalloutSymbolLayer,l,k)))h.calloutSymbolLayerIndex=c._labelGraphics.length,c.addLabelGraphic(b,d.stageLayer,this.view._stage)}else return!1;break}}}d.scaleVisibility&&e&&d.scaleVisibility.updateGraphicLabelScaleVisibility(c);
return a.hasGraphics3DResources=!0};b.prototype.destroyGraphics3DResources=function(a){for(var c=a.labelingContext.labelClassContexts,d=0,e=a.graphics3DGraphic._labelGraphics;d<e.length;d++){var b=e[d];if(null!=b._labelClass){var g=c[b._labelIndex].graphics3DSymbol.symbolLayers[0];if(null!=g)g.onRemoveGraphic(b)}}a.graphics3DGraphic.clearLabelGraphics();a.hasGraphics3DResources=!1};b.prototype.ensureTextTextureResources=function(a){if(!a.hasTextTextureResources){var c=a.labelingContext,d=c.labelClassContexts,
e=a.graphics3DGraphic.graphic;if(d&&0!==d.length){for(var b=0;b<d.length;b++){var g=d[b];a.textRenderers[b]=null;if(g.textRenderParameters){var k=g.labelFunction,f=void 0;if("arcade"===k.type){var n=F.hydrateGraphic(e,c.layer);try{f=k.evaluate(n)}catch(R){f=null}}else f=k.evaluate(e);v.isNone(f)||""===f||(a.textRenderers[b]=new N.default(f,g.textRenderParameters))}}a.hasTextTextureResources=!0}}};b.prototype.destroyTextTextureResources=function(a){a.textRenderers=[];a.hasTextTextureResources=!1};
b.prototype.addGraphic=function(a,c){var d={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:a,graphics3DGraphic:c,textRenderers:[]};c=c.graphic.uid;a.labels.set(c,d);this.isActiveLabelingContext(a)&&this.hasValidLabelClassContext(a)&&this.ensureGraphics3DResources(d)?this.labels.set(c,d):a.labelsToInitialize.set(c,d);this.setDirty(a.graphics3DCore.asyncUpdates);this.view.deconflictor.setDirty()};b.prototype.removeGraphic=function(a,c){c=c.graphic.uid;var d=
a.labels.get(c);d&&(this.destroyGraphic(d,c),a.labels.delete(c),a.labelsToInitialize.delete(c),this.setDirty(a.graphics3DCore.asyncUpdates),this.view.deconflictor.setDirty())};b.prototype.destroyGraphic=function(a,c){this.labels.has(c)&&(this.labels.delete(c),this.labelsToAdd.delete(c),this.labelsToRemove.delete(c));a.hasTextTextureResources&&(this.removeLabelTextureFromAtlas(a),this.destroyTextTextureResources(a));a.hasGraphics3DResources&&this.destroyGraphics3DResources(a)};b.prototype.labelingInfoChange=
function(a,c){return t(this,void 0,void 0,function(){var d,b,h,g;return q(this,function(e){if(c){d=0;for(b=c;d<b.length;d++)if(h=b[d],g=a.labels.get(h))this.removeGraphic(a,g.graphics3DGraphic),this.addGraphic(a,g.graphics3DGraphic);return[2]}this.visibilityInfoChange(a);this.resetLabels(a);return[2,this.createLabelClassContext(a)]})})};b.prototype.globalPropertyChanged=function(a,c){for(var d=function(d){var b=new Map;c.labels.forEach(function(a){a=a.graphics3DGraphic;b.set(a.graphic.uid,a)});v.expect(d.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(a,
b,function(a){return a._labelGraphics[0]});d.graphics3DCalloutSymbolLayer&&d.graphics3DCalloutSymbolLayer.globalPropertyChanged(a,b,function(a){return a._labelGraphics[d.calloutSymbolLayerIndex]})},b=0,h=c.labelClassContexts;b<h.length;b++)d(h[b])};b.prototype.visibilityInfoChange=function(a){var c=a.layer.labelsVisible;c&&!a.active&&this.activateLabelingContext(a);!c&&a.active&&this.deactivateLabelingContext(a);this.setDirty(a.graphics3DCore.asyncUpdates)};b.prototype.resetAllLabels=function(){for(var a=
0,c=this.labelingContexts;a<c.length;a++)this.resetLabels(c[a])};b.prototype.resetLabels=function(a){var c=this;a.labels.forEach(function(d,b){c.destroyGraphic(d,b);d.visible=!1;d.rendered=!1;a.labelsToInitialize.set(b,d)});this.destroyLabelClassContext(a);this.setDirty(a.graphics3DCore.asyncUpdates);this.view.deconflictor.setDirty()};b.prototype.findLabelingContext=function(a){for(var c=0,d=this.labelingContexts;c<d.length;c++){var b=d[c];if(b.graphics3DCore===a)return b}return null};b.prototype.addGraphicsOwner=
function(a,c,b){var d=this,m=b&&b.emptySymbolLabelSupported||!1,g=b&&b.elevationInfoOverride||null;b=b&&b.disablePlacement||null;if(!this.findLabelingContext(a)){var k=a.layer,f={graphics3DCore:a,layer:k,scaleVisibility:c,emptySymbolLabelSupported:m,elevationInfoOverride:g,disablePlacement:b,active:a.layer.labelsVisible,labelClassPromise:null,labelClassAbortController:h.createAbortController(),labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new M(this.idHint+"_"+k.uid,{isPickable:!0},
k.uid)};this.view._stage.add(0,f.stageLayer);this.view._stage.addToViewContent([f.stageLayer.id]);this.labelingContexts.push(f);this.setDirty();return{addGraphic:function(a){return d.addGraphic(f,a)},removeGraphic:function(a){return d.removeGraphic(f,a)},featureReductionChange:function(){},layerLabelsEnabled:function(){return w.areLabelsVisible(f.layer)},labelingInfoChange:function(a){return d.labelingInfoChange(f,a)},elevationInfoChange:function(){return d.globalPropertyChanged("elevationInfo",f)},
slicePlaneEnabledChange:function(){return d.globalPropertyChanged("slicePlaneEnabled",f)},visibilityInfoChange:function(){return d.visibilityInfoChange(f)},reset:function(){return d.resetLabels(f)},clear:function(){},processStageDirty:function(){return d.view._stage.processDirtyLayer(f.stageLayer.id)}}}};b.prototype.removeGraphicsOwner=function(a){var b=this,d=this.findLabelingContext(a);d&&(a=this.labelingContexts.indexOf(d),this.labelingContexts.splice(a,1),d.labels.forEach(function(a){return b.removeGraphic(d,
a.graphics3DGraphic)}),a=d.stageLayer.id,this.view._stage.removeFromViewContent([a]),this.view._stage.remove(0,a),d.stageLayer=null,this.setDirty())};b.prototype.setLabelGraphicVisibility=function(a,b){a=a.graphic.uid;var c=this.labels.get(a);c&&(b&&!c.rendered?(this.labelsToAdd.set(a,c),this.labelsToRemove.delete(a),c.hasTextTextureResources||c.labelingContext.labelsToInitialize.set(a,c)):!b&&c.rendered&&(this.labelsToRemove.set(a,c),this.labelsToAdd.delete(a)),c.visible=b,this.setDirty(c.labelingContext.graphics3DCore.asyncUpdates))};
Object.defineProperty(b.prototype,"isDirty",{get:function(){return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.isDirty},enumerable:!0,configurable:!0});b.prototype.setDirty=function(a){void 0===a&&(a=!0);var b=this._dirty;this._dirty||(this._dirty=!0);a||this.update(null);b!==this._dirty&&this.notifyChange("updating")};Object.defineProperty(b.prototype,"updating",{get:function(){var a=this;return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.updating||this.labelingContexts.some(function(b){return a.hasPendingLabelClassContext(b)})},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"test",{get:function(){return{textTextureAtlas:this.textTextureAtlas}},enumerable:!0,configurable:!0});p([r.property({constructOnly:!0})],b.prototype,"view",void 0);p([r.property()],b.prototype,"textTextureAtlas",void 0);p([r.property({type:Boolean,readOnly:!0,dependsOn:["textTextureAtlas.updating"]})],b.prototype,"updating",null);return b=p([r.subclass("esri.views.3d.layers.graphics.Labeler")],b)}(r.declared(D));z.Labeler=y;var m=
{graphic:null,renderingInfo:null,layer:null}});