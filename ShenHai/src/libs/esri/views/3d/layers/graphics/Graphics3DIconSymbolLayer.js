// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../Color ../../../../symbols ../../../../core/asyncUtils ../../../../core/compilerUtils ../../../../core/Error ../../../../core/has ../../../../core/lang ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/urlUtils ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../support/arcadeOnDemand ../../../../symbols/cim/CIMSymbolRasterizer ../../../../symbols/support/IconSymbol3DLayerResource ../../../../symbols/support/utils ../../../2d/arcade/utils ./constants ./ElevationAligners ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ./sdfPrimitives ../support/FastSymbolUpdates ../../support/projectionUtils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/Texture ../../webgl-engine/materials/HUDMaterial".split(" "),
function(r,z,F,N,A,B,O,P,Q,G,C,R,S,n,H,v,I,T,D,t,U,V,W,X,Y,Z,aa,ba,ca,da,l,ea,w,u,x,fa,ga,J,ha,K,y){function E(l){return n.isSome(l)?"cross"===l||"x"===l:!1}Object.defineProperty(z,"__esModule",{value:!0});var L=T.mat4f64.create(),M=t.vec3f64.fromValues(0,0,1),ia=[.25,.25,.75,.75],ja=[64,64];r=function(r){function c(a,b,d,e){a=r.call(this,a,b,d,e)||this;a._cimLayers=null;a._cimSymbolMaterials=new Map;a._cimSymbolDrapedMaterials=new Map;a._cimSymbolTextures=new Map;a._cimMaterialParametersInfo=null;
a._cimRequiredFields=null;a._cimScaleFactorOrFunction=null;a._size=null;a._symbolTextureRatio=1;a._outlineSize=0;a._texture=null;a._drapedMaterial=null;a._releaseTexture=null;a._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0};return a}N(c,r);c.prototype.getCachedSize=function(){return{size:this._getIconSize()}};c.prototype.doLoad=function(a){return B(this,void 0,void 0,function(){var b,d,e,f;return A(this,function(c){switch(c.label){case 0:this._validateOrThrow();b=this._prepareMaterialParameters();
d=this._getPrimitive();if(!n.isSome(d))return[3,1];this._prepareResourcesPrimitive(b,d);return[3,5];case 1:return e=Y.getIconHref(this.symbol,this.symbolLayer),(f=I.dataComponents(e))&&"application/json"===f.mediaType?[4,this._prepareResourcesCIM(b,JSON.parse(f.data),a)]:[3,3];case 2:return c.sent(),[3,5];case 3:return[4,this._prepareResourcesHref(b,e,a)];case 4:c.sent(),c.label=5;case 5:return[2]}})})};c.prototype._validateOrThrow=function(){if(!this._drivenProperties.size){var a=w.validateSymbolLayerSize(this._getIconSize());
if(a)throw new C("graphics3diconsymbollayer:invalid-size",a);}};c.prototype._getIconSize=function(){var a=this.symbolLayer,a=Math.round(null!=a.size?v.pt2px(a.size):16);return this._drivenProperties.size?Math.max(a,64):a};c.prototype._generateTextureCIM=function(a){var b=this._getGraphicHash(a),d=""===b?null:this._cimSymbolTextures.get(b);d||(a=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,a,{scaleFactor:this._cimScaleFactorOrFunction}),this._cimMaterialParametersInfo.anchorPos=
this._getAnchorPos("relative",a.anchorPosition),d=new K(a.imageData,"symbol",{width:a.imageData.width,height:a.imageData.height,powerOfTwoResizeMode:2}),this._cimSymbolTextures.set(b,d),this._context.stage.add(4,d));return d};c.prototype._computeSize=function(a,b){a=a.width/a.height;return 1<a?[b,Math.round(b/a)]:[Math.round(b*a),b]};c.prototype._prepareMaterialParameters=function(){var a={anchorPos:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},b=this.symbol;if(b&&"point-3d"===
b.type&&b.hasVisibleVerticalOffset()){var b=b.verticalOffset,d=b.minWorldLength,e=b.maxWorldLength;a.verticalOffset={screenLength:v.pt2px(b.screenLength),minWorldLength:d||0,maxWorldLength:null!=e?e:Infinity}}this._context.screenSizePerspectiveEnabled&&(a.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);return a};c.prototype._prepareResourcesPrimitive=function(a,b){var d=this,e=this._getOutlineSize();if(E(b)&&0===e)throw Error("Nothing to render");this._outlineSize=
e;a.color=this._getFillColor();a.outlineColor=this._getOutlineColor();a.outlineSize=this._outlineSize;var f=this._context.sharedResources.textures.fromData(b,function(){var a;switch(b){case "circle":a=u.createCircle(128,64);break;case "square":a=u.createSquare(128,64);break;case "kite":a=u.createKite(128,64);break;case "cross":a=u.createCross(128,64);break;case "x":a=u.createX(128,64);break;case "triangle":a=u.createTriangle(128,64);break;default:G.neverReached(b)}return new K(a,"sdf_"+b,{mipmap:!1,
wrap:{s:33071,t:33071},width:128,height:128,components:4,noUnpackFlip:!0})});this._texture=f.texture;this._releaseTexture=function(){return d._context.sharedResources.textures.release(f.uid)};a.textureIsSignedDistanceField=!0;a.distanceFieldBoundingBox=ia;a.textureId=this._texture.id;e=this._getIconSize();this._size=[e,e];this._symbolTextureRatio=2;this._createMaterialsAndAddToStage(a,this._context.stage)};c.prototype._prepareResourcesHref=function(a,b,d){return B(this,void 0,void 0,function(){var e,
f,c,g,q,p,m,h,l=this;return A(this,function(k){switch(k.label){case 0:if(!R("esri-canvas-svg-support")&&I.isSVG(b))throw e="IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)",new C("graphics3diconsymbollayer:unsupported-image-format",e);this._outlineSize=this._getOutlineSize();a.color=this._getFillColor();a.outlineColor=this._getOutlineColor();a.outlineSize=this._outlineSize;a.textureIsSignedDistanceField=!1;f=this._getIconSize();c=f*this._context.layerView.view.pixelRatio;
return[4,Q.result(this._context.sharedResources.textures.fromUrl(b,c,{signal:d}))];case 1:g=k.sent();if(!1===g.ok)throw H.throwIfAbortError(g.error),e="Failed to load (Request for icon resource failed: "+b+")",new C("graphics3diconsymbollayer:request-failed",e);q=g.value;p=q.uid;m=q.texture;this._releaseTexture=function(){return l._context.sharedResources.textures.release(p)};h=m.params;this._size=this._computeSize(h,f);a.textureId=m.id;this._createMaterialsAndAddToStage(a,this._context.stage);return[2]}})})};
c.prototype._prepareResourcesCIM=function(a,b,d){return B(this,void 0,void 0,function(){var e,c,k,g,q,p,m,h,l,n,r;return A(this,function(f){switch(f.label){case 0:return e=new P.CIMSymbol({data:b}),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new W(this._context.renderSpatialReference,!0)),c=this._context.layer.fields?this._context.layer.fields.map(function(a){return a.toJSON()}):null,k=this,[4,this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(e,
c,this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:d})];case 1:k._cimLayers=f.sent();if(!this._context.renderer||"dictionary"!==this._context.renderer.type||!this._context.renderer.scaleExpression)return[3,4];p=this._context.renderer;if(!isNaN(p.scaleExpression))return[3,3];m=p.scaleExpression;return[4,V.createRendererExpression(m,this._context.layer.spatialReference,c)];case 2:return h=f.sent(),q=function(a,b,d){a=
Z.callWithFeature(h,a,{$view:d},"esriGeometryPoint",b);return null!==a?a:1},[3,4];case 3:g=Number(p.scaleExpression),f.label=4;case 4:this._cimScaleFactorOrFunction=g||q||1;if(this._context.renderer)return[3,5];n=[];return[3,7];case 5:return[4,this._context.renderer.getRequiredFields(this._context.layer.fields)];case 6:n=f.sent(),f.label=7;case 7:return l=n,H.throwIfAborted(d),r=this._context.layer.fieldsIndex,this._cimRequiredFields=l.map(function(a){return r.get(a).name}),this._cimMaterialParametersInfo=
a,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1,[2]}})})};c.prototype._getPrimitive=function(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||X.defaultPrimitive};c.prototype._getOutlineSize=function(){var a=0,a=this.symbolLayer;if(n.isSome(a.outline)&&
null!=a.outline.size)return Math.max(v.pt2px(a.outline.size),0);a=this._getPrimitive();a=E(a)?1.5:0;return Math.max(a,0)};c.prototype._getOutlineColor=function(){var a=this._getLayerOpacity(),b=n.get(this.symbolLayer,"outline","color");if(n.isSome(b)){var d=O.toUnitRGB(b);return[d[0],d[1],d[2],b.a*a]}return[0,0,0,0]};c.prototype._getFillColor=function(){if(E(this._getPrimitive()))return aa.TRANSPARENT;var a=n.isNone(this._getPrimitive()),b=n.get(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(b,
{hasIntrinsicColor:a})};c.prototype._getAnchorPos=function(a,b){return"relative"===a?D.vec2f64.fromValues((b.x||0)+.5,-(b.y||0)+.5):a in w.namedAnchorToHUDMaterialAnchorPos?w.namedAnchorToHUDMaterialAnchorPos[a]:w.namedAnchorToHUDMaterialAnchorPos.center};c.prototype._createMaterialsAndAddToStage=function(a,b){this._fastUpdates=this._cimLayers?{enabled:!1}:x.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions());this._fastUpdates.enabled&&S.mixin(a,this._fastUpdates.materialParameters);
var d=F({},a);d.verticalOffset=null;d.screenSizePerspective=null;d.occlusionTest=!1;d.slicePlaneEnabled=!1;d.shaderPolygonOffset=0;a.occlusionTest=!0;a.slicePlaneEnabled=this._context.slicePlaneEnabled;if(this._cimLayers){var e=this._cimSymbolMaterials.get(a.textureId),c=this._cimSymbolDrapedMaterials.get(a.textureId);c||(c=new y(d,this._getIdHint("_iconDraped")),this._cimSymbolDrapedMaterials.set(a.textureId,c),b.add(3,c));e||(e=new y(a,this._getIdHint("_icon")),this._cimSymbolMaterials.set(a.textureId,
e),b.add(3,e));return[e,c]}this._drapedMaterial=new y(d,this._getIdHint("_iconDraped"));b.add(3,this._drapedMaterial);this._material=new y(a,this._getIdHint("_icon"));b.add(3,this._material);return[this._material,this._drapedMaterial]};c.prototype.destroy=function(){var a=this;r.prototype.destroy.call(this);this._forEachMaterial(0,function(b){a._context.stage.remove(3,b.id)});this._material&&(this._material=null);this._cimSymbolMaterials.clear();this._drapedMaterial&&(this._drapedMaterial=null);this._cimSymbolDrapedMaterials.clear();
this._cimSymbolTextures.forEach(function(b){a._context.stage.remove(4,b.id)});this._cimSymbolTextures.clear();this._releaseTexture&&(this._releaseTexture(),this._releaseTexture=null)};c.prototype._getScaleFactor=function(a,b){if(this._drivenProperties.size&&a.size){for(var d=0;3>d;d++){var e=a.size[d];e&&"symbolValue"!==e&&"proportional"!==e&&(a.size[d]=v.pt2px(e))}if("symbolValue"===a.size[0])return 1;if(isFinite(+a.size[0]))return+a.size[0]/b;if(isFinite(+a.size[2]))return+a.size[2]/b}return 1};
c.prototype.createGraphics3DGraphic=function(a){var b,d=a.renderingInfo,e=a.graphic,c,k;if(this._cimLayers){var g=this._generateTextureCIM(e);k=F({textureId:g.id},this._cimMaterialParametersInfo);b=this._createMaterialsAndAddToStage(k,this._context.stage);k=b[0];b=b[1];c=[g.params.width,g.params.height]}else c=this._size,k=this._material,b=this._drapedMaterial;if(!this._validateGeometry(e.geometry))return null;g=l.placePointOnGeometry(e.geometry);if(n.isNone(g))return this.logger.warn("unsupported geometry type for icon symbol: "+
e.geometry.type),null;var q="graphic"+e.uid,p=this._getVertexOpacityAndColor(d),m=1;this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||(m=this._getScaleFactor(d,c[0]>c[1]?c[0]:c[1]));m*=this._symbolTextureRatio;d=[c[0]*m,c[1]*m];c=this.getGraphicElevationContext(e);return"on-the-ground"===c.mode?this._createAsOverlay(e,g,b,p,d,q,a.layer.uid):this._createAs3DShape(e,g,k,p,d,c,q,e.uid)};c.prototype.layerOpacityChanged=function(){var a=this._getFillColor(),b=this._getOutlineColor();this._forEachMaterial(0,
function(d){d.setParameterValues({color:a});d.setParameterValues({outlineColor:b})});return!0};c.prototype.layerElevationInfoChanged=function(a,b,d){var e=this._elevationContext.mode;d=l.elevationModeChangeUpdateType(c.elevationModeChangeTypes,d,e);if(d!==l.SymbolUpdateType.UPDATE)return d;var f=l.needsElevationUpdates2D(e)||"absolute-height"===e;return this.updateGraphics3DGraphicElevationInfo(a,b,function(){return f})};c.prototype.slicePlaneEnabledChanged=function(){var a=this;this._forEachMaterial(1,
function(b){b.setParameterValues({slicePlaneEnabled:a._context.slicePlaneEnabled})});return!0};c.prototype.physicalBasedRenderingChanged=function(){return!0};c.prototype.pixelRatioChanged=function(){return this._getPrimitive()?!0:!1};c.prototype.applyRendererDiff=function(a,b){for(var d in a.diff)switch(d){case "visualVariables":if(x.updateFastSymbolUpdatesState(this._fastUpdates,b,this._fastVisualVariableConvertOptions()))this._material&&this._material.setParameterValues(this._fastUpdates.materialParameters),
this._drapedMaterial&&this._drapedMaterial.setParameterValues(this._fastUpdates.materialParameters);else return!1;break;default:return!1}return!0};c.prototype.setDrawOrder=function(a,b,d){this.updateSymbolLayerOrder(a,b);this._forEachMaterial(2,function(b){b.renderPriority=a;d.add(b.id)})};c.prototype._defaultElevationInfoNoZ=function(){return ka};c.prototype._createAs3DShape=function(a,b,d,c,f,k,g,q){var e=this,m=this.getFastUpdateAttrValues(a);a=m?function(a){return x.evaluateModelTransform(e._fastUpdates.materialParameters,
m,a)}:null;c=J.createPointGeometry(M,null,c,f,la,null,m);c=[new ga(c,g)];g=l.createStageObjectForPoint(this._context,b,c,[d],null,null,k,g,this._context.layer.uid,q,!0,a);if(null===g)return null;var h=new da(this,g.object,c,null,null,ba.perObjectElevationAligner,k);h.alignedTerrainElevation=g.terrainElevation;h.needsElevationUpdates=l.needsElevationUpdates2D(k.mode)||"absolute-height"===k.mode;h.getScreenSize=this._createScreenSizeGetter(f,a);h.calculateRelativeScreenBounds=function(a){return d.calculateRelativeScreenBounds(h.getScreenSize(),
1,a)};l.extendPointGraphicElevationContext(h,b,this._context.elevationProvider);return h};c.prototype._createAsOverlay=function(a,b,d,c,f,k,g){var e=this;d.renderPriority=this._symbolLayerOrder;var p=t.vec3f64.create();fa.pointToVector(b,p,this._context.overlaySR);p[2]=this._getDrapedZ();if((b=this._context.clippingExtent)&&!l.pointInBox2D(p,b))return null;var m=this.getFastUpdateAttrValues(a);b=m?function(a){return x.evaluateModelTransform(e._fastUpdates.materialParameters,m,a)}:null;c=J.createPointGeometry(M,
p,c,f,null,null,m);var h=new ha(c);h.material=d;h.center=p;h.bsRadius=0;h.transformation=L;h.name=k;h.uniqueName=k+"#"+c.id;h.data.layerUid=g;h.data.graphicUid=a.uid;h.calculateShaderTransformation=b;var n=new ca(this,[h],null);n.getScreenSize=this._createScreenSizeGetter(f,b);n.calculateRelativeScreenBounds=function(a){return d.calculateRelativeScreenBounds(n.getScreenSize(),1,a)};return n};c.prototype._createScreenSizeGetter=function(a,b){var c=this._outlineSize+2;if(this._fastUpdates.enabled){var e=
a[0]/this._symbolTextureRatio,f=a[1]/this._symbolTextureRatio;return function(a){void 0===a&&(a=D.vec2f64.create());var d=b(L);a[0]=d[0]*e+c;a[1]=d[5]*f+c;return a}}var k=a[0]/this._symbolTextureRatio+c,g=a[1]/this._symbolTextureRatio+c;return function(a){void 0===a&&(a=D.vec2f64.create());a[0]=k;a[1]=g;return a}};c.prototype._fastVisualVariableConvertOptions=function(){var a=this._size[0]>this._size[1]?this._size[0]:this._size[1],b=t.vec3f64.fromValues(a,a,a),c=v.px2pt(1),a=a*c,a=t.vec3f64.fromValues(a,
a,a);return{modelSize:b,symbolSize:a,unitInMeters:c,transformation:{anchor:t.vec3f64.ZEROS,scale:t.vec3f64.ONES,rotation:t.vec3f64.ZEROS}}};c.prototype._getGraphicHash=function(a){for(var b="",c=0,e=this._cimRequiredFields;c<e.length;c++)var f=e[c],b=b+(f+a.attributes[f]);return b};c.prototype._forEachMaterial=function(a,b){switch(a){case 0:this._forEachMaterial(1,b);this._forEachMaterial(2,b);break;case 1:this._material&&b(this._material);this._cimSymbolMaterials.forEach(b);break;case 2:this._drapedMaterial&&
b(this._drapedMaterial);this._cimSymbolDrapedMaterials.forEach(b);break;default:G.neverReached(a)}};c.PRIMITIVE_SIZE=ja;c.elevationModeChangeTypes={definedChanged:l.SymbolUpdateType.UPDATE,staysOnTheGround:l.SymbolUpdateType.NONE,onTheGroundChanged:l.SymbolUpdateType.RECREATE};return c}(ea.default);z.Graphics3DIconSymbolLayer=r;var ka={mode:"relative-to-ground",offset:0},la=U.vec4f64.fromValues(0,0,0,1);z.default=r});