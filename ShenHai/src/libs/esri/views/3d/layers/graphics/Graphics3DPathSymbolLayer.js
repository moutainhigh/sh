// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/Error ../../../../core/lang ../../../../core/mathUtils ../../../../core/maybe ../../../../core/libs/gl-matrix-2/mat2 ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f32 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../layers/graphics/dehydratedFeatures ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ../support/FastSymbolUpdates ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/pathGeometryUtils ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/PathMaterial ../../webgl-engine/materials/internal/MaterialUtil".split(" "),
function(z,l,U,ja,V,W,X,Y,E,y,Z,I,aa,g,J,K,A,ba,x,F,L,M,ca,da,c,ea,fa,ga){function N(h,a,e){switch(a){case "world":for(var b=0,v=h.vertices;b<v.length;b++)a=v[b],g.vec3.add(m,a.pos,h.offset),e.worldUpAtPosition(m,n),a.setFrameFromUpVector(n),a.computeRotationAxisAndAngleFromUpVector();break;case "path":for(g.vec3.add(m,h.vertices[0].pos,h.offset),e.worldUpAtPosition(m,n),c.computeMinimumRotationTangentFrame(h,n),e=0,h=h.vertices;e<h.length;e++){a=h[e];b=E.sign(g.vec3.dot(a.frame.right,a.vRight));
g.vec3.cross(a.rotationFrame.up,a.vRight,a.vLeft);g.vec3.scale(a.rotationFrame.up,a.rotationFrame.up,b);g.vec3.normalize(a.rotationFrame.up,a.rotationFrame.up);var v=g.vec3.dot(a.rotationFrame.up,a.frame.up),u=g.vec3.dot(a.rotationFrame.up,a.frame.right);g.vec3.scale(m,a.frame.up,-u);g.vec3.scale(O,a.frame.right,v);g.vec3.add(m,m,O);g.vec3.normalize(a.rotationFrame.right,m);c.vertexSpaceToProfileSpace(a.rotationRight,a.frame,a.rotationFrame.right);g.vec3.negate(m,a.vLeft);a.rotationAngle=-b*(Math.PI-
E.acosClamped(g.vec3.dot(m,a.vRight)));0<Math.abs(a.rotationAngle)&&(b=1/Math.cos(.5*a.rotationAngle),Z.mat2.set(a.miterStretch,1+(b-1)*a.rotationRight[0]*a.rotationRight[0],(b-1)*a.rotationRight[0]*a.rotationRight[1],(b-1)*a.rotationRight[0]*a.rotationRight[1],1+(b-1)*a.rotationRight[1]*a.rotationRight[1]));a.maxStretchDistance=Math.abs(Math.min(a.vLeftLength,a.vRightLength)/Math.cos(.5*(Math.PI-a.rotationAngle)))}}}function P(c,a,e){switch(c){case "symbolValue":return e;case "proportional":return a;
default:return c}}function ha(c,a,e,b){c=c.stageObject;var v=c.geometryRecords,u=v.length,Q=0;w.spatialReference=e.spatialReference;ia.spatialReference=b.spatialReference;for(var f=0;f<u;f++){var C=v[f].geometry,p=C.metadata,R=p.pathGeometry,D=R.builder.path;S.spatialReference=p.geometrySR;for(var q=D,h=a,G=e,d=b,k=0,r=0,t=q.vertices;r<t.length;r++){var l=t[r];w.x=l.posES[0];w.y=l.posES[1];w.z=l.posES[2];var m=x.computeElevation(G,w,h,d,T),k=k+T.terrainElevation;g.vec3.add(n,l.pos,q.offset);d.setAltitude(m,
n);g.vec3.subtract(l.pos,n,q.offset)}q.updatePathVertexInformation();Q+=k/q.vertices.length;"world"!==D.upVector&&N(D,p.upVectorAlignment,b);R.onPathChanged();C.invalidateBoundingInfo();c.geometryVertexAttrsUpdated(f)}return Q/u}Object.defineProperty(l,"__esModule",{value:!0});z=function(h){function a(a,b,c,u){a=h.call(this,a,b,c,u)||this;a._intrinsicSize=aa.vec2f64.fromValues(1,1);a.upVectorAlignment="path";a.stencilWidth=.1;return a}U(a,h);a.prototype.doLoad=function(){return W(this,void 0,void 0,
function(){var a,b,v,u,g,f,C,p,h,D,q,m,n,d;return V(this,function(e){a=y.isSome(this.symbolLayer.width)?this.symbolLayer.width:y.isSome(this.symbolLayer.height)?this.symbolLayer.height:this.symbolLayer.size;b=y.isSome(this.symbolLayer.height)?this.symbolLayer.height:a;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[a,1,b],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}};
this._fastUpdates=this._context.renderer&&this._context.renderer.visualVariables&&0<this._context.renderer.visualVariables.length?M.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):{enabled:!1};v=this.symbolLayer.anchor||"center";this.upVectorAlignment="path";"heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world");u=this.symbolLayer.profile||"circle";switch(u){default:this._profile=c.Profile.circle(l.NUM_CIRCLE_PROFILE_SUBDIVISIONS);break;case "quad":this._profile=
c.Profile.rect()}g=[0,0];"center"!==v&&(g={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[v],this._profile.translate(g[0],g[1]));f=this.symbolLayer.join||"simple";switch(f){case "round":this._extruder=new c.MiterExtruder(0,l.NUM_ROUND_JOIN_SUBDIVISIONS);break;case "bevel":this._extruder=new c.MiterExtruder(0,1);break;case "miter":this._extruder=new c.MiterExtruder(.8*Math.PI,1);break;default:this._extruder=new c.SimpleExtruder}C=this.symbolLayer.cap||"butt";switch(C){case "none":this._startCap=
new c.NoCapBuilder;this._endCap=new c.NoCapBuilder;break;default:this._startCap=new c.TriangulationCapBuilder(this._profile,0);this._endCap=new c.TriangulationCapBuilder(this._profile,0,!0);break;case "square":this._startCap=new c.TriangulationCapBuilder(this._profile,-.5);this._endCap=new c.TriangulationCapBuilder(this._profile,.5,!0);break;case "round":p="quad"===u?!0:!1,this._startCap=new c.RoundCapBuilder({profile:this._profile,flip:!1,breakNormals:p,subdivisions:l.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS}),
this._endCap=new c.RoundCapBuilder({profile:this._profile,flip:!0,breakNormals:p,subdivisions:l.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS})}h=this._getIdHint();D=y.get(this.symbolLayer,"material","color");q=this._getCombinedOpacityAndColor(D);m=K.vec3f64.fromArray(q);n=q[3];d={diffuse:m,ambient:m,opacity:n,transparent:1>n||this.needsDrivenTransparentPass,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:"none"===C?0:void 0,offsetTransparentBackfaces:!0};
if(!this._drivenProperties.size&&(I.vec2.set(this._intrinsicSize,a,b),!L.isValidSize(this._intrinsicSize[0])||!L.isValidSize(this._intrinsicSize[1])))throw new X("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||I.vec2.scale(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters);this._fastUpdates.enabled?(Y.mixin(d,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],
this._intrinsicSize[1],0]}),this._material=new fa(d,h+"_pathmat")):(d.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new ea(d,h+"_pathmat"));this._material.setParameterValues(ga.getDefaultPBRMaterialParameters(this._context.physicalBasedRenderingEnabled));this._context.stage.add(3,this._material);return[2]})})};a.prototype.destroy=function(){h.prototype.destroy.call(this);this._material&&(this._context.stage.remove(3,this._material.id),this._material=null)};
a.prototype.createGraphics3DGraphic=function(e){var b=e.graphic;if(!this._validateGeometryType(b.geometry,a.validGeometryTypes,this.symbolLayer.type)||!this._validateGeometry(b.geometry))return null;var c="graphic"+b.uid,u=this.getGraphicElevationContext(b);return this._createAs3DShape(b,e.renderingInfo,u,c,b.uid)};a.prototype.layerOpacityChanged=function(){var a=y.get(this.symbolLayer,"material","color"),a=this._getCombinedOpacity(a);this._material.setParameterValues({opacity:a,transparent:1>a||
this.needsDrivenTransparentPass});return!0};a.prototype.layerElevationInfoChanged=function(a,b){var c=this;a.forEach(function(a){var e=b(a);y.isSome(e)&&(a=c.getGraphicElevationContext(a.graphic),e.needsElevationUpdates=x.needsElevationUpdates3D(a.mode),e.elevationContext.set(a))});return x.SymbolUpdateType.UPDATE};a.prototype.slicePlaneEnabledChanged=function(){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};a.prototype.physicalBasedRenderingChanged=
function(){this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled});return!0};a.prototype.pixelRatioChanged=function(){return!0};a.prototype.applyRendererDiff=function(a,b){for(var c in a.diff)switch(c){case "visualVariables":if(M.updateFastSymbolUpdatesState(this._fastUpdates,b,this._vvConvertOptions))this._material.setParameterValues(this._fastUpdates.materialParameters);else return!1;break;default:return!1}return!0};a.prototype.getVertexData=function(a){for(var b=
0,c=a.paths,e=[],g=a.spatialReference,f=this._context.elevationProvider.spatialReference,h=this._context.renderSpatialReference,p=0;p<c.length;p++)var l=c[p],b=b+l.length;for(var p=new Float64Array(3*b),m=new Float64Array(3*b),q=new Float64Array(3*b),n=0,w=0;w<c.length;w++){l=c[w];e.push({index:n,numVertices:l.length});for(var d=0;d<l.length;d++){var k=l[d];p[n++]=k[0];p[n++]=k[1];p[n++]=a.hasZ?k[2]:0}}a=!0;g.equals(f)?x.copyVertices(p,0,m,0,b):a=x.reproject(p,0,g,m,0,f,b);f.equals(h)?x.copyVertices(m,
0,q,0,b):x.reproject(m,0,f,q,0,h,b);return{pathVertexDataInfos:e,vertexDataGS:p,vertexDataES:m,vertexDataRS:q,projectionSuccess:a,terrainElevation:0}};a.prototype._createAs3DShape=function(a,b,l,h,m){var f=a.geometry,e=[],p=[],u=[],v=f.spatialReference,q=this._context.elevationProvider.spatialReference,y=Array(6),G=this._context.renderCoordsHelper;S.spatialReference=v;w.spatialReference=q;f=this.getVertexData(f);if(!f.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),
null;if(0<f.pathVertexDataInfos.length){for(q=0;q<f.pathVertexDataInfos.length;++q){var d=f.pathVertexDataInfos[q],k=d.index,d=d.numVertices;if(2>d)this.logger.warn("PathSymbol3DLayer geometry failed to be created (paths should contain at least 2 vertices)");else{if(this._context.clippingExtent&&(x.computeBoundingBox(f.vertexDataES,k,d,y),x.boundingBoxClipped(y,this._context.clippingExtent)))continue;for(var r=[],t=k;t<k+3*d;){var z=t++,A=t++,H=t++,B=new c.PathVertex;g.vec3.set(B.posGS,f.vertexDataGS[z],
f.vertexDataGS[A],f.vertexDataGS[H]);g.vec3.set(B.posES,f.vertexDataES[z],f.vertexDataES[A],f.vertexDataES[H]);w.x=B.posES[0];w.y=B.posES[1];w.z=B.posES[2];var E=x.computeElevation(this._context.elevationProvider,w,l,G,null);g.vec3.set(n,f.vertexDataRS[z],f.vertexDataRS[A],f.vertexDataRS[H]);G.setAltitude(E,n);g.vec3.set(B.pos,n[0],n[1],n[2]);r.push(B)}k=new c.Path(r);N(k,this.upVectorAlignment,this._context.renderCoordsHelper);k=new c.Builder(k,this._profile,this._extruder,this._startCap,this._endCap);
d=null;this._fastUpdates.enabled?(t=this._fastUpdates.visualVariables,d=t.size?F.getAttributeValue(t.size.field,a):0,r=t.color?F.getAttributeValue(t.color.field,a):0,t=t.opacity?F.getAttributeValue(t.opacity.field,a):0,d=new c.FastUpdatePathGeometry(k,d,r,t)):(d=[this._intrinsicSize[0],this._intrinsicSize[1]],this._drivenProperties.size&&(d[0]*=P(b.size[0],b.size[2],this.symbolLayer.width),d[1]*=P(b.size[2],b.size[0],this.symbolLayer.height)),r=null,this._drivenProperties.color&&(r=b.color),this._drivenProperties.opacity&&
null!=b.opacity&&(r=r?[r[0],r[1],r[2],b.opacity]:[1,1,1,b.opacity]),k=new c.StaticPathGeometry(k),k.bake(d),r&&k.bakeVertexColors(r),d=k);k=d.createGeometryData();k=new ca(k,h+"path"+q);r={pathGeometry:d,geometrySR:v,upVectorAlignment:this.upVectorAlignment,stencilWidth:this.stencilWidth};k.singleUse=!0;k.metadata=r;e.push(k);p.push(this._material);u.push(d.xform)}}a={layerUid:this._context.layer.uid,graphicUid:m};if(0<e.length)return h=new da({geometries:e,materials:p,transformations:u,castShadow:!0,
metadata:a,idHint:h}),e=new ba(this,h,e,null,null,ha,l),e.alignedTerrainElevation=f.terrainElevation,e.needsElevationUpdates=x.needsElevationUpdates3D(l.mode),e}else this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null};a.validGeometryTypes=["polyline"];return a}(F.Graphics3DSymbolLayer);l.Graphics3DPathSymbolLayer=z;var ia=A.makeDehydratedPoint(0,0,0,null),w=A.makeDehydratedPoint(0,0,0,null),S=A.makeDehydratedPoint(0,0,0,null),n=K.vec3f64.create(),
m=J.vec3f32.create(),O=J.vec3f32.create();l.NUM_ROUND_JOIN_SUBDIVISIONS=3;l.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS=3;l.NUM_CIRCLE_PROFILE_SUBDIVISIONS=10;var T={verticalDistanceToGround:0,terrainElevation:0};l.default=z});