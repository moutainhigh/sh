// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/assignHelper ../../../../../core/compilerUtils ../../../../../core/Evented ../../../../../core/Handles ../../../../../core/maybe ../../../../../core/watchUtils ../../../../../core/accessorSupport/decorators ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../layers/graphics/dehydratedFeatures ../../../../../support/elevationInfoUtils ../../Manipulator3D ../../manipulatorUtils ../../dragUtils/projectScreenToMap ../manipulatorUtils ./reshapeUtils ../../../support/stack ../../../webgl-engine/lib/Geometry ../../../webgl-engine/lib/GeometryUtil ../../../../interactive/dragUtils/dragHandlers ../../../../interactive/dragUtils/screenDragToMap".split(" "),
function(x,y,n,C,N,D,E,z,f,F,m,v,G,A,H,t,I,u,J,K,L,M,w,p){Object.defineProperty(y,"__esModule",{value:!0});x=function(B){function c(a){a=B.call(this,a)||this;a._vertexManipulatorMaterial=t.createManipulatorMaterial([1,.5,0],1);a._edgeManipulatorMaterial=t.createManipulatorMaterial([.5,.5,.5],1);a._selectedManipulatorMaterial=t.createManipulatorMaterial([1,1,1],1);a._manipulatorGeometry=new L(M.createSphereGeometry(1,16,16),"reshape-manipulator");a._handles=new z;a._manipulatorHandles=new z;a._manipulatorInfos=
[];a._reshapeHelper=null;a._moveManipulator=null;a._moveZManipulator=null;a._numGrabbing=0;a._reshapeEventState=0;a.view=null;a.graphic=null;a.outputGeometry=null;a.manipulators=null;a._emitter.target=null;return a}C(c,B);c.prototype.initialize=function(){var a=this;this._handles.add(this.watch(["graphic.visible","graphic.layer.visible"],function(){for(var b=a.graphic.visible&&a.graphic.layer.visible,g=0,d=a._manipulatorInfos;g<d.length;g++)d[g].manipulator.visible=!!b;f.isSome(a._moveZManipulator)&&
(a._moveZManipulator.visible=!!b)}))};c.prototype.destroy=function(){this._clear();this._handles.destroy()};Object.defineProperty(c.prototype,"inputGeometry",{get:function(){return f.isSome(this._reshapeHelper)?this._reshapeHelper.geometry:null},set:function(a){this._recreateManipulators(a)},enumerable:!0,configurable:!0});c.prototype.removeSelectedVertices=function(){var a=this._manipulatorInfos.filter(function(a){return a.manipulator.selected&&"vertex"===a.handle.type});this._removeVertices(a)};
c.prototype.manipulatorSelectionChanged=function(){this._updateMoveZManipulatorPosition()};c.prototype._clear=function(){this._manipulatorHandles.removeAll();this.manipulators.removeAll();this._manipulatorInfos=[];this._reshapeHelper=this._moveManipulator=null;this._numGrabbing=0};c.prototype._recreateManipulators=function(a){this._clear();this._reshapeHelper=J.createReshapeHelper(a,"global"===this.view.viewingMode);if(!f.isNone(this._reshapeHelper)){a=A.getGraphicEffectiveElevationInfo(this.graphic);
for(var b=0,g=this._reshapeHelper.components;b<g.length;b++){for(var d=g[b],e=0,c=d.vertices;e<c.length;e++)this._createPerVertexManipulator(c[e],a);e=0;for(d=d.edges;e<d.length;e++)this._createPerVertexManipulator(d[e],a)}this._createGraphicMoveManipulators()}};c.prototype._perGraphicManipulatorDragAction=function(a,b){if("end"!==b.action){var g=[],d=this._manipulatorInfos.some(function(a){return"vertex"===a.handle.type&&a.manipulator.selected}),e=1===a&&d;a=f.expect(this._reshapeHelper);for(var c=
0,l=this._manipulatorInfos;c<l.length;c++)d=l[c],"vertex"!==d.handle.type||d.manipulator.grabbing||e&&!d.manipulator.selected||(f.expect(a).addDelta(d.handle,b.deltaDeltaX,b.deltaDeltaY,b.deltaDeltaZ),g.push(d.handle.pos),this._updateManipulatorPosition(d));if(0!==g.length){e=0;for(c=this._manipulatorInfos;e<c.length;e++)d=c[e],"vertex"!==d.handle.type&&this._updateManipulatorPosition(d);this.outputGeometry=a.commit();g.length===this._manipulatorInfos.length?(this._updateEventState(1),this.emit("move",
{type:"move",dx:b.screenDeltaDeltaX,dy:b.screenDeltaDeltaY,mover:this.graphic})):(this._updateEventState(2),this.emit("reshape",{type:"reshape",mover:this.graphic}))}}};c.prototype._perVertexManipulatorDragAction=function(a,b){var c="edge"===a.handle.type?this._splitEdgeManipulator(a):a;this._updateEventState(2);!1===a.manipulator.selected&&(this._clearManipulatorSelection(),this._updateMoveZManipulatorPosition());a=b.deltaDeltaX;var d=b.deltaDeltaY,e=b.deltaDeltaZ;if(a||d||e){b=[];for(var k=0,l=
this._manipulatorInfos;k<l.length;k++){var h=l[k];"vertex"===h.handle.type&&(h.manipulator.selected&&!h.manipulator.grabbing||h===c)&&b.push(h)}l=f.expect(this._reshapeHelper);for(h=0;h<b.length;h++)c=b[h],k=c.handle,l.addDelta(k,a,d,e),this._updateManipulatorPosition(c);this.outputGeometry=l.commit();for(a=0;a<b.length;a++)c=b[a],k=c.handle,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(k.left)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(k.right));this.emit("reshape",
{type:"reshape",mover:this.graphic})}};c.prototype._updateEventState=function(a){if(a===this._reshapeEventState)return!1;switch(a){case 0:if(0!==this._numGrabbing)return!1;switch(this._reshapeEventState){case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case 1:switch(this._reshapeEventState){case 0:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",
{type:"reshape-stop",mover:this.graphic}),this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case 2:switch(this._reshapeEventState){case 0:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}var b=this._reshapeEventState!==a;this._reshapeEventState=a;return b};c.prototype._createGraphicMoveManipulators=function(){var a=this;
this._moveManipulator=u.createGraphicMoveXYManipulator(this.view,this.graphic);this._manipulatorHandles.add(w.createManipulatorDragHandler(this._moveManipulator,function(b,c){return p.withScreenHistoryInfo(p.withHistoryInfo(u.createGraphicMoveXYScreenDragToMap(a.view,b,c)))},function(b){return a._perGraphicManipulatorDragAction(0,b)}));this._manipulatorHandles.add(this._watchAndUpdateGrabState(this._moveManipulator));this._moveManipulator.events.on("immediate-click",function(b){a.emit("immediate-click");
b.stopPropagation()});this.manipulators.add(this._moveManipulator);this._moveZManipulator=u.createGraphicMoveZManipulator({view:this.view,graphic:this.graphic});f.isSome(this._moveZManipulator)&&(this._manipulatorHandles.add(w.createManipulatorDragHandler(this._moveZManipulator,function(b){return p.withScreenHistoryInfo(p.withHistoryInfo(u.createGraphicMoveZScreenDragToMap(a.view,b)))},function(b){return a._perGraphicManipulatorDragAction(1,b)})),this._manipulatorHandles.add(this._watchAndUpdateGrabState(this._moveZManipulator)),
this.manipulators.add(this._moveZManipulator),this._manipulatorHandles.add(F.init(this.graphic,"geometry",function(){return a._updateMoveZManipulatorPosition()})))};c.prototype._clearManipulatorSelection=function(){for(var a=0,b=this._manipulatorInfos;a<b.length;a++)b[a].manipulator.selected=!1;this._updateMoveZManipulatorPosition()};c.prototype._createPerVertexManipulator=function(a,b){var c=this;void 0===b&&(b=A.getGraphicEffectiveElevationInfo(this.graphic));b=new H.Manipulator3D({view:this.view,
renderObjects:[{geometry:this._manipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:q.Vertex|4},{geometry:this._manipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:q.Edge|4},{geometry:this._manipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:8}],radius:5,elevationInfo:b,visible:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(b,a);var d={manipulator:b,handle:a};this._manipulatorInfos.push(d);this.manipulators.add(b);
this._updateManipulatorPosition(d);this._manipulatorHandles.add(this._watchAndUpdateGrabState(b),b);this._manipulatorHandles.add(w.createManipulatorDragHandler(b,function(a){return p.withHistoryInfo(p.createXYConstrainedFromProject(I.createForGraphicAtLocation(c.view,c.graphic,a.elevationAlignedLocation),a.location.spatialReference))},function(a){return c._perVertexManipulatorDragAction(d,a)}));b.events.on("immediate-click",function(a){return c._manipulatorClickCallback(a,d)});return b};c.prototype._setTypeSpecificManipulatorSettings=
function(a,b){switch(b.type){case "vertex":a.state=q.Vertex;a.selectable=!0;a.cursor="move";a.collisionPriority=2;a.hideOnGrab=!0;break;case "edge":a.state=q.Edge;a.selectable=!1;a.cursor="copy";a.collisionPriority=1;a.hideOnGrab=!1;break;default:D.neverReached(b)}};c.prototype._watchAndUpdateGrabState=function(a){var b=this;return a.events.on("grab",function(a){"start"===a.action?b._numGrabbing++:(b._numGrabbing--,b._updateEventState(0))})};c.prototype._removeManipulator=function(a){a&&(this._manipulatorHandles.remove(a.manipulator),
this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(a),1),this.manipulators.remove(a.manipulator))};c.prototype._getManipulatorInfoFromHandle=function(a){if(a)for(var b=0,c=this._manipulatorInfos;b<c.length;b++){var d=c[b];if(a===d.handle)return d}return null};c.prototype._updateManipulatorPosition=function(a){if(a){var b=f.expect(this._reshapeHelper);"vertex"===a.handle.type?a.manipulator.location=b.getVertexPositionAsPoint(a.handle,r):"edge"===a.handle.type&&(a.manipulator.location=b.getEdgePositionAsPoint(a.handle,
.5,r))}};c.prototype._splitEdgeManipulator=function(a){var b=f.expect(this._reshapeHelper).splitEdge(a.handle,.5);a.handle=b;this._setTypeSpecificManipulatorSettings(a.manipulator,a.handle);b.left&&this._createPerVertexManipulator(b.left);b.right&&this._createPerVertexManipulator(b.right);return a};c.prototype._updateMoveZManipulatorPosition=function(){if(!f.isNone(this._moveZManipulator)){var a=K.sv3d.get();v.vec3.set(a,0,0,0);for(var b=0,c=0,d=this._manipulatorInfos;c<d.length;c++){var e=d[c];"vertex"===
e.handle.type&&e.manipulator.selected&&(b++,v.vec3.add(a,a,e.manipulator.renderLocation))}if(0!==b&&(v.vec3.scale(a,a,1/b),r.spatialReference=f.expect(this._reshapeHelper).geometry.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(a,r))){this._moveZManipulator.elevationAlignedLocation=r;return}t.placeManipulatorAtGraphic(this._moveZManipulator,this.graphic)}};c.prototype._removeVertices=function(a){for(var b=[],c=f.expect(this._reshapeHelper),d=0;d<a.length;d++){var e=a[d];"vertex"===
e.handle.type&&c.canRemoveVertex(e.handle)&&(b.push(e.handle.unnormalizedPos),this._removeManipulator(e),this._removeManipulator(this._getManipulatorInfoFromHandle(e.handle.left)),this._removeManipulator(this._getManipulatorInfoFromHandle(e.handle.right)),(e=c.removeVertex(e.handle))&&this._createPerVertexManipulator(e))}0<b.length&&(this.outputGeometry=c.commit(),a=this._updateEventState(2),this.emit("vertex-remove",{type:"vertex-remove",removed:b}),a&&this._updateEventState(0),this._updateMoveZManipulatorPosition())};
c.prototype._manipulatorClickCallback=function(a,b){"vertex"===b.handle.type&&2===a.button&&this._removeVertices([b]);if("edge"===b.handle.type&&0===a.button){b=this._splitEdgeManipulator(b);this.outputGeometry=f.expect(this._reshapeHelper).commit();var c=this._updateEventState(2);this.emit("vertex-add",{type:"vertex-add",added:[b.handle.unnormalizedPos]});c&&this._updateEventState(0)}a.stopPropagation()};n([m.property({constructOnly:!0})],c.prototype,"view",void 0);n([m.property({constructOnly:!0})],
c.prototype,"graphic",void 0);n([m.property()],c.prototype,"inputGeometry",null);n([m.property()],c.prototype,"outputGeometry",void 0);n([m.property({constructOnly:!0})],c.prototype,"manipulators",void 0);return c=n([m.subclass("esri.views.3d.interactive.editingTools.graphicReshape3D.ReshapeOperation")],c)}(m.declared(E.EventedAccessor));y.ReshapeOperation=x;var r=G.makeDehydratedPoint(0,0,null,null),q;(function(f){f.Vertex=16;f.Edge=32})(q||(q={}))});