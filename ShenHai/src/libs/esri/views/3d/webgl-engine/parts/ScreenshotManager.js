// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators ../../../../core/libs/gl-matrix-2/vec4f64 ../lib/AutoDisposable ../../../support/screenshotUtils ../../../webgl/FramebufferObject".split(" "),function(l,n,p,r,t,u,v,q,w,x,k,y){Object.defineProperty(n,"__esModule",{value:!0});l=function(l){function f(b,
c,a,d,e){void 0===d&&(d=null);void 0===e&&(e=!0);var h=l.call(this)||this;h._rctx=b;h._renderScene=c;h._requestRenderScene=a;h._renderOverlay=d;h.supersample=e;h._screenshotQueue=[];return h}r(f,l);f.prototype.dispose=function(){this._rctx=null};f.prototype.takeScreenshot=function(b){var c=this;this._requestRenderScene();var a=v.createResolver(function(){c._screenshotQueue=c._screenshotQueue.filter(function(b){return b.resolver!==a})});this._screenshotQueue.push({settings:b,resolver:a});return a.promise};
f.prototype.update=function(b){if(0!==this._screenshotQueue.length){for(var c=0,a=this._screenshotQueue;c<a.length;c++){var d=a[c];if(this.isDisposed)d.resolver.reject();else{var e=p({},d.settings,{pixelRatio:d.settings.pixelRatio*b.viewCamera.pixelRatio}),h=this._ensureScreenshotEncodeCanvas(),f=this._renderScreenshot(b,e),e=k.encodeResult(f,e,h,{flipY:!0,premultipliedAlpha:!0});d.resolver(e)}}this._screenshotQueue=[]}};f.prototype._renderScreenshotOverlay=function(b,c,a){if(!u.isNone(this._renderOverlay)){b.width=
c.width;b.height=c.height;var d=b.getContext("2d"),e=a.pixelRatio;d.save();d.translate(0,c.height);d.scale(1,-1);a.region&&d.translate(-a.region.x,-a.region.y);d.scale(e,e);this._renderOverlay(b,c);d.restore()}};f.prototype._readbackScreenshot=function(b){return b.resample?this._readbackScreenshotResampled(b):this._readbackScreenshotImmediate(b)};f.prototype._readbackScreenshotResampled=function(b){var c=b.framebufferWidth,a=b.framebufferHeight,d=b.region,e=b.resample,h=this._ensureScreenshotEncodeCanvas(),
f=k.createEmptyImageData(c,a,h);this._rctx.gl.readPixels(0,0,c,a,6408,5121,new Uint8Array(f.data.buffer));this._renderScreenshotOverlay(h,f,p({},b,{region:null}));b=k.createEmptyImageData(d.width,d.height,h);return k.resampleHermite(f,b,!0,e.region.x,a-(e.region.y+e.region.height),e.region.width,e.region.height)};f.prototype._readbackScreenshotImmediate=function(b){var c=b.framebufferHeight,a=b.region,d=this._ensureScreenshotEncodeCanvas(),e=k.createEmptyImageData(a.width,a.height,d);this._rctx.gl.readPixels(a.x,
c-(a.y+a.height),a.width,a.height,6408,5121,new Uint8Array(e.data.buffer));this._renderScreenshotOverlay(d,e,b);return e};f.prototype._renderScreenshot=function(b,c){var a=null,d=b.viewCamera,e=c.framebufferWidth,f=c.framebufferHeight,l=!1,k=b.frameHasSlicePlane&&c.disableSlice,g=c.ignorePadding&&d.pixelRatio!==c.pixelRatio;if(k=e!==d.fullWidth||f!==d.fullHeight||k||g){g=d.clone();if(c.ignorePadding){for(var a=w.vec4f64.clone(g.padding),m=0;4>m;m++)a[m]=Math.round(a[m]/g.pixelRatio*c.pixelRatio);
g.padding=a}g.fullWidth=e;g.fullHeight=f;g.pixelRatio=c.pixelRatio;a=d.fovX-g.fovX;e=d.fovY-g.fovY;0>a&&a<e?g.fovX=d.fovX:0>e&&e<a&&(g.fovY=d.fovY);b.drapedRenderer.forceUpdate&&b.drapedRenderer.forceUpdate(g);l=!0;a=new y(this._rctx,{width:g.fullWidth,height:g.fullHeight,colorTarget:0,depthStencilTarget:3});this._renderScene(a,g,c.disableSlice)}c=this._readbackScreenshot(c);if(k&&!this._rctx.contextAttributes.alpha)for(m=3;m<c.data.length;m+=4)c.data[m]=255;a&&a.dispose();this._rctx.bindFramebuffer(null);
l&&b.drapedRenderer.forceUpdate&&b.drapedRenderer.forceUpdate(d);return c};f.prototype._ensureScreenshotEncodeCanvas=function(){this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas"));return this._screenshotEncodeCanvas};return f=t([q.subclass("esri.views.3d.webgl-engine.parts.ScreenshotManager")],f)}(q.declared(x.AutoDisposable));n.ScreenshotManager=l});