// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/extendsHelper ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../../../core/libs/gl-matrix-2/vec4f64 ../../../../../geometry/support/aaBoundingBox ../../../support/debugFlags ../../../support/buffer/glUtil ../Camera ../DefaultVertexAttributeLocations ../intersectorUtils ../Util ./InstanceData ./InstanceOctree ./LevelSelector ./RenderInstanceData ./utils ../../materials/DefaultMaterial ../../materials/internal/MaterialUtil ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject".split(" "),
function(A,r,Y,O,u,v,P,w,B,C,Q,y,R,x,k,S,T,D,z,U,V,W,E,X){function F(b,a,c,d){z.encodeDoubleVec3(b.modelOrigin,a,c.modelOriginHi,c.modelOriginLo,d);c.model.copyFrom(d,b.model,a);c.modelNormal.copyFrom(d,b.modelNormal,a);b.color&&c.color&&c.color.copyFrom(d,b.color,a);b.featureAttribute&&c.featureAttribute&&c.featureAttribute.copyFrom(d,b.featureAttribute,a)}Object.defineProperty(r,"__esModule",{value:!0});var G=function(b){var a=b.baseBoundingSphere.radius;b=b.levels.map(function(a){return a.minScreenSpaceRadius});
return new T.LevelSelector(a,b)};r.setLevelSelectorFactory=function(b){G=b};var H=function(){function b(a,c){this.glMaterials={};var d=a.rctx,b=c.geometry;c=c.material;var g=b.data.toRenderData();this.materialRep=a.materialRep;c.setParameterValues({instancedDoublePrecision:!0});a=c.createBufferWriter();var h=a.vertexBufferLayout,e=a.elementCount(g),t=a.allocate(e);a.write({},g,t,0);this.geometry=b;this.material=c;this.glMaterials=z.acquireGLMaterials(c,this.materialRep);this.vertexBufferLayout=h;
this.vbo=W.createVertex(d,35044,t.buffer);this.vao=new X(d,y.Default3D,{geometry:C.glLayout(h)},{geometry:this.vbo});this.vertexCount=e}b.prototype.destroy=function(){z.releaseGLMaterials(this.material,this.materialRep);this.vbo.dispose();this.vao.dispose()};Object.defineProperty(b.prototype,"boundingInfo",{get:function(){return this.geometry.boundingInfo},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"triangleCount",{get:function(){return this.vertexCount/3},enumerable:!0,configurable:!0});
b.prototype.intersect=function(a,c,d,b,g,h){var f=this.geometry.id,t=g.toString();this.material.intersect(this.geometry,null,a.transform.transform,a,d,b,function(b,d,e,l){if(0<=b&&(null==c||c(a.rayBeginPoint,a.rayEndPoint,b))){var k={type:"external",metadata:{layerUid:h.layerUid,graphicUid:h.graphicUid(g)}};if(null==a.results.min.drapedLayerOrder||l>=a.results.min.drapedLayerOrder)if(null==a.results.min.dist||b<a.results.min.dist)a.results.min.set(k,t,b,d,a.transform.transform,l,null,f,e),a.results.min.intersector=
"LodRenderer";0!==a.options.store&&(null==a.results.max.drapedLayerOrder||l>=a.results.max.drapedLayerOrder)&&(null==a.results.max.dist||b>a.results.max.dist)&&(a.results.max.set(k,t,b,d,a.transform.transform,l,null,f,e),a.results.min.intersector="LodRenderer");if(2===a.options.store){var m=new R.IntersectorResult(a.results.min.ray);m.set(k,t,b,d,a.transform.transform,l,null,f,e);m.intersector="LodRenderer";a.results.all.push(m)}}})};return b}();r.LodComponentData=H;var I=function(){function b(a,
c){var b=this;this.components=[];this.minScreenSpaceRadius=c.minScreenSpaceRadius;c.components.forEach(function(c){b.components.push(new H(a,c))})}b.prototype.destroy=function(){this.components.forEach(function(a){a.destroy()})};b.prototype.intersect=function(a,c,b,f,g,h){this.components.forEach(function(d){d.intersect(a,c,b,f,g,h)})};Object.defineProperty(b.prototype,"boundingBox",{get:function(){if(!this._boundingBox){var a=w.empty();this.components.forEach(function(c){w.expand(a,c.boundingInfo.bbMin);
w.expand(a,c.boundingInfo.bbMax)});this._boundingBox=a}return this._boundingBox},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"boundingSphere",{get:function(){if(!this._boundingSphere){var a=this.boundingBox,c=v.vec3f64.create();w.center(a,c);this._boundingSphere={center:c,radius:.5*w.diameter(a)}}return this._boundingSphere},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"triangleCount",{get:function(){return this.components.reduce(function(a,c){return a+c.triangleCount},
0)},enumerable:!0,configurable:!0});return b}();r.LodLevelData=I;A=function(){function b(a,c,b,f){var d=this;this.type="Lod";this._levels=[];this._renderInstanceData=[];this._highlightRenderInstanceData=[];this._instanceIndex=0;this._slicePlaneEnabled=!1;this._enableLevelSelection=!0;this._lastCamera=new Q.default;this._updateCyclesWithStaticCamera=-1;this._needFullCycle=!1;this.canRender=!0;this._symbol=a;this._optionalFields=c;this._metadata=b;this._instanceBufferLayout=U.getInstanceBufferLayout({instancedDoublePrecision:!0,
instanced:c});this._glInstanceBufferLayout=C.glLayout(this._instanceBufferLayout,{divisor:1});this._instanceData=new k.InstanceData(this._optionalFields,f);this._instanceData.on("instance-added",function(){d.requestUpdateCycle()});this._instanceData.on("instance-removed",function(){d.requestUpdateCycle()});this._instanceData.on("instance-transform-changed",function(){d.requestUpdateCycle()});this._instanceData.on("instance-visibility-changed",function(){d.requestUpdateCycle(!0)});this._instanceData.on("instance-highlight-changed",
function(){d.requestUpdateCycle(!0)});this._enableLevelSelection=1<this._symbol.levels.length;r.lodRenderers.push(this)}b.prototype.destroy=function(){r.lodRenderers.splice(r.lodRenderers.indexOf(this),1)};Object.defineProperty(b.prototype,"levels",{get:function(){return this._levels},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"baseBoundingBox",{get:function(){return this._levels[this._levels.length-1].boundingBox},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"baseBoundingSphere",{get:function(){return this._levels[this._levels.length-1].boundingSphere},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"baseMaterial",{get:function(){return this._levels[this._levels.length-1].components[0].material},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"slicePlaneEnabled",{get:function(){return this._slicePlaneEnabled},set:function(a){this._slicePlaneEnabled=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"intersectionHandlerId",{get:function(){return this._metadata.layerUid},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"instanceData",{get:function(){return this._instanceData},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"memoryUsage",{get:function(){var a={cpu:0,gpu:0};this._renderInstanceData.forEach(function(c){c=c.memoryUsage;a.cpu+=c.cpu;a.gpu+=c.gpu});this._highlightRenderInstanceData.forEach(function(c){c=c.memoryUsage;a.cpu+=c.cpu;a.gpu+=c.gpu});return a},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"renderStats",{get:function(){var a=this,c=this._instanceData.size,b=[];this._levels.forEach(function(c,d){d=a._renderInstanceData[d].size+a._highlightRenderInstanceData[d].size;c=c.triangleCount;b.push({renderedInstances:d,renderedTriangles:d*c,trianglesPerInstance:c})});return{totalInstances:c,renderedInstances:b.reduce(function(a,c){return a+c.renderedInstances},0),renderedTriangles:b.reduce(function(a,c){return a+c.renderedTriangles},
0),levels:b}},enumerable:!0,configurable:!0});b.prototype.initializeRenderContext=function(a){var c=this;this._initContext=a;var b=a.rctx;this._symbol.levels.forEach(function(d){c._levels.push(new I(a,d));c._renderInstanceData.push(new D.RenderInstanceData(b,c._instanceBufferLayout));c._highlightRenderInstanceData.push(new D.RenderInstanceData(b,c._instanceBufferLayout))});this._levelSelector=G(this)};b.prototype.uninitializeRenderContext=function(){this.invalidateOctree();this._levels.forEach(function(a){a.destroy()});
this._renderInstanceData.forEach(function(a){a.destroy()});this._highlightRenderInstanceData.forEach(function(a){a.destroy()})};Object.defineProperty(b.prototype,"slots",{get:function(){return[5,7]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"needsHighlight",{get:function(){return 0<this._highlightRenderInstanceData.reduce(function(a,c){return a+c.size},0)},enumerable:!0,configurable:!0});b.prototype.prepareRender=function(a){this.runUpdates(a)};b.prototype.render=function(a){var c=
a.rctx,b=5===a.slot?4:7===a.slot?6:null;if(b){if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(a.pass))return!1;var f=a.camera,f={view:f.viewMatrix,proj:f.projectionMatrix,origin:[0,0,0],viewInvTransp:f.viewInverseTransposeMatrix,viewport:f.viewport,fovY:f.fovY,nearFar:[f.near,f.far],shadowMap:a.shadowMap,shadowMappingEnabled:!!a.shadowMap&&a.shadowMap.enabled,ssaoEnabled:!!a.ssaoHelper&&a.ssaoHelper.enabled,pixelRatio:f.pixelRatio,slicePlane:a.sliceHelper&&a.sliceHelper.plane,
cameraAboveGround:f.aboveGround,hudVisibilityTexture:a.offscreenRenderingHelper?a.offscreenRenderingHelper.hudVisibilityTexture:null,slicePlaneEnabled:!1};c.bindVAO();for(c=0;c<this._levels.length;++c)this.renderLevel(a,b,f,a.isHighlightPass?this._highlightRenderInstanceData[c]:this._renderInstanceData[c],c);return!0}};b.prototype.intersect=function(a,c,b,f){var d=this;if(this.baseMaterial.isVisible()){var h=v.vec3f64.create();u.vec3.subtract(h,f,b);var e=function(e){d._instanceData.getCombinedModelTransform(e,
J);a.transform.set(J);u.vec3.transformMat4(K,b,a.transform.inverse);u.vec3.transformMat4(L,f,a.transform.inverse);var h=d._instanceData.getState(e),g=d._instanceData.getLodLevel(e);x.assert(h&k.StateFlags.ACTIVE,"invalid instance state");x.assert(0<=g&&g<d._levels.length,"invaid lod level");d._levels[g].intersect(a,c,K,L,e,d._metadata)};this.baseMaterial.getParameters().verticalOffset?this.octree.forEach(e):this.octree.forEachAlongRay(b,h,e)}};b.prototype.queryDepthRange=function(a){return this.queryDepthRangeOctree(a)};
b.prototype.notifyShaderTransformationChanged=function(){this.invalidateOctree()};b.prototype.requestUpdateCycle=function(a){void 0===a&&(a=!1);this._updateCyclesWithStaticCamera=-1;a&&(this._needFullCycle=!0);this.needsUpdates&&this._initContext.requestRender()};Object.defineProperty(b.prototype,"needsUpdates",{get:function(){return 0<this._instanceData.size&&1>this._updateCyclesWithStaticCamera},enumerable:!0,configurable:!0});b.prototype.runUpdates=function(a){if(!B.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){var c=
a.equals(this._lastCamera);this._lastCamera.copyFrom(a);c||this.requestUpdateCycle()}c=this._needFullCycle?this._instanceData.size:2E3;this._needFullCycle=!1;this.updateInstances(a,c);this.needsUpdates&&this._initContext.requestRender()}};Object.defineProperty(b.prototype,"octree",{get:function(){this._octree||(this._octree=this.buildOctree());return this._octree},enumerable:!0,configurable:!0});b.prototype.invalidateOctree=function(){this._octree&&(this._octree.destroy(),this._octree=null)};b.prototype.buildOctree=
function(){for(var a=new S.InstanceOctree(this._instanceData,this.baseBoundingSphere),c=this._instanceData,c=c.view?c.view.state:null,b=0;b<this._instanceData.capacity;++b)c.get(b)&k.StateFlags.ACTIVE&&a.addInstance(b);return a};b.prototype.queryDepthRangeOctree=function(a){var c=a.eye,b=a.viewForward,f=this.octree.findClosest(b,"front-to-back",a.frustum),g=this.octree.findClosest(b,"back-to-front",a.frustum);return null!=f&&null!=g?(this._instanceData.view.boundingSphere.getVec(f,p),u.vec3.subtract(p,
p,c),f=u.vec3.dot(p,b)-p[3],this._instanceData.view.boundingSphere.getVec(g,p),u.vec3.subtract(p,p,c),c=u.vec3.dot(p,b)+p[3],{near:Math.max(a.near,f),far:Math.min(a.far,c)}):{near:Infinity,far:-Infinity}};b.prototype.startUpdateCycle=function(){this._updateCyclesWithStaticCamera++;this._renderInstanceData.forEach(function(a){a.startUpdateCylce()});this._highlightRenderInstanceData.forEach(function(a){a.startUpdateCylce()});this.needsUpdates&&this._initContext.requestRender()};b.prototype.updateInstances=
function(a,c){var b=this._enableLevelSelection,f=this._levelSelector;f.updateCamera(a);this._renderInstanceData.forEach(function(a){a.beginUpdate()});this._highlightRenderInstanceData.forEach(function(a){a.beginUpdate()});a=this._instanceData;var g=this._instanceData.view,h=a.capacity,e=this._instanceIndex;c=Math.min(a.size,c);for(var t=0;t<c;++t){0===e&&this.startUpdateCycle();var q=g.state.get(e),m=0;if(q&k.StateFlags.ALLOCATED){var n=g.lodLevel.get(e);q&k.StateFlags.ACTIVE&&this._renderInstanceData[n].freeTail();
q&k.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[n].freeTail();if(q&k.StateFlags.REMOVE)a.freeInstance(e);else if(q&k.StateFlags.VISIBLE){n=0;b&&(g.modelOrigin.getVec(e,M),n=f.selectLevel(M,a.getCombinedMedianScaleFactor(e)));m=q&~(k.StateFlags.ACTIVE|k.StateFlags.HIGHLIGHT_ACTIVE|k.StateFlags.TRANSFORM_CHANGED);if(0<=n){var l=this._renderInstanceData[n],p=l.allocateHead();F(g,e,l.view,p);m|=k.StateFlags.ACTIVE;q&k.StateFlags.HIGHLIGHT&&(l=this._highlightRenderInstanceData[n],p=
l.allocateHead(),F(g,e,l.view,p),m|=k.StateFlags.HIGHLIGHT_ACTIVE)}g.state.set(e,m);g.lodLevel.set(e,n)}else m=q&~(k.StateFlags.ACTIVE|k.StateFlags.HIGHLIGHT_ACTIVE|k.StateFlags.TRANSFORM_CHANGED),g.state.set(e,m);this._octree&&(n=!!(q&k.StateFlags.ACTIVE),m=!!(m&k.StateFlags.ACTIVE),!n&&m?this._octree.addInstance(e):n&&!m?this._octree.removeInstance(e):n&&m&&q&k.StateFlags.TRANSFORM_CHANGED&&(this._octree.removeInstance(e),this._octree.addInstance(e)));e=(e+1)%h}else e=(e+1)%h,c++}this._instanceIndex=
e;this._renderInstanceData.forEach(function(a){a.endUpdate()});this._highlightRenderInstanceData.forEach(function(a){a.endUpdate()})};b.prototype.renderLevel=function(a,c,b,f,g){var d=this;this._levels[g].components.forEach(function(e){d.renderComponent(a,c,b,f,e,g)})};b.prototype.renderComponent=function(a,c,b,f,g,h){var e=g.glMaterials[a.pass];if(e&&e.beginSlot(c)&&e.isVisible()&&e.isVisibleInPass(a.pass)&&0!==f.size){var d=a.rctx,k=d.capabilities.instancing,m=e.getDrawMode();b.origin=[0,0,0];e.bind(d,
b);d.bindVAO(g.vao);c=e.getProgram();c.assertCompatibleVertexAttributeLocations(g.vao);a.isHighlightPass&&(d.bindTexture(a.offscreenRenderingHelper?a.offscreenRenderingHelper.depthTexture:null,5),c.setUniform1i("depthTex",5),c.setUniform4f("highlightViewportPixelSz",0,0,1/b.viewport[2],1/b.viewport[3]));e.bindView(b);B.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===a.pass&&(c.setUniform4fv("externalColor",N[Math.min(h,N.length-1)]),c.setUniform1i("colorMixMode",V.colorMixModes.replace));a=f.capacity;
b=f.headIndex;h=f.tailIndex;c=f.firstIndex;var n=this._glInstanceBufferLayout,l=function(a,b){E.bindVertexBufferLayout(d,y.Default3D,f.buffer,n,a);k.drawArraysInstanced(m,0,g.vertexCount,b-a);E.unbindVertexBufferLayout(d,y.Default3D,f.buffer,n)};g.material.getParameters().transparent&&null!=c?b>h?(x.assert(c>=h&&c<=b,"invalid firstIndex"),l(c,b),l(h,c)):b<h&&(c<=b?(x.assert(0<=c&&c<=b,"invalid firstIndex"),l(c,b),l(h,a),l(0,c)):(x.assert(c>=h&&c<=a,"invalid firstIndex"),l(c,a),l(0,b),l(h,c))):b>h?
l(h,b):b<h&&(l(0,b),l(h,a));d.bindVAO(null);e.release()}};return b}();r.LodRenderer=A;r.lodRenderers=[];var M=v.vec3f64.create(),p=P.vec4f64.create(),J=O.mat4f64.create(),K=v.vec3f64.create(),L=v.vec3f64.create(),N=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]]});