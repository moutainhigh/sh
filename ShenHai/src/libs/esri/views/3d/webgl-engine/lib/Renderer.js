// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/Handles ../../../../core/maybe ../../../../core/TimeProfiler ../../../../core/watchUtils ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/vec2f64 ../../support/debugFlags ./BoundingInfo ./depthRange ./depthRangeUtils ./FxaaRenderPass ./HighlightHelper ./OffscreenRenderingHelper ./RenderContext ./RenderPluginManager ./renderStats ./ShadowMap ./SliceHelper ./SmaaRenderPass ./SSAOHelper ./Util ./edgeRendering/EdgeView ../lighting/SceneLighting ../materials/HUDMaterial ../materials/internal/waterMaterialUtils ../../../webgl/Profiling ../../../webgl/Texture".split(" "),
function(t,V,x,y,u,z,p,A,q,B,C,D,E,F,G,H,I,v,J,K,L,M,N,O,P,Q,R,S,T){function U(b,a){for(var c=new Map,h=null,d=null,f=function(a){if(a===h)return d;var b=c.get(a);b||(b={toAdd:[],numToAdd:-1,toRemove:[],numToRemove:-1,toUpdate:[],numToUpdate:-1},c.set(a,b));h=a;return d=b},e=0;e<b.numToAdd;e++){var g=b.toAdd[e];if(1<=r(g.data)){var l=f(g.material);l.toAdd.push(g)}}for(e=0;e<b.numToRemove;e++)g=b.toRemove[e],1<=r(g.data)&&(l=f(g.material),l.toRemove.push(g));for(e=g=0;e<b.numToUpdate;e++){var k=b.toUpdate[e];
1<=r(k.renderGeometry.data)&&(l=f(k.renderGeometry.material),l.toUpdate.push(k),g|=k.updateType)}a&&(a.updateTypes=g);return c}function r(b){return!1===b.preinterleaved?N.getFirstObjectValue(b.indices).length:b.indexCount}function w(b,a){return b.isVisible()&&b.isVisibleInPass(a.pass)&&0!==(b.renderOccluded&a.renderOccludedMask)}t=function(){function b(a,c,b,d,f,e,g,l){var h=this;this.requestRender=g;this._materialRenderers=new Map;this._orderedMaterialRenderers=[];this._hasHighlights=!1;this._lighting=
new P.SceneLighting;this._content=new Map;this._isRendering=!1;this._fallbackDepthStencilTexture=null;this._stats={scene:new v.RenderStatsAggregator,draped:new v.RenderStatsAggregator};this._edgeView=null;this._handles=new x;this.renderOptions={antialiasing:"smaa"};this.renderHiddenTransparentEdges=function(){};this._programRep=a;this._materialRep=c;this._rctx=f;this._mode=e;this._stage=l;this._shaderTechniqueRepository=d;this._fxaaPass=new E(f);this._smaaPass=new L(f);this._bindParameters={view:null,
proj:null,viewInvTransp:null,fovY:0,nearFar:null,viewport:null,shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,pixelRatio:null,slicePlane:null,slicePlaneEnabled:!1};this._offscreenRendering=new G(a,this._rctx);this._sliceHelper=new K;"scene"===this._mode&&(this._shadowMap=new J(this._rctx),this._ssaoHelper=new M(d,this._rctx,function(){return h.requestRender()}),this._highlightHelper=new F(a,this._rctx));this._renderPlugins=new I.RenderPluginManager({rctx:f,programRep:a,shaderTechniqueRep:d,textureRep:b,
materialRep:c,requestRender:this.requestRender});this._renderContext=new H(f,this._offscreenRendering,this._lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper);this._handles.add(z.init(q,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",function(a){h.renderHiddenTransparentEdges=a?function(){return h.renderEdges(1)}:function(){};h.requestRender()}))}b.prototype.dispose=function(){this._handles.destroy();this._materialRenderers.forEach(function(a){a.dispose()});this._orderedMaterialRenderers=this._materialRenderers=
null;this._edgeView&&(this._edgeView.destroy(),this._edgeView=null);this._offscreenRendering.enabled=!1;this._fallbackDepthStencilTexture&&(this._fallbackDepthStencilTexture.dispose(),this._fallbackDepthStencilTexture=null);this._shadowMap&&(this._shadowMap.enabled=!1,this._shadowMap.dispose());this._ssaoHelper&&(this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose());this._highlightHelper&&(this._highlightHelper.enabled=!1);B.tmpIndices.prune();this._content.clear();this._content=null};Object.defineProperty(b.prototype,
"updating",{get:function(){return"smaa"===this.renderOptions.antialiasing&&this._smaaPass.isLoadingResources||R.waterTextureRepo.loading()},enumerable:!0,configurable:!0});b.prototype.ensureEdgeView=function(){var a=this;null==this._edgeView&&(this._edgeView=new O.EdgeView(this._rctx,this._shaderTechniqueRepository,{setNeedsRender:function(){return a.requestRender()}}),this._edgeView.initialize());return this._edgeView};Object.defineProperty(b.prototype,"edgeView",{get:function(){return this._edgeView},
enumerable:!0,configurable:!0});b.prototype.setLighting=function(a){this._lighting.set(a)};b.prototype.setRenderParams=function(a){void 0!==a.shadowMapResolution&&!1===this._shadowMap.enabled&&(this._shadowMap.textureResolution=a.shadowMapResolution);void 0!==a.shadowMap&&(this._shadowMap.enabled=a.shadowMap);void 0!==a.shadowMapMaxCascades&&(this._shadowMap.maxCascades=a.shadowMapMaxCascades);this._highlightHelper.enabled=!0;void 0!==a.ssao&&(this._ssaoHelper.enabled=a.ssao);void 0!==a.ssaoAttenuation&&
(this._ssaoHelper.attenuation=a.ssaoAttenuation);void 0!==a.ssaoRadius&&(this._ssaoHelper.radius=a.ssaoRadius);void 0!==a.ssaoFilterRadius&&console.error("The property ssaoFilterRadius is no longer supported as a render parameter.");void 0!==a.ssaoSamples&&(this._ssaoHelper.samples=a.ssaoSamples);a.background&&(this._offscreenRendering.background=a.background);void 0!==a.antialiasingEnabled&&(this.renderOptions.antialiasing=a.antialiasingEnabled?"smaa":"none");void 0!==a.defaultHighlightOptions&&
this._highlightHelper.setDefaultOptions(a.defaultHighlightOptions);void 0!==a.slicePlane&&(this._sliceHelper.plane=a.slicePlane);this.requestRender()};Object.defineProperty(b.prototype,"hasSlicePlane",{get:function(){return!!this._sliceHelper.plane},enumerable:!0,configurable:!0});b.prototype.getRenderParams=function(){var a={};this._shadowMap&&(a.shadowMap=this._shadowMap.enabled,a.shadowMapResolution=this._shadowMap.textureResolution,a.shadowMapMaxCascades=this._shadowMap.maxCascades);this._ssaoHelper&&
this._ssaoHelper.isSupported&&(a.ssao=this._ssaoHelper.enabled,a.ssaoAttenuation=this._ssaoHelper.attenuation,a.ssaoRadius=this._ssaoHelper.radius,a.ssaoFilterRadius=this._ssaoHelper.filterRadius,a.ssaoSamples=this._ssaoHelper.samples);return a};Object.defineProperty(b.prototype,"renderPlugins",{get:function(){return this._renderPlugins},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"canRender",{get:function(){return!0},enumerable:!0,configurable:!0});b.prototype.getCombinedStats=
function(){return{draped:this._stats.draped.getAggregatedStats(),scene:this._stats.scene.getAggregatedStats()}};b.prototype.getFramebufferTexture=function(a){switch(a){case "color":return this._offscreenRendering.colorTexture;case "hudVisibility":return this._offscreenRendering.hudVisibilityTexture;case "shadowMap":return this._shadowMap&&this._shadowMap.getDepthTexture();case "linearDepth":return this._offscreenRendering.linearDepthTexture;case "normals":return this._offscreenRendering.normalTexture;
case "highlight":return this._offscreenRendering.highlightTexture}return null};Object.defineProperty(b.prototype,"hasHighlights",{get:function(){return this._hasHighlights},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"hasWater",{get:function(){return this._orderedMaterialRenderers.some(function(a){return a.hasWater()})},enumerable:!0,configurable:!0});b.prototype.isEmpty=function(){return 0===this._materialRenderers.size};b.prototype.modify=function(a,c,b,d,f,e,g){var h=this;
void 0===c&&(c=a?a.length:0);void 0===d&&(d=b?b.length:0);void 0===e&&(e=f?f.length:0);this._isRendering&&console.warn("Renderer.modify called while rendering");for(var k=0;k<d;++k)this._content.delete(b[k].uniqueName);for(k=0;k<c;++k)this._content.set(a[k].uniqueName,a[k]);if(c||d||e){var n=!1;U({toAdd:a,numToAdd:c,toRemove:b,numToRemove:d,toUpdate:f,numToUpdate:e}).forEach(function(a,c){var b=h._materialRenderers.get(c);!b&&0<a.toAdd.length&&(b=c.createRenderer(h._rctx,h._materialRep),h._materialRenderers.set(c,
b),h._orderedMaterialRenderers.push(b),h.sortOrderedMaterialRenderers());b&&(b.modify(a),b.isEmpty&&(n=!0))});n&&this._materialRenderers.forEach(function(a,c){a.isEmpty&&(h._materialRenderers.delete(c),h._orderedMaterialRenderers.splice(h._orderedMaterialRenderers.indexOf(a),1),a.dispose())});var m=!1;this._materialRenderers.forEach(function(a){m=m||a.hasHighlights});if(m!==this._hasHighlights){if(this.onHasHighlightsChanged)this.onHasHighlightsChanged(m);this._hasHighlights=m}this.requestRender()}g&&
(g.forEach(function(a){h._materialRep.updateMaterialParameters(a)}),this.requestRender())};b.prototype.modifyRenderOrder=function(){"draped"===this._mode&&(this.sortOrderedMaterialRenderers(),this.requestRender())};b.prototype.updateLogic=function(a){var c=!1;this._orderedMaterialRenderers.forEach(function(b){b.updateLogic&&(c=b.updateLogic(a)||c)});return c};b.prototype.render=function(a){switch(this._mode){case "scene":this.renderScene(a)}if(this.onPostRender)this.onPostRender()};b.prototype.renderScene=
function(a){var c=this;this._isRendering=!0;var b=this._rctx,d=this._offscreenRendering,f=a.camera,e=a.fbo,g=this._sliceHelper.plane;a.disableSlice&&(this._sliceHelper.plane=null);this._renderPlugins.prepareRender(f);this.renderShadowMap(a);d.enabled=!0;d.initializeFrame(f,e);this.renderLinearDepth(a);this.renderNormal(a);this._ssaoHelper.enabled&&this._ssaoHelper.computeSSAO(f,d.linearDepthTexture,d.normalTexture);this._ssaoHelper.bindToAllPrograms(this._programRep);this._ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository);
this._stats.scene.reset();this.updateGlobalUniforms(f.projectionMatrix);this._renderContext.pass=0;this._renderContext.camera=f;this._renderContext.options=this.renderOptions;d.bindTarget(d.mainColor,d.mainDepth);this._renderPlugins.render(0,this._renderContext);this.renderOpaqueGeometry(this._renderContext);this.renderEdges(2);this.renderHiddenTransparentEdges();this.renderTransparentGeometry(this._renderContext);this.renderEdges(1);var l=f=!1,f=this.renderHUDVisibility(this._renderContext);this.renderInternalSlot(17,
this._renderContext);(l=this.renderTransparentTerrain(this._renderContext))&&f&&(d.compositeTransparentTerrainOntoHUDVisibility(),d.renderToTargets(function(){return c.renderHUD("occluded")},d.mainColor,d.tmpDepth,void 0,!0));l&&d.compositeTransparentTerrainOntoMain();d.renderToTargets(function(){c.renderInternalSlot(9,c._renderContext);c._renderPlugins.render(13,c._renderContext);c._renderPlugins.render(14,c._renderContext)},d.mainColor,d.mainDepth);this.renderOccluded();this.renderAntiAliasing(e);
b.bindFramebuffer(e);b.clearSafe(256);this.renderHUD("notOccluded");this.renderHighlights(a,e);this._sliceHelper.plane=g;this._isRendering=!1};b.prototype.renderEdges=function(a){var c=this,b=this._edgeView;b&&b.shouldRender()&&this._offscreenRendering.renderAndComposite(function(){return b.render(c._bindParameters,a)},"alpha")};b.prototype.renderShadowMap=function(a){var c=this._shadowMap;if(c.enabled){q.ENABLE_PROFILE_DEPTH_RANGE&&u.begin("depthRange");var b=a.camera,d=a.fbo,f=a.lightDirection,
e=this.computeDepthRange(b);q.ENABLE_PROFILE_DEPTH_RANGE&&u.end("depthRange");c.prepare(b,f,e);f=c.getCascades();for(e=0;e<f.length;++e){var g=f[e];g.camera.setGLViewport(this._rctx);a.camera=g.camera;this.renderGeometryPass(3,a)}a.camera=b;c.finish(d);b.setGLViewport(this._rctx)}c.bindToAllPrograms(this._programRep);c.bindToAllPrograms(this._shaderTechniqueRepository)};b.prototype.renderLinearDepth=function(a){var c=this;this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth()?this._offscreenRendering.renderToTargets(function(){return c.renderGeometryPass(1,
a)},this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth)};b.prototype.renderNormal=function(a){var c=this;this._ssaoHelper.enabled?this._offscreenRendering.renderToTargets(function(){c.renderGeometryPass(2,a)},this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)};b.prototype.computeDepthRange=
function(a){var c=D.depthRangeFromScene(a,this._content,this._stage.getLayers());C.union(c,this.renderPlugins.queryDepthRange(a));c.near=Math.max(a.near,c.near);c.far=Math.min(a.far,c.far);return c};b.prototype.renderGeometryPass=function(a,c){this._isRendering=!0;c=c.camera;this.updateGlobalUniforms(c.projectionMatrix);this._renderContext.pass=a;this._renderContext.camera=c;this.renderGeometryPassScene(this._renderContext);this._isRendering=!1};b.prototype.renderGeometryPassDraped=function(a,c){if(0!==
c.numViews){this._isRendering=!0;this._renderContext.pass=a;this._bindParameters.slicePlane=this._renderContext.sliceHelper&&this._renderContext.sliceHelper.plane;this._bindParameters.highlightDepthTexture=this.getFallbackDepthTexture();a=c.camera;n[0]=a.near;n[1]=a.far;this._bindParameters.nearFar=n;this._bindParameters.pixelRatio=a.pixelRatio;var b=0,d=this._orderedMaterialRenderers;if(0===d.length&&c.predraw)for(var f=0;f<c.numViews;f++)this.setupDrapedContext(c.views[f],a),c.predraw();for(;b<
d.length;){for(var e=1<c.numViews?this.findDrapedLayerEndRange(d,b):d.length,f=0;f<c.numViews;f++){this.setupDrapedContext(c.views[f],a);0===b&&c.predraw&&c.predraw();for(var g=b;g<e;g++){var l=d[g],k=this._stats.draped.getMaterialRenderStatsObject(l.type);l.render(null,this._renderContext,this._bindParameters,k)}}b=e}this._isRendering=!1}};b.prototype.findDrapedLayerEndRange=function(a,c){var b=Math.floor(a[c].renderPriority()),d=a.length;for(c+=1;c<d;c++)if(Math.floor(a[c].renderPriority())!==b)return c;
return d};b.prototype.setupDrapedContext=function(a,c){c.viewport=a.viewport;p.mat4.ortho(c.projectionMatrix,0,a.extent[2]-a.extent[0],0,a.extent[3]-a.extent[1],c.near,c.far);p.mat4.identity(c.viewMatrix);p.mat4.translate(c.viewMatrix,c.viewMatrix,[-a.extent[0],-a.extent[1],0]);c.setGLViewport(this._rctx);this._renderContext.camera=c;this._bindParameters.view=c.viewMatrix;this._bindParameters.proj=c.projectionMatrix;this._bindParameters.viewInvTransp=c.viewInverseTransposeMatrix;this._bindParameters.viewport=
c.fullViewport;this.updateGlobalUniforms(c.projectionMatrix)};b.prototype.renderGeometryPassScene=function(a){this.renderGeometry(a);this.renderTransparentTerrain(a)};b.prototype.renderGeometry=function(a){this.renderOpaqueGeometry(a);this.renderTransparentGeometry(a)};b.prototype.renderOpaqueGeometry=function(a){this._renderPlugins.render(1,a);this._renderPlugins.render(2,a);this._renderPlugins.render(3,a);this.renderInternalSlot(4,a);this._renderPlugins.render(5,a);a.ssaoHelper&&(a.ssaoHelper.bindToAllPrograms(this._programRep),
a.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository));this._renderPlugins.render(12,this._renderContext)};b.prototype.renderTransparentGeometry=function(a){this.renderInternalSlot(6,a);this._renderPlugins.render(7,a);a.ssaoHelper&&(a.ssaoHelper.bindToAllPrograms(this._programRep),a.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository))};b.prototype.renderTransparentTerrain=function(a){return this._renderPlugins.render(8,a)};b.prototype.renderHUDVisibility=function(a){var c=this,
b=Q.shouldRenderVisibilityDuringRenderPass(a.pass),d=a.offscreenRenderingHelper&&a.offscreenRenderingHelper.enabled,f=!1;b&&d&&a.offscreenRenderingHelper.renderHUDVisibility(function(){f=c.renderInternalSlot(10,a)});return f};b.prototype.renderHUD=function(a){this._bindParameters.renderTransparentlyOccludedHUD=a;this.renderInternalSlot(18,this._renderContext);this.renderInternalSlot(15,this._renderContext);this.renderInternalSlot(16,this._renderContext)};b.prototype.renderHighlights=function(a,c){var b=
this,d=this._highlightHelper;if(d&&d.enabled&&(this.hasHighlights||this._renderPlugins.needsHighlight())){var f=null;d.profilingCallback&&(f=S.startMeasurement(this._renderContext.rctx));var e=this._offscreenRendering;this._renderContext.highlightDepthTexture=this._bindParameters.highlightDepthTexture;e=e.renderToTargets(function(){b.renderGeometryPass(4,a);b._rctx.clearSafe(256);b.renderHUD("both")},e.highlight,e.tmpDepth,[0,0,0,0],!0);d.render(a.camera,e,c);null!==f&&d.profilingCallback&&f.stop(function(a){d.profilingCallback&&
d.profilingCallback(a)})}else this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight)};b.prototype.renderOccluded=function(){var a=this;this._materialRenderers.forEach(function(a,c){c&&c.isVisible()&&1!==c.renderOccluded&&m.push(c)});if(0!==m.length){var c=this._offscreenRendering,b=this._renderContext,d=function(d,e){b.renderOccludedMask=e;c.renderToTargets(function(){a.renderInternalSlot(4,b,m);a.renderInternalSlot(6,b,m);a.renderInternalSlot(9,b,m)},c.tmpColor,c.tmpDepth,[0,
0,0,0],!0);b.resetRenderOccludedMask();c.compositeOccludedOntoMain(d)};b.pass=0;d(.4,4);d(.5,2);d(1,8);m.length=0}};b.prototype.renderAntiAliasing=function(a){var c=this;switch(this.renderOptions.antialiasing){case "smaa":this._smaaPass.loadResources(function(){return c.requestRender()});this._smaaPass.enable()?(this._fxaaPass.disable(),this._smaaPass.render({colorTexture:this._offscreenRendering.colorTexture},a)):this._offscreenRendering.composite();break;case "fxaa":this._fxaaPass.enable()?(this._smaaPass.disable(),
this._fxaaPass.render({colorTexture:this._offscreenRendering.colorTexture},a)):this._offscreenRendering.composite();break;default:this._offscreenRendering.composite(),this._fxaaPass.disable(),this._smaaPass.disable()}};b.prototype.renderInternalSlot=function(a,c,b){this._bindParameters.view=c.camera.viewMatrix;this._bindParameters.proj=c.camera.projectionMatrix;this._bindParameters.viewInvTransp=c.camera.viewInverseTransposeMatrix;this._bindParameters.cameraAboveGround=c.camera.aboveGround;this._bindParameters.fovY=
c.camera.fovY;n[0]=c.camera.near;n[1]=c.camera.far;var d=this._renderContext.offscreenRenderingHelper;this._bindParameters.nearFar=n;this._bindParameters.viewport=c.camera.fullViewport;this._bindParameters.shadowMap=c.shadowMap;this._bindParameters.shadowMappingEnabled=!!c.shadowMap&&c.shadowMap.enabled;this._bindParameters.ssaoEnabled=!!c.ssaoHelper&&c.ssaoHelper.enabled;this._bindParameters.pixelRatio=c.camera.pixelRatio;this._bindParameters.slicePlane=c.sliceHelper&&c.sliceHelper.plane;this._bindParameters.hudVisibilityTexture=
d?d.hudVisibilityTexture:null;this._bindParameters.highlightDepthTexture=d&&d.depthTexture||this.getFallbackDepthTexture();return this.renderInternalSlotMaterials(a,c,b)};b.prototype.renderInternalSlotMaterials=function(a,c,b){var d=this,f=0===c.pass?this._stats.scene:null,e=!1;y.isSome(b)?b.forEach(function(b){w(b,c)&&(e=d._materialRenderers.get(b).render(a,c,d._bindParameters)||e)}):this._materialRenderers.forEach(function(b,h){w(h,c)&&(h=f?f.getMaterialRenderStatsObject(b.type):null,e=b.render(a,
c,d._bindParameters,h)||e)});return e};b.prototype.updateGlobalUniforms=function(a){for(var c=this._programRep.getProgramsUsingUniform("proj"),b=0;b<c.length;b++)c[b].setUniformMatrix4fv("proj",a);if(this._lighting)for(c=this._programRep.getProgramsUsingUniform("lightingMainDirection"),b=0;b<c.length;b++)this._lighting.setUniforms(c[b]);c=this._shaderTechniqueRepository.getProgramsUsingUniform("proj");for(b=0;b<c.length;b++)c[b].setUniformMatrix4fv("proj",a);if(this._lighting)for(c=this._shaderTechniqueRepository.getProgramsUsingUniform("lightingMainDirection"),
b=0;b<c.length;b++)this._lighting.setUniforms(c[b])};b.prototype.sortOrderedMaterialRenderers=function(){"draped"===this._mode&&this._orderedMaterialRenderers.sort(function(a,b){return b.renderPriority()-a.renderPriority()})};b.prototype.getFallbackDepthTexture=function(){this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=new T(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([255,255,255,255])));return this._fallbackDepthStencilTexture};
b.prototype.getGpuMemoryUsage=function(){return{offscreen:this._offscreenRendering?this._offscreenRendering.getGpuMemoryUsage():0,highlights:this._highlightHelper?this._highlightHelper.getGpuMemoryUsage():0,shadows:this._shadowMap?this._shadowMap.getGpuMemoryUsage():0,ssao:this._ssaoHelper?this._ssaoHelper.getGpuMemoryUsage():0}};b.prototype.forEachRenderGeometry=function(a){this._content.forEach(function(b){return a(b)})};Object.defineProperty(b.prototype,"test",{get:function(){return{orderedMaterialRenderers:this._orderedMaterialRenderers}},
enumerable:!0,configurable:!0});return b}();var n=A.vec2f64.create(),m=[];return t});