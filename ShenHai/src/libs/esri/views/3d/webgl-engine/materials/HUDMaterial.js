// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/mat3 ../../../../core/libs/gl-matrix-2/mat3f64 ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/types/mat4 ../../../../geometry/support/aaBoundingRect ../../support/buffer/InterleavedLayout ../lib/ComponentUtils ../lib/geometryDataUtils ../lib/GLMaterialTexture ../lib/Material ../lib/screenSizePerspectiveUtils ../lib/Util ./internal/bufferWriterUtils ./internal/MaterialUtil ./renderers/MergedRenderer ../shaders/HUDPrograms ../../../webgl/renderState".split(" "),
function(P,va,K,ba,Q,ca,da,R,S,T,h,A,ea,fa,ga,ha,ia,F,ja,G,f,y,k,ka,L,t){function M(c,b,a){c.setUniform1f("cameraGroundRelative",a.cameraAboveGround?1:-1);c.setUniform1f("polygonOffset",b.shaderPolygonOffset);c.setUniform4fv("viewport",a.viewport);c.setUniform1f("perDistancePixelRatio",Math.tan(a.fovY/2)/(a.viewport[2]/2));k.bindVerticalOffset(b.verticalOffset,a,c);c.setUniformMatrix4fv("viewNormal",a.viewInvTransp);b.screenSizePerspective&&(k.bindScreenSizePerspective(b.screenSizePerspective,c,"screenSizePerspective"),
k.bindScreenSizePerspective(b.screenSizePerspectiveAlignment||b.screenSizePerspective,c,"screenSizePerspectiveAlignment"))}function U(c,b,a,d){a.occlusionTest&&(b.setUniform1i("hudVisibilityTexture",1),c.bindTexture(d.hudVisibilityTexture,1),c.setActiveTexture(0));b.setUniform1f("uRenderTransparentlyOccludedHUD","occluded"===d.renderTransparentlyOccludedHUD?1:"notOccluded"===d.renderTransparentlyOccludedHUD?0:.75);c=d.pixelRatio||1;b.setUniform4fv("overrideColor",a.color);b.setUniform1f("pixelRatio",
c);a.textureIsSignedDistanceField&&(b.setUniform4fv("outlineColor",a.outlineColor),b.setUniform1f("outlineSize",a.outlineSize));a.vvSizeEnabled&&(b.setUniform3fv("vvSizeMinSize",a.vvSizeMinSize),b.setUniform3fv("vvSizeMaxSize",a.vvSizeMaxSize),b.setUniform3fv("vvSizeOffset",a.vvSizeOffset),b.setUniform3fv("vvSizeFactor",a.vvSizeFactor));a.vvColorEnabled&&(b.setUniform1fv("vvColorValues",a.vvColorValues),b.setUniform4fv("vvColorColors",a.vvColorColors));b.setUniform2f("screenOffset",2*a.screenOffset[0]*
c,2*a.screenOffset[1]*c);b.setUniform2fv("anchorPos",H(a))}function H(c,b){void 0===b&&(b=V);if(c.textureIsSignedDistanceField){var a=c.anchorPos;c=c.distanceFieldBoundingBox;var d=b;d[0]=a[0]*(c[2]-c[0])+c[0];d[1]=a[1]*(c[3]-c[1])+c[1]}else S.vec2.copy(b,c.anchorPos);return b}P=function(c){function b(a,b){b=c.call(this,b)||this;b.params=k.copyParameters(a,la);return b}K(b,c);b.prototype.dispose=function(){};b.prototype.setParameterValues=function(a){for(var b in a)"textureId"===b&&f.assert(!!this.params.textureId,
"Can only change texture of material that already has a texture"),this.params[b]=a[b];this.notifyDirty("matChanged")};b.prototype.getParameters=function(){return this.params};b.prototype.intersect=function(a,b,g,n,B,e,c,f,m){m?this.intersectDrapedRenderHudGeometry(a,e,c,f):this.intersectHudGeometry(a,b,g,n,c,f)};b.prototype.intersectDrapedRenderHudGeometry=function(a,b,g,n){var d=a.getAttribute(f.VertexAttrConstants.POSITION),e=a.getAttribute(f.VertexAttrConstants.SIZE),c=this.params,ma=H(c),m=1,
q=1;n&&(q=n(W),m=q[0],q=q[5]);m*=a.pixelRatio;q*=a.pixelRatio;n=na*a.pixelRatio;for(var I=0;I<d.data.length/d.size;I++){var r=I*d.size;h.vec3.set(p,d.data[r],d.data[r+1],d.data[r+2]);r=I*e.size;u[0]=e.data[r]*m;u[1]=e.data[r+1]*q;var r=p[0],k=p[1],v=void 0;c.textureIsSignedDistanceField&&(v=c.outlineSize*a.pixelRatio/2);this._isInsideIconBoundaries(b,r,k,n,v,c,ma)&&g()}};b.prototype.intersectHudGeometry=function(a,b,g,n,c,e){if(n.options.selectionMode&&n.options.hud&&!ha.isAllHidden(b.componentVisibilities,
a.componentOffsets)){var d=a.data;a=this.params;var B=b=1;Q.mat3.fromMat4(J,g);if(e){B=e(W);b=B[0];B=B[5];e=J;var m=e[0],q=e[1],k=e[2],r=e[3],t=e[4],D=e[5],x=e[6],l=e[7],w=e[8],z=1/Math.sqrt(m*m+q*q+k*k),E=1/Math.sqrt(r*r+t*t+D*D),y=1/Math.sqrt(x*x+l*l+w*w);e[0]=m*z;e[1]=q*z;e[2]=k*z;e[3]=r*E;e[4]=t*E;e[5]=D*E;e[6]=x*y;e[7]=l*y;e[8]=w*y}e=d.getVertexAttr()[f.VertexAttrConstants.POSITION];m=d.getVertexAttr()[f.VertexAttrConstants.SIZE];q=d.getVertexAttr()[f.VertexAttrConstants.NORMAL];d=d.getVertexAttr()[f.VertexAttrConstants.AUXPOS1];
f.assert(3<=e.size);k=n.point;r=n.camera;t=H(a);b*=r.pixelRatio;B*=r.pixelRatio;D="screen"===this.params.centerOffsetUnits;for(x=0;x<e.data.length/e.size;x++)l=x*e.size,h.vec3.set(p,e.data[l],e.data[l+1],e.data[l+2]),h.vec3.transformMat4(p,p,g),l=x*m.size,u[0]=m.data[l]*b,u[1]=m.data[l+1]*B,h.vec3.transformMat4(p,p,r.viewMatrix),l=x*d.size,h.vec3.set(v,d.data[l+0],d.data[l+1],d.data[l+2]),D||(p[0]+=v[0],p[1]+=v[1],0!==v[2]&&(l=v[2],h.vec3.normalize(v,p),h.vec3.subtract(p,p,h.vec3.scale(v,v,l)))),
l=x*q.size,h.vec3.set(X,q.data[l],q.data[l+1],q.data[l+2]),this.applyVerticalOffsetTransformation(p,X,J,r,N),r.applyProjection(p,C),-1<C[0]&&(l=Math.floor(C[0])+this.params.screenOffset[0],w=Math.floor(C[1])+this.params.screenOffset[1],D&&(l+=v[0],0!==v[1]&&(w+=G.applyScaleFactor(v[1],N.factorAlignment))),G.applyPrecomputedScaleFactorVec2(u,N.factor,u),z=oa*r.pixelRatio,E=void 0,a.textureIsSignedDistanceField&&(E=a.outlineSize*r.pixelRatio/2),this._isInsideIconBoundaries(k,l,w,z,E,a,t)&&(w=n.ray,
h.vec3.transformMat4(Y,p,da.mat4.invert(pa,r.viewMatrix)),C[0]=k[0],C[1]=k[1],r.unprojectPoint(C,p),l=A.vec3f64.create(),h.vec3.copy(l,w.direction),z=1/h.vec3.length(l),h.vec3.scale(l,l,z),w=h.vec3.distance(w.origin,p)*z,c(w,l,-1,1,!0,Y)))}};b.prototype.computeAttachmentOrigin=function(a,b){a=a.data;var d="getVertexAttr"in a?a.getVertexAttr():"vertexAttr"in a?a.vertexAttr:null;if(!d)return null;var n=f.VertexAttrConstants.POSITION,d=d[n];a="getIndices"in a?a.getIndices(n):"indices"in a?a.indices[n]:
null;return ia.computeAttachmentOriginPoints(d,a,b)};b.prototype._isInsideIconBoundaries=function(a,b,g,n,c,e,f){b=b-n-(0<f[0]?u[0]*f[0]:0);var d=b+u[0]+2*n;g=g-n-(0<f[1]?u[1]*f[1]:0);n=g+u[1]+2*n;e.textureIsSignedDistanceField&&(e=e.distanceFieldBoundingBox,b+=u[0]*e[0],g+=u[1]*e[1],d-=u[0]*(1-e[2]),n-=u[1]*(1-e[3]),b-=c,d+=c,g-=c,n+=c);return a[0]>b&&a[0]<d&&a[1]>g&&a[1]<n};b.prototype.createBufferWriter=function(){return new qa(this)};b.prototype.createRenderer=function(a,b){return new ka(a,b,
this)};b.prototype.normalAndViewAngle=function(a,b,g,c){void 0===c&&(c=O);h.vec3.transformMat3(c.normal,a,b);h.vec3.transformMat4(c.normal,c.normal,g.viewInverseTransposeMatrix);c.cosAngle=h.vec3.dot(Z,ra);return c};b.prototype.updateScaleInfo=function(a,b){var d=this.params;d.screenSizePerspective?a.factor=G.precomputeScaleFactor(O.cosAngle,b,d.screenSizePerspective,a.factor):(a.factor.scale=1,a.factor.factor=0,a.factor.minPixelSize=0,a.factor.paddingPixels=0);d.screenSizePerspectiveAlignment?a.factorAlignment=
G.precomputeScaleFactor(O.cosAngle,b,d.screenSizePerspectiveAlignment,a.factorAlignment):(a.factorAlignment.factor=a.factor.factor,a.factorAlignment.scale=a.factor.scale,a.factorAlignment.minPixelSize=a.factor.minPixelSize,a.factorAlignment.paddingPixels=a.factor.paddingPixels)};b.prototype.applyVerticalOffsetTransformation=function(a,b,g,c,f,e){var d=this.params;ea.isMat4(g)&&(g=Q.mat3.fromMat4(J,g));if(!d.verticalOffset||!d.verticalOffset.screenLength)return f&&(d.screenSizePerspective||d.screenSizePerspectiveAlignment)?
(c=h.vec3.length(a),this.updateScaleInfo(f,c)):f&&(f.factor.scale=1,f.factorAlignment.scale=1),e?h.vec3.copy(e,a):a;b=this.normalAndViewAngle(b,g,c);g=h.vec3.length(a);c=k.verticalOffsetAtDistance(c,g,d.verticalOffset,b.cosAngle,d.screenSizePerspectiveAlignment||d.screenSizePerspective);f&&this.updateScaleInfo(f,g);return h.vec3.add(e||a,a,h.vec3.scale(b.normal,b.normal,c))};b.prototype.getGLMaterials=function(){return{color:sa,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:ta}};b.prototype.calculateRelativeScreenBounds=
function(a,b,c){void 0===c&&(c=fa.create());var d=this.params,g=c;void 0===g&&(g=V);S.vec2.copy(g,d.anchorPos);g[0]*=-a[0];g[1]*=-a[1];g[0]+=d.screenOffset[0]*b;g[1]+=d.screenOffset[1]*b;c[2]=c[0]+a[0];c[3]=c[1]+a[1];return c};b.prototype.calculateAnchorPosForRendering=function(a){return H(this.params,a)};b.shouldRenderVisibilityDuringRenderPass=function(a){return 0===a||4};return b}(ja.Material);var sa=function(c){function b(a){a=c.call(this,F.makeCtorParameters(a,a.material.getParameters()))||this;
a.isOcclusionSlot=!1;a.updateParameters();return a}K(b,c);b.prototype.selectSlot=function(){this.mainSlot=this.params.drawInSecondSlot?16:15};b.prototype.selectProgram=function(){var a=this.params;this.occlusionProgram=this.programRep.getProgram(L.occlusionPass,{verticalOffset:!!a.verticalOffset,screenSizePerspective:!!a.screenSizePerspective,centerOffsetUnitsScreen:"screen"===a.centerOffsetUnits,slice:a.slicePlaneEnabled});this.renderProgram=this.programRep.getProgram(L.colorPass,{occlTest:a.occlusionTest,
sdf:a.textureIsSignedDistanceField,vvSize:!!a.vvSizeEnabled,vvColor:!!a.vvColorEnabled,verticalOffset:!!a.verticalOffset,screenSizePerspective:!!a.screenSizePerspective,centerOffsetUnitsScreen:"screen"===a.centerOffsetUnits,debugDrawBorder:!!a.debugDrawBorder,slice:a.slicePlaneEnabled});this.renderPipelineState=t.makePipelineState({blending:t.simpleBlendingParams(1,771),polygonOffset:a.polygonOffset&&aa,depthTest:{func:515},depthWrite:t.defaultDepthWriteParams,colorWrite:t.defaultColorWriteParams});
this.occlusionPipelineState=t.makePipelineState({depthTest:{func:515},depthWrite:t.defaultDepthWriteParams,colorWrite:t.defaultColorWriteParams})};b.prototype.beginSlot=function(a){if(this.params.occlusionTest)return this.isOcclusionSlot=10===a,10===a||a===this.mainSlot;this.isOcclusionSlot=!1;return a===this.mainSlot};b.prototype.getProgram=function(){return this.isOcclusionSlot?this.occlusionProgram:this.renderProgram};b.prototype.getPrograms=function(){return[this.occlusionProgram,this.renderProgram]};
b.prototype.updateParameters=function(){this.params=k.copyParameters(this.material.getParameters());this.updateTexture(this.params.textureId);this.selectProgram();this.selectSlot()};b.prototype.bind=function(a,b){if(this.isOcclusionSlot){var c=this.occlusionProgram;a.bindProgram(c);a.setPipelineState(this.occlusionPipelineState);M(c,this.params,b);c.setUniform4f("color",1,1,1,1);c.setUniform1f("pixelRatio",b.pixelRatio||1)}else c=this.renderProgram,a.bindProgram(c),a.setPipelineState(this.renderPipelineState),
this.bindTexture(a,c),this.bindTextureScale(a,c),M(c,this.params,b),U(a,c,this.params,b)};b.prototype.bindView=function(a){var b=a.origin,c=this.getProgram();k.bindView(b,a.view,c);k.bindCamPos(b,a.viewInvTransp,c);this.params.slicePlaneEnabled&&k.bindSlicePlane(a.origin,a.slicePlane,c)};b.prototype.bindInstance=function(a){var b=this.getProgram();b.setUniformMatrix4fv("model",a.transformation);b.setUniformMatrix4fv("modelNormal",a.transformationNormal)};b.prototype.release=function(){};b.prototype.getDrawMode=
function(){return this.isOcclusionSlot?0:4};return b}(F),ta=function(c){function b(a){a=c.call(this,F.makeCtorParameters(a,a.material.getParameters()))||this;a.updateParameters();return a}K(b,c);b.prototype.selectSlot=function(){this.mainSlot=this.params.drawInSecondSlot?16:15};b.prototype.beginSlot=function(a){return a===this.mainSlot};b.prototype.getProgram=function(){return this.program};b.prototype.updateParameters=function(){this.params=k.copyParameters(this.material.getParameters());this.updateTexture(this.params.textureId);
this.selectProgram();this.selectSlot()};b.prototype.selectProgram=function(){var a=this.params;this.program=this.programRep.getProgram(L.highlightPass,{occlTest:a.occlusionTest,sdf:a.textureIsSignedDistanceField,vvSize:!!a.vvSizeEnabled,vvColor:!!a.vvColorEnabled,verticalOffset:!!a.verticalOffset,screenSizePerspective:!!a.screenSizePerspective,centerOffsetUnitsScreen:"screen"===a.centerOffsetUnits,binaryHighlightOcclusion:a.binaryHighlightOcclusion,slice:a.slicePlaneEnabled});this.pipelineState=t.makePipelineState({blending:t.separateBlendingParams(1,
1,771,771),polygonOffset:a.polygonOffset&&aa,depthTest:{func:513},colorWrite:t.defaultColorWriteParams})};b.prototype.bind=function(a,b){var c=this.program;a.bindProgram(c);a.setPipelineState(this.pipelineState);this.bindTexture(a,c);this.bindTextureScale(a,c);M(c,this.params,b);U(a,c,this.params,b);k.bindHighlightRendering(a,b,this.program)};b.prototype.bindView=function(a){var b=a.origin,c=this.getProgram();k.bindView(b,a.view,c);k.bindCamPos(b,a.viewInvTransp,c);this.params.slicePlaneEnabled&&
k.bindSlicePlane(a.origin,a.slicePlane,c)};b.prototype.bindInstance=function(a){var b=this.getProgram();b.setUniformMatrix4fv("model",a.transformation);b.setUniformMatrix4fv("modelNormal",a.transformationNormal)};b.prototype.release=function(){};b.prototype.getDrawMode=function(){return 4};return b}(F),N={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},V=T.vec2f64.create(),p=A.vec3f64.create(),X=A.vec3f64.create(),C=ba.createRenderScreenPointArray3(),
Z=A.vec3f64.create(),Y=A.vec3f64.create(),J=ca.mat3f64.create(),pa=R.mat4f64.create(),v=A.vec3f64.create(),O={normal:Z,cosAngle:0},W=R.mat4f64.create(),oa=1,na=2,u=[0,0],ra=A.vec3f64.fromValues(0,0,1),la={texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,
1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:T.vec2f64.fromValues(.5,.5),shaderPolygonOffset:1E-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",debugDrawBorder:!1},ua=ga.newLayout().vec3f(f.VertexAttrConstants.POSITION).vec3f(f.VertexAttrConstants.NORMAL).vec2f(f.VertexAttrConstants.UV0).vec4u8(f.VertexAttrConstants.COLOR).vec2f(f.VertexAttrConstants.SIZE).vec4f(f.VertexAttrConstants.AUXPOS1).vec4f(f.VertexAttrConstants.AUXPOS2),
qa=function(){function c(b){this.material=b;this.vertexBufferLayout=ua}c.prototype.allocate=function(b){return this.vertexBufferLayout.createBuffer(b)};c.prototype.elementCount=function(b){return 6*b.indices[f.VertexAttrConstants.POSITION].length};c.prototype.write=function(b,a,c,g){y.writePosition(a.indices[f.VertexAttrConstants.POSITION],a.vertexAttr[f.VertexAttrConstants.POSITION].data,b.transformation,c.position,g,6);y.writeNormal(a.indices[f.VertexAttrConstants.NORMAL],a.vertexAttr[f.VertexAttrConstants.NORMAL].data,
b.invTranspTransformation,c.normal,g,6);b=a.vertexAttr[f.VertexAttrConstants.UV0].data;var d=void 0,k=void 0,e=void 0,h=void 0;null==b||4>b.length?(b=this.material.getParameters(),k=d=0,e=b.texCoordScale[0],h=b.texCoordScale[1]):(d=b[0],k=b[1],e=b[2],h=b[3]);var e=Math.min(1.99999,e+1),h=Math.min(1.99999,h+1),p=a.indices[f.VertexAttrConstants.POSITION].length,m=c.uv0;b=g;for(var q=0;q<p;++q)m.set(b,0,d),m.set(b,1,k),b+=1,m.set(b,0,e),m.set(b,1,k),b+=1,m.set(b,0,e),m.set(b,1,h),b+=1,m.set(b,0,e),m.set(b,
1,h),b+=1,m.set(b,0,d),m.set(b,1,h),b+=1,m.set(b,0,d),m.set(b,1,k),b+=1;y.writeColor(a.indices[f.VertexAttrConstants.COLOR],a.vertexAttr[f.VertexAttrConstants.COLOR].data,4,c.color,g,6);d=a.indices[f.VertexAttrConstants.SIZE];k=a.vertexAttr[f.VertexAttrConstants.SIZE].data;e=d.length;h=c.size;b=g;for(q=0;q<e;++q)for(var p=k[2*d[q]],m=k[2*d[q]+1],t=0;6>t;++t)h.set(b,0,p),h.set(b,1,m),b+=1;a.indices[f.VertexAttrConstants.AUXPOS1]&&a.vertexAttr[f.VertexAttrConstants.AUXPOS1]&&y.writeBufferVec4(a.indices[f.VertexAttrConstants.AUXPOS1],
a.vertexAttr[f.VertexAttrConstants.AUXPOS1].data,c.auxpos1,g,6);a.indices[f.VertexAttrConstants.AUXPOS2]&&a.vertexAttr[f.VertexAttrConstants.AUXPOS2]&&y.writeBufferVec4(a.indices[f.VertexAttrConstants.AUXPOS2],a.vertexAttr[f.VertexAttrConstants.AUXPOS2].data,c.auxpos2,g,6)};return c}(),aa={factor:0,units:-4};return P});