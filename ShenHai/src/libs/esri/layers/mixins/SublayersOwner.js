// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/assignHelper ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/Collection ../../core/CollectionFlattener ../../core/Error ../../core/lang ../../core/Logger ../../core/accessorSupport/decorators ../../core/accessorSupport/ensureType ../support/Sublayer ../support/sublayerUtils".split(" "),function(A,q,r,t,h,l,u,v,w,x,e,y,k,m){function n(f,e,d){var a=[],b={};if(!f)return a;f.forEach(function(c){var g=new k;g.read(c,
e);d&&(-1===d.indexOf(g.id)?g.visible=!1:g.visible=!0);b[g.id]=g;null!=c.parentLayerId&&-1!==c.parentLayerId?(c=b[c.parentLayerId],c.sublayers||(c.sublayers=[]),c.sublayers.unshift(g)):a.unshift(g)});return a}function p(f,e){var d=e.get(f.id);if(d){var a=f.__accessor__.store;d.__accessor__.store.forEach(function(b,c){return a.set(c,b)});d.__accessor__.overridden&&(f.__accessor__.overridden=w.mixin(f.__accessor__.overridden||{},d.__accessor__.overridden));d.sublayers&&(f.sublayers=d.sublayers.map(function(a){return p(a,
e)}))}else f.sublayers&&f.sublayers.forEach(function(a){return p(a,e)});return f}Object.defineProperty(q,"__esModule",{value:!0});var z=x.getLogger("esri.layers.TileLayer");q.SublayersOwner=function(f){return function(f){function d(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];var c=f.apply(this,a)||this;c.allSublayers=new u({root:c,rootCollectionNames:["sublayers"],getChildrenFunction:function(a){return a.sublayers}});c.watch("sublayers",function(a,b){return c._handleSublayersChange(a,
b)},!0);return c}t(d,f);d.prototype.readServiceSublayers=function(a,b,c){return n(b.layers,c)};d.prototype.readSublayersFromItemOrWebMap=function(a,b,c){return!b.layers&&b.visibleLayers?b.visibleLayers.map(function(a){return{id:a}}):n(b.layers,c,b.visibleLayers)};d.prototype.readSublayers=function(a,b,c){a=n(b.layers,c);this._updateSublayersForOrigin(3,a);this._updateSublayersForOrigin(5,a);this._updateSublayersForOrigin(4,a);return a};d.prototype.writeSublayers=function(a,b,c,g){if(a&&this.serviceSublayers){a=
a.slice().reverse().flatten(function(a){return(a=a.sublayers)&&a.toArray().reverse()}).toArray();var d=this.serviceSublayers.flatten(function(a){return(a=a.sublayers)&&a.toArray().reverse()}).toArray().reduce(function(a,b){a.set(b.id,b);return a},new Map),f=!1,e=!0;this.capabilities&&this.capabilities.operations.supportsExportMap&&this.capabilities.exportMap.supportsDynamicLayers?(f=m.isExportDynamic(a,this.serviceSublayers,this),e=!f&&m.sameStructureAsService(a,this.serviceSublayers)):e=m.sameStructureAsService(a,
this.serviceSublayers);b.layers=[];a.forEach(function(a){var c=d.get(a.id),c=r({writeAsDynamic:f,writeOverridesOnly:e,serviceSublayer:c},g);a=a.write({},c);(!e||e&&1<Object.keys(a).length)&&b.layers.push(a)});a=a.filter(function(a){return a.visible}).map(function(a){return a.id});"tile"!==this.type&&(b.visibleLayers=a)}};d.prototype.findSublayerById=function(a){return this.allSublayers.find(function(b){return b.id===a})};d.prototype.createServiceSublayers=function(){return this.serviceSublayers.map(function(a){return a.clone()})};
d.prototype._updateSublayersForOrigin=function(a,b){var c=this.__accessor__.store;if(c.has("sublayers",a)){var g=c.get("sublayers",a).flatten(function(a){return a.sublayers});if(g.every(function(a){return!a.__accessor__.store.has("minScale")})){var d=g.reduce(function(a,b){a.set(b.id,b);return a},new Map);b=b.map(function(a){return p(a.clone(),d)});c.set("sublayers",new (l.ofType(k))(b),a)}}};d.prototype._handleSublayersChange=function(a,b){var c=this;b&&(b.forEach(function(a){a.parent=null;a.layer=
null}),this._sublayersHandles.forEach(function(a){return a.remove()}),this._sublayersHandles=null);a&&(a.forEach(function(a){a.parent=c;a.layer=c}),this._sublayersHandles=[a.on("after-add",function(a){a=a.item;a.parent=c;a.layer=c}),a.on("after-remove",function(a){a=a.item;a.parent=null;a.layer=null})],"tile"===this.type&&this._sublayersHandles.push(a.on("before-changes",function(a){z.error(new v("tilelayer:sublayers-non-modifiable","Sublayer can't be added, moved, or removed from the layer's sublayers",
{layer:c}));a.preventDefault()})))};h([e.property({readOnly:!0})],d.prototype,"allSublayers",void 0);h([e.property({readOnly:!0,type:l.ofType(k)})],d.prototype,"serviceSublayers",void 0);h([e.reader("service","serviceSublayers",["layers"])],d.prototype,"readServiceSublayers",null);h([e.property({value:null,type:l.ofType(k),json:{type:[Number],write:{target:"subLayerIds",allowNull:!0}}})],d.prototype,"sublayers",void 0);h([e.reader(["web-map","web-scene","portal-item"],"sublayers",["layers","visibleLayers"])],
d.prototype,"readSublayersFromItemOrWebMap",null);h([e.reader("service","sublayers",["layers"])],d.prototype,"readSublayers",null);h([e.writer("sublayers",{layers:{type:[k]},visibleLayers:{type:[y.Integer]}})],d.prototype,"writeSublayers",null);return d=h([e.subclass("esri.layers.mixins.SublayersOwner")],d)}(e.declared(f))}});