// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../core/iteratorUtils ../../../core/maybe ../../../core/promiseUtils ../../../geometry/support/quantizationUtils ../../../geometry/support/spatialReferenceUtils ../featureConversionUtils ./AttributesBuilder ./attributeSupport ./projectionSupport ./timeSupport ./utils".split(" "),function(C,z,A,J,K,L,M,n,D,w,N,G,O,H,P,t){Object.defineProperty(z,"__esModule",
{value:!0});C=function(){function e(a,b,d){this.items=a;this.queryGeometry=b;this.definitionExpression=d.definitionExpression;this.geometryType=d.geometryType;this.hasM=d.hasM;this.hasZ=d.hasZ;this.objectIdField=d.objectIdField;this.spatialReference=d.spatialReference;this.fieldsIndex=d.fieldsIndex;this.timeInfo=d.timeInfo;this.featureAdapter=d.featureAdapter}Object.defineProperty(e.prototype,"size",{get:function(){return this.items.length},enumerable:!0,configurable:!0});e.prototype.createQueryResponse=
function(a){var b;b=a.outStatistics?a.outStatistics.some(function(a){return"exceedslimit"===a.statisticType})?this._createExceedsLimitQueryResponse(a):this._createStatisticsQueryResponse(a):this._createFeatureQueryResponse(a);a.returnQueryGeometry&&(w.isValid(a.outSR)&&!w.equals(this.queryGeometry.spatialReference,a.outSR)?b.queryGeometry=t.cleanFromGeometryEngine(A({spatialReference:a.outSR},H.project(this.queryGeometry,this.queryGeometry.spatialReference,a.outSR))):b.queryGeometry=t.cleanFromGeometryEngine(A({spatialReference:a.outSR},
this.queryGeometry)));return b};e.prototype.executeAttributesQuery=function(a){var b=O.getWhereClause(a.where,this.fieldsIndex);if(!b)return n.resolve(this);if(b.isStandardized){for(var d=0,k=[],f=0,c=this.items;f<c.length;f++){var g=c[f];b.testFeature(g,this.featureAdapter)&&(k[d++]=g)}b=new e(k,this.queryGeometry,this);b.definitionExpression=a.where;return n.resolve(b)}return n.reject(new TypeError("Where clause is not standardized"))};e.prototype.executeObjectIdsQuery=function(a){if(!a.objectIds||
!a.objectIds.length)return n.resolve(this);var b=L.createSetFromValues(a.objectIds),d=this.featureAdapter.getObjectId;return n.resolve(new e(this.items.filter(function(a){return b.has(d(a))}),this.queryGeometry,this))};e.prototype.executeTimeQuery=function(a){a=P.getTimeOperator(this.timeInfo,a.timeExtent,this.featureAdapter);if(!M.isSome(a))return n.resolve(this);a=this.items.filter(a);return n.resolve(new e(a,this.queryGeometry,this))};e.prototype.project=function(a){return K(this,void 0,void 0,
function(){var b,d,k,f=this;return J(this,function(c){switch(c.label){case 0:if(!a||w.equals(this.spatialReference,a))return[2,this];b=this.featureAdapter;return[4,H.projectMany(this.items.map(function(a){return t.getGeometry(f,b.getGeometry(a))}),this.spatialReference,a)];case 1:return d=c.sent(),k=d.map(function(a,c){return b.cloneWithGeometry(f.items[c],N.convertFromGeometry(a,f.hasZ,f.hasM))}),[2,new e(k,this.queryGeometry,{definitionExpression:this.definitionExpression,geometryType:this.geometryType,
hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:a,fieldsIndex:this.fieldsIndex,timeInfo:this.timeInfo,featureAdapter:this.featureAdapter})]}})})};e.prototype._createFeatureQueryResponse=function(a){var b=this,d=this.items,k=this.geometryType,f=this.hasM,c=this.hasZ,g=this.objectIdField,h=this.spatialReference,u=a.outFields,e=a.outSR,q=a.quantizationParameters,l=a.resultRecordCount,r=a.resultOffset,m=a.returnZ,p=a.returnM,I=!1;null!=l&&null!=r&&(l=r+l,I=d.length>l,d=
d.slice(r,Math.min(d.length,l)));return{exceededTransferLimit:I,features:this._createFeatures(a,d),fields:u&&u.map(function(a){return b.fieldsIndex.get(a)}),geometryType:k,hasM:f&&p,hasZ:c&&m,objectIdFieldName:g,spatialReference:t.cleanFromGeometryEngine(e?e:h),transform:q&&D.toQuantizationTransform(q)||null}};e.prototype._createFeatures=function(a,b){var d=new G.default(a,this.featureAdapter,this.fieldsIndex),k=a.orderByFields,f=a.quantizationParameters,c=a.returnGeometry,g=a.returnCentroid,h=a.maxAllowableOffset,
u=a.returnZ;a=a.returnM;var e=this.hasZ&&(void 0===u?!1:u),q=this.hasM&&(void 0===a?!1:a),u=[];a=0;if(b.length&&k&&k.length){var k=k[0].split(" "),l=k[0],r=this.fieldsIndex.get(l),m="DESC"===k[1];b.sort(function(a,b){a=d.getFieldValue(a,l,r);b=d.getFieldValue(b,l,r);if("number"===typeof a&&"number"===typeof b)return m?b-a:a-b;if("string"===typeof a&&"string"===typeof b)return a=a.toUpperCase(),b=b.toUpperCase(),(m?a>b:a<b)?-1:(m?a<b:a>b)?1:0})}if(c||g)if(f=D.toQuantizationTransform(f),c&&!g)for(g=
0;g<b.length;g++)c=b[g],u[a++]={attributes:d.getAttributes(c),geometry:t.getGeometry(this,this.featureAdapter.getGeometry(c),h,f,e,q)};else if(!c&&g)for(h=0;h<b.length;h++)c=b[h],u[a++]={attributes:d.getAttributes(c),centroid:t.transformCentroid(this,this.featureAdapter.getCentroid(c,this),f)};else for(g=0;g<b.length;g++)c=b[g],u[a++]={attributes:d.getAttributes(c),centroid:t.transformCentroid(this,this.featureAdapter.getCentroid(c,this),f),geometry:t.getGeometry(this,this.featureAdapter.getGeometry(c),
h,f,e,q)};else for(h=0;h<b.length;h++)c=b[h],(e=d.getAttributes(c))&&(u[a++]={attributes:e});return u};e.prototype._createExceedsLimitQueryResponse=function(a){var b=!1,d=Number.POSITIVE_INFINITY,k=Number.POSITIVE_INFINITY,b=Number.POSITIVE_INFINITY,f=0;for(a=a.outStatistics;f<a.length;f++){var c=a[f];if("exceedslimit"===c.statisticType){d=null!=c.maxPointCount?c.maxPointCount:Number.POSITIVE_INFINITY;k=null!=c.maxRecordCount?c.maxRecordCount:Number.POSITIVE_INFINITY;b=null!=c.maxVertexCount?c.maxVertexCount:
Number.POSITIVE_INFINITY;break}}if("esriGeometryPoint"===this.geometryType)b=this.items.length>d;else if(this.items.length>k)b=!0;else var d=this.hasZ?this.hasM?4:3:this.hasM?3:2,g=this.featureAdapter,b=this.items.reduce(function(a,b){b=g.getGeometry(b);return a+(b&&b.coords.length||0)},0)/d>b;return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(b)}}]}};e.prototype._createStatisticsQueryResponse=
function(a){var b=new G.default(a,this.featureAdapter,this.fieldsIndex),d=a.outStatistics,k=[],f=[],c=a.groupByFieldsForStatistics;a=a.having;for(var g=c&&c.length,c=g&&c[0],h=this.fieldsIndex.get(c),e=!h,t={},q={},l={},r={attributes:{}},m=0;m<d.length;m++){var p=d[m],n=p.outStatisticFieldName,x=p.statisticType,p="exceedslimit"!==x?p.onStatisticField:void 0,w=this.fieldsIndex.get(p),C=g&&(p===c||e)&&"count"===x;if(g){t[p]||(t[p]=this._calculateUniqueValues(b,c,h));var z=t[p],A;for(A in z){var v=z[A],
B=v.count,E=v.data,y=v.items;if(!a||b.validateItems(y,a)){var v=q[E]||{attributes:{}},F=null;C?F=B:(B=this._calculateStatistics(y,b,p,w),y="var"===x?"variance":x,F=B[y]);v.attributes[n]=F;v.attributes[e?"EXPR_1":c]=E;q[E]=v}}}else l[p]||(l[p]=this._calculateStatistics(this.items,b,p,w)),B=l[p],y="var"===x?"variance":x,r.attributes[n]=B[y];f.push({name:n,alias:n,type:"esriFieldTypeDouble"})}if(g)for(var D in q)k.push(q[D]);else k.push(r);return{fields:f,features:k}};e.prototype._calculateStatistics=
function(a,b,d,k){for(var f=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY,g=null,h=null,e=null,n=null,q=[],l=0,r=0;r<a.length;r++){var m=b.getFieldValue(a[r],d,k);"string"===typeof m?l++:null==m||isNaN(m)||(g+=m,f=Math.min(f,m),c=Math.max(c,m),q.push(m),l++)}if(l){h=g/l;for(b=a=0;b<q.length;b++)m=q[b],a+=Math.pow(m-h,2);n=1<l?a/(l-1):0;e=Math.sqrt(n)}else c=f=null;return{avg:h,count:l,max:c,min:f,stddev:e,sum:g,variance:n}};e.prototype._calculateUniqueValues=function(a,b,d){for(var e={},f=0,
c=this.items;f<c.length;f++){var g=c[f],h=a.getFieldValue(g,b,d);if(null==h||"string"===typeof h&&""===h.trim())h=null;null==e[h]?e[h]={count:1,data:h,items:[g]}:(e[h].count++,e[h].items.push(g))}return e};return e}();z.default=C});