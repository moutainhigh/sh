// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/extendsHelper ../../../core/CircularArray ../../../core/maybe ./FeatureStore".split(" "),function(k,f,q,l,m,e,n){Object.defineProperty(f,"__esModule",{value:!0});f.DEFAULT_STREAM_ID_FIELD="__esri_stream_id__";k=function(g){function c(a,d,b,c,p,h){void 0===h&&(h=128);b=g.call(this,b)||this;b._trackIdToObservations=new Map;b._idCounter=0;b._lastPurge=Date.now();b._addOrUpdated=new Map;b._removed=[];b._maxAge=0;b._timeInfo=
d;b._maximumTrackCount=c;b._purgeOptions=p;b.purgeInterval=h;b.objectIdField=e.unwrapOr(a,f.DEFAULT_STREAM_ID_FIELD);b._useGeneratedIds=b.objectIdField===f.DEFAULT_STREAM_ID_FIELD;return b}l(c,g);c.prototype.add=function(a){this._useGeneratedIds&&(a.attributes[this.objectIdField]=this._nextId(),a.objectId=a.attributes[this.objectIdField]);g.prototype.add.call(this,a);this._addOrUpdated.set(a.objectId,a);this._maxAge=Math.max(this._maxAge,a.attributes[this._timeInfo.startTimeField]);if(this._timeInfo.trackIdField){var d=
a.attributes[this._timeInfo.trackIdField];this._trackIdToObservations.has(d)||this._trackIdToObservations.set(d,new m.default(this._maximumTrackCount));a=this._trackIdToObservations.get(d).enqueue(a.attributes[this.objectIdField]);e.isSome(a)&&(d=this.removeById(a),e.isSome(d)&&(this._addOrUpdated.has(a)?this._addOrUpdated.delete(a):this._removed.push(d)))}};c.prototype.checkForUpdates=function(){var a=this._getToAdd(),d=this._getToRemove(),b=Date.now();b-this._lastPurge>=this.purgeInterval&&(this._purge(),
this._lastPurge=b);(a||d)&&this.events.emit("update",{addOrUpdated:a,removed:d})};c.prototype._getToAdd=function(){if(!this._addOrUpdated.size)return null;var a=Array(this._addOrUpdated.size),d=0;this._addOrUpdated.forEach(function(b){return a[d++]=b});this._addOrUpdated.clear();return a};c.prototype._getToRemove=function(){var a=this._removed;if(!this._removed.length)return null;this._removed=[];return a};c.prototype._nextId=function(){var a=this._idCounter;this._idCounter=(this._idCounter+1)%4294967294+
1;return a};c.prototype._purge=function(){var a=this._purgeOptions;e.isSome(a)&&(this._purgeSomeByDisplayCount(a),this._purgeByAge(a))};c.prototype._purgeSomeByDisplayCount=function(a){var d=this;if(a.displayCount){var b=this.numFeatures;b>a.displayCount&&this._trackIdToObservations.forEach(function(c){b>a.displayCount&&c.size&&(c=d.removeById(e.unwrap(c.dequeue())),e.isSome(c)&&d._removed.push(c),b--)})}};c.prototype._purgeByAge=function(a){var d=this;if(a.age){var b=this._maxAge-6E4*a.age,c=this._timeInfo.startTimeField;
this.forEach(function(a){a.attributes[c]<b&&(d.removeById(a.objectId),d._removed.push(a))})}};return c}(n.default);f.default=k});