// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define(["require","exports","../PixelBlock"],function(H,I,D){function E(a,d){a=Math.min(Math.max(a,-100),100);d=Math.min(Math.max(d,-100),100);var e,l,c=new Uint8Array(256);for(e=0;256>e;e++)0<a&&100>a?l=(200*e-25500+510*d)/(2*(100-a))+128:0>=a&&-100<a?l=(200*e-25500+510*d)*(100+a)/2E4+128:100===a?(l=200*e-25500+256*(100-a)+510*d,l=0<l?255:0):-100===a&&(l=128),c[e]=255<l?255:0>l?0:l;return c}function F(a,d,e,l,c,n,f,g){return{xmin:c<=e*a?0:c<e*a+a?c-e*a:a,ymin:n<=l*d?0:n<l*d+d?n-l*d:d,xmax:c+f<=e*
a?0:c+f<e*a+a?c+f-e*a:a,ymax:n+g<=l*d?0:n+g<l*d+d?n+g-l*d:d}}var B=function(a){return a&&"esri.layers.support.PixelBlock"===a.declaredClass&&a.pixels&&0<a.pixels.length},G={createColormapLUT:function(a){if(a){var d=a.colormap;if(d&&0!==d.length){var d=d.sort(function(a,b){return a[0]-b[0]}),e=0;0>d[0][0]&&(e=d[0][0]);var l=Math.max(256,d[d.length-1][0]-e+1),c=new Uint8Array(4*l),n=[],f=0,g=0,h=5===d[0].length;if(65536<l)return d.forEach(function(a){n[a[0]-e]=h?a.slice(1):a.slice(1).concat([255])}),
{indexed2DColormap:n,offset:e,alphaSpecified:h};if(a.fillUnspecified)for(a=d[g],f=a[0]-e;f<l;f++)c[4*f]=a[1],c[4*f+1]=a[2],c[4*f+2]=a[3],c[4*f+3]=h?a[4]:255,f===a[0]-e&&(a=g===d.length-1?a:d[++g]);else for(f=0;f<d.length;f++)a=d[f],g=4*(a[0]-e),c[g]=a[1],c[g+1]=a[2],c[g+2]=a[3],c[g+3]=h?a[4]:255;return{indexedColormap:c,offset:e,alphaSpecified:h}}}},createContrastBrightnessLUT:E,createStretchLUT:function(a){var d=a.minCutOff,e=a.maxCutOff,l=a.gamma,c=a.pixelType,n=a.outMin||0,f=a.outMax||255;if(-1===
["u8","u16","s8","s16"].indexOf(c))return null;var g=d.length,h,k=0;"s8"===c?k=-127:"s16"===c&&(k=-32767);var b=256;-1<["u16","s16"].indexOf(c)&&(b=65536);for(var m=[],p=f-n,c=0;c<g;c++)m[c]=e[c]-d[c];h=l&&l.length>=g;var q=[];if(h)for(c=0;c<g;c++)q[c]=1<l[c]?2<l[c]?6.5+Math.pow(l[c]-2,2.5):6.5+100*Math.pow(2-l[c],4):1;var t,r=[],v,w,u;if(h)for(c=0;c<g;c++){u=[];for(h=0;h<b;h++)v=h+k,t=(v-d[c])/m[c],w=1,1<l[c]&&(w-=Math.pow(1/p,t*q[c])),u[h]=v<e[c]&&v>d[c]?Math.floor(w*p*Math.pow(t,1/l[c]))+n:v>=
e[c]?f:n;r[c]=u}else for(c=0;c<g;c++){u=[];for(h=0;h<b;h++)v=h+k,u[h]=v<=d[c]?n:v>=e[c]?f:Math.floor((v-d[c])/m[c]*p)+n;r[c]=u}if(null!=a.contrastOffset)for(a=E(a.contrastOffset,a.brightnessOffset),c=0;c<g;c++)for(u=r[c],h=0;h<b;h++)u[h]=a[u[h]];return{lut:r,offset:k}},colorize:function(a,d){if(!B(a)||!d&&(d.indexedColormap||d.indexed2DColormap))return a;var e=a.clone(),l=e.pixels,c=e.mask,n=e.width*e.height;if(1!==l.length)return a;var f=d.indexedColormap;a=d.indexed2DColormap;var g=d.offset;d=d.alphaSpecified;
var h=f.length-1,k=0,l=l[0],b=new Uint8Array(l.length),m=new Uint8Array(l.length),p=new Uint8Array(l.length),q=0;if(f)if(c)for(k=0;k<n;k++)c[k]&&(q=4*(l[k]-g),q<g||q>h?c[k]=0:(b[k]=f[q],m[k]=f[q+1],p[k]=f[q+2],c[k]=f[q+3]));else{c=new Uint8Array(n);for(k=0;k<n;k++)q=4*(l[k]-g),q<g||q>h?c[k]=0:(b[k]=f[q],m[k]=f[q+1],p[k]=f[q+2],c[k]=f[q+3]);e.mask=c}else if(c)for(k=0;k<n;k++)c[k]&&(f=a[l[k]],b[k]=f[0],m[k]=f[1],p[k]=f[2],c[k]=f[3]);else{c=new Uint8Array(n);for(k=0;k<n;k++)f=a[l[k]],b[k]=f[0],m[k]=
f[1],p[k]=f[2],c[k]=f[3];e.mask=c}e.pixels=[b,m,p];e.statistics=null;e.pixelType="u8";e.maskIsAlpha=d;return e},estimateStatisticsHistograms:function(a){if(!B(a))return null;var d=a.pixels,e=a.mask,l=a.pixelType,c=a.statistics;a=a.width*a.height;var n=d.length,f,g,h,k,b,m=[],p=[],q,t,r;for(k=0;k<n;k++){q=new Uint32Array(256);r=d[k];if("u8"===l)if(f=-.5,g=255.5,e)for(b=0;b<a;b++)e[b]&&q[r[b]]++;else for(b=0;b<a;b++)q[r[b]]++;else{f=c[k].minValue;g=c[k].maxValue;h=(g-f)/256;t=new Uint32Array(257);if(e)for(b=
0;b<a;b++)e[b]&&t[Math.floor((r[b]-f)/h)]++;else for(b=0;b<a;b++)t[Math.floor((r[b]-f)/h)]++;for(b=0;255>b;b++)q[b]=t[b];q[255]=t[255]+t[256]}m.push({min:f,max:g,size:256,counts:q});for(b=r=t=h=0;256>b;b++)h+=q[b],t+=b*q[b];t/=h;for(b=0;256>b;b++)r+=q[b]*Math.pow(b-t,2);q=Math.sqrt(r/(h-1));h=(g-f)/256;b=(t+.5)*h+f;q*=h;p.push({min:f,max:g,avg:b,stddev:q})}return{statistics:p,histograms:m}},extractBands:function(a,d){return!d||!B(a)||d&&d.some(function(d){return d>a.pixels.length})?a:new D({pixelType:a.pixelType,
width:a.width,height:a.height,mask:a.mask,validPixelCount:a.validPixelCount,maskIsAlpha:a.maskIsAlpha,pixels:d.map(function(d){return a.pixels[d]}),statistics:a.statistics&&d.map(function(d){return a.statistics[d]})})},stretch:function(a,d){if(!B(a))return null;a=a.clone();var e=a.pixels,l=a.mask,c=d.minCutOff,n=d.maxCutOff,f=d.gamma,g=d.outMin||0;d=d.outMax||255;var h=a.width*a.height,k=e.length,b,m,p,q,t,r=d-g,v=[];for(b=0;b<k;b++)v[b]=n[b]-c[b];m=f&&f.length>=k;var w=[];if(m)for(b=0;b<k;b++)w[b]=
1<f[b]?2<f[b]?6.5+Math.pow(f[b]-2,2.5):6.5+100*Math.pow(2-f[b],4):1;if(m)if(null!=l)for(m=0;m<h;m++){if(l[m])for(b=0;b<k;b++)p=e[b][m],t=(p-c[b])/v[b],q=1,1<f[b]&&(q-=Math.pow(1/r,t*w[b])),e[b][m]=p<n[b]&&p>c[b]?Math.floor(q*r*Math.pow(t,1/f[b]))+g:p>=n[b]?d:g}else for(m=0;m<h;m++)for(b=0;b<k;b++)p=e[b][m],t=(p-c[b])/v[b],q=1,1<f[b]&&(q-=Math.pow(1/r,t*w[b])),e[b][m]=p<n[b]&&p>c[b]?Math.floor(q*r*Math.pow(t,1/f[b]))+g:p>=n[b]?d:g;else if(null!=l)for(m=0;m<h;m++){if(l[m])for(b=0;b<k;b++)p=e[b][m],
e[b][m]=p<n[b]&&p>c[b]?Math.floor((p-c[b])/v[b]*r)+g:p>=n[b]?d:g}else for(m=0;m<h;m++)for(b=0;b<k;b++)p=e[b][m],e[b][m]=p<n[b]&&p>c[b]?Math.floor((p-c[b])/v[b]*r)+g:p>=n[b]?d:g;a.pixelType="u8";a.updateStatistics();return a},lookupPixels:function(a,d){if(!B(a))return null;var e=a.pixels,l=a.mask,c=a.width*a.height,n=e.length,f=d.lut;d=d.offset;var g,h;f&&1===f[0].length&&(f=e.map(function(){return f}));var k=[],b,m,p;if(d)if(null==l)for(g=0;g<n;g++){b=e[g];m=f[g];p=new Uint8Array(c);for(h=0;h<c;h++)p[h]=
m[b[h]-d];k.push(p)}else for(g=0;g<n;g++){b=e[g];m=f[g];p=new Uint8Array(c);for(h=0;h<c;h++)l[h]&&(p[h]=m[b[h]-d]);k.push(p)}else if(null==l)for(g=0;g<n;g++){b=e[g];m=f[g];p=new Uint8Array(c);for(h=0;h<c;h++)p[h]=m[b[h]];k.push(p)}else for(g=0;g<n;g++){b=e[g];m=f[g];p=new Uint8Array(c);for(h=0;h<c;h++)l[h]&&(p[h]=m[b[h]]);k.push(p)}a=new D({width:a.width,height:a.height,pixels:k,mask:l,pixelType:"u8"});a.updateStatistics();return a},remapColor:function(a,d){if(!B(a))return null;a=a.clone();var e=
a.width*a.height,l=d.length,c=Math.floor(l/2),n=d[Math.floor(c)],f=a.pixels[0],g,h,k,b,m,p,q=!1,t=new Uint8Array(e),r=new Uint8Array(e),v=new Uint8Array(e),w=a.mask,u=4===d[0].mappedColor.length;w||(w=new Uint8Array(e),w.fill(u?255:1),a.mask=w);for(m=0;m<e;m++)if(w[m]){g=f[m];q=!1;p=c;h=n;k=0;for(b=l-1;1<b-k;){if(g===h.value){q=!0;break}g>h.value?k=p:b=p;p=Math.floor((k+b)/2);h=d[Math.floor(p)]}q||(g===d[k].value?(h=d[k],q=!0):g===d[b].value?(h=d[b],q=!0):g<d[k].value?(q=!1,h=null):g>d[k].value&&
(g<d[b].value?(h=d[k],q=!0):b===l-1?(q=!1,h=null):(h=d[b],q=!0)));q?(t[m]=h.mappedColor[0],r[m]=h.mappedColor[1],v[m]=h.mappedColor[2],w[m]=h.mappedColor[3]):t[m]=r[m]=v[m]=w[m]=0}a.pixels=[t,r,v];a.mask=w;a.pixelType="u8";a.maskIsAlpha=u;return a},mosaic:function(a,d,e,l){var c=a.filter(function(a){return B(a)})[0];if(null==c)return null;var n=l?l.width:d.width;l=l?l.height:d.height;var f=c.width,g=c.height,h=d.width/f;d=d.height/g;var k=e?e.x:0;e=e?e.y:0;var b=c.pixelType,m=c.getPixelArrayConstructor(b),
p=c.pixels.length,c=[],q,t,r,v,w,u,A,x,y,z;for(w=0;w<p;w++){t=new m(n*l);for(u=0;u<d;u++)for(A=0;A<h;A++)if(r=a[u*h+A])for(q=r.pixels[w],z=F(f,g,A,u,k,e,n,l),x=z.ymin;x<z.ymax;x++)for(r=(u*g+x-e)*n+(A*f-k),v=x*f,y=z.xmin;y<z.xmax;y++)t[r+y]=q[v+y];c.push(t)}var C;if(a.some(function(a){return a&&a.mask&&0<a.mask.length}))for(C=new Uint8Array(n*l),u=0;u<d;u++)for(A=0;A<h;A++)if(m=(r=a[u*h+A])?r.mask:null,z=F(f,g,A,u,k,e,n,l),m)for(x=z.ymin;x<z.ymax;x++)for(r=(u*g+x-e)*n+(A*f-k),v=x*f,y=z.xmin;y<z.xmax;y++)C[r+
y]=m[v+y];else if(r)for(x=z.ymin;x<z.ymax;x++)for(r=(u*g+x-e)*n+(A*f-k),v=x*f,y=z.xmin;y<z.xmax;y++)C[r+y]=1;else for(x=z.ymin;x<z.ymax;x++)for(r=(u*g+x-e)*n+(A*f-k),v=x*f,y=z.xmin;y<z.xmax;y++)C[r+y]=0;a=new D({width:n,height:l,pixels:c,pixelType:b,mask:C});a.updateStatistics();return a},mosaicPixelData:function(a,d){if(!a||0===a.length)return null;var e=a.filter(function(a){return a.pixelBlock})[0];if(!e)return null;var l=(e.extent.xmax-e.extent.xmin)/e.pixelBlock.width,c=(e.extent.ymax-e.extent.ymin)/
e.pixelBlock.height,n=.01*Math.min(l,c),f=a.sort(function(a,b){return Math.abs(a.extent.ymax-b.extent.ymax)>n?b.extent.ymax-a.extent.ymax:Math.abs(a.extent.xmin-b.extent.xmin)>n?a.extent.xmin-b.extent.xmin:0}),g=Math.min.apply(null,f.map(function(a){return a.extent.xmin})),h=Math.min.apply(null,f.map(function(a){return a.extent.ymin})),k=Math.max.apply(null,f.map(function(a){return a.extent.xmax})),b=Math.max.apply(null,f.map(function(a){return a.extent.ymax}));a={x:Math.round((d.xmin-g)/l),y:Math.round((b-
d.ymax)/c)};g={width:Math.round((k-g)/l),height:Math.round((b-h)/c)};l={width:Math.round((d.xmax-d.xmin)/l),height:Math.round((d.ymax-d.ymin)/c)};if(Math.round(g.width/e.pixelBlock.width)*Math.round(g.height/e.pixelBlock.height)!==f.length||0>a.x||0>a.y||g.width<l.width||g.height<l.height)return null;e=f.map(function(a){return a.pixelBlock});e=G.mosaic(e,g,a,l);return{extent:d,pixelBlock:e}}};return G});