// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper dojo/i18n!../../nls/smartMapping ../.. ../../../pointCloudRenderers ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../intl/substitute ./support/utils ../heuristics/ageUnit ../heuristics/outline ../heuristics/sizeRange ../statistics/support/ageUtils ../support/utils ../symbology/color ../../support/AuthoringInfo ../../support/AuthoringInfoVisualVariable ../../support/numberUtils ../../support/utils ../../visualVariables/ColorVariable".split(" "),
function(ha,v,u,r,q,F,z,A,n,B,t,R,h,S,I,J,E,m,x,K,T,U,L,V){function W(b){return q(this,void 0,void 0,function(){var a,c,d,e,f,g;return r(this,function(k){switch(k.label){case 0:if(!(b&&b.layer&&(b.field||b.valueExpression||b.sqlExpression)))throw new n("color-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(b.valueExpression&&!b.sqlExpression&&!b.view)throw new n("color-visual-variable:missing-parameters","View is required when 'valueExpression' is specified");
a=u({},b);c=[0,2,1,3];d=m.createLayerAdapter(a.layer,c);a.layer=d;if(!d)throw new n("color-visual-variable:invalid-parameters","'layer' must be one of these types: "+m.getLayerTypeLabels(c).join(", "));return[4,d.load()];case 1:return k.sent(),e=d.geometryType,"mesh"===e||!a.worldScale||a.view&&"3d"===a.view.type?[4,m.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression})]:[2,t.reject(h.createError("color-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true"))];
case 2:f=k.sent();if(g=h.verifyBasicFieldValidity(d,f,"color-visual-variable:invalid-parameters"))throw g;return[2,a]}})})}function X(b){return q(this,void 0,void 0,function(){var a,c,d,e,f,g;return r(this,function(k){switch(k.label){case 0:if(!(b&&b.layer&&(b.field||b.valueExpression||b.sqlExpression)))throw new n("color-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(b.valueExpression&&!b.sqlExpression&&!b.view)throw new n("color-continuous-renderer:missing-parameters",
"View is required when 'valueExpression' is specified");a=u({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;c=[0,2,1,3];d=m.createLayerAdapter(a.layer,c);a.layer=d;if(!d)throw new n("color-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+m.getLayerTypeLabels(c).join(", "));return[4,d.load()];case 1:k.sent();e=d.geometryType;a.outlineOptimizationEnabled="polygon"===e?a.outlineOptimizationEnabled:!1;a.sizeOptimizationEnabled=
"point"===e||"multipoint"===e||"polyline"===e?a.sizeOptimizationEnabled:!1;if("mesh"===e)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";else{if("3d-volumetric-uniform"===a.symbolType&&"point"!==e)throw new n("color-continuous-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new n("color-continuous-renderer:invalid-parameters",
"'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");}return[4,m.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression})];case 2:f=k.sent();if(g=h.verifyBasicFieldValidity(d,f,"color-continuous-renderer:invalid-parameters"))throw g;return[2,a]}})})}function Y(b){return q(this,void 0,void 0,function(){var a,c,d,e,f,g,k;return r(this,function(p){switch(p.label){case 0:if(!b||
!b.layer||!b.field&&!b.valueExpression)throw new n("color-class-breaks-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(b.valueExpression&&!b.view)throw new n("color-class-breaks-renderer:missing-parameters","View is required when 'valueExpression' is specified");a=u({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;a.classificationMethod=a.classificationMethod||"equal-interval";a.normalizationType=
m.getNormalizationType(a);c=[0,2,1,3];d=m.createLayerAdapter(a.layer,c);a.layer=d;if(!d)throw new n("color-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+m.getLayerTypeLabels(c).join(", "));e=null!=a.minValue&&null!=a.maxValue;if(!e&&(null!=a.minValue||null!=a.maxValue))throw new n("color-class-breaks-renderer:missing-parameters","Both 'minValue' and 'maxValue' are required when specifying custom data range");return[4,d.load()];case 1:p.sent();f=d.geometryType;a.outlineOptimizationEnabled=
"polygon"===f?a.outlineOptimizationEnabled:!1;if("mesh"===f)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";else{if("3d-volumetric-uniform"===a.symbolType&&"point"!==f)throw new n("color-continuous-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new n("color-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");
}return[4,m.getFieldsList({field:a.field,normalizationField:a.normalizationField})];case 2:g=p.sent();if(k=h.verifyBasicFieldValidity(d,g,"color-class-breaks-renderer:invalid-parameters"))throw k;return[2,a]}})})}function Z(b){b=u({},b);delete b.basemap;delete b.colorScheme;delete b.legendOptions;delete b.symbolType;delete b.defaultSymbolEnabled;delete b.colorMixMode;delete b.edgesType;b.analyzeData=!(null!=b.minValue&&null!=b.maxValue);return b}function aa(b){if(!b||!b.layer)return t.reject(h.createError("color-point-cloud-true-color-renderer:missing-parameters",
"'layer' parameter is required"));var a=u({},b);b=[4];var c=m.createLayerAdapter(a.layer,b);a.layer=c;a.density=a.density||25;a.size=a.size||"100%";return h.isValidPointSize(a.size)?c?c.load().then(function(){return a}):t.reject(h.createError("color-point-cloud-true-color-renderer:invalid-parameters","'layer' must be one of these types: "+m.getLayerTypeLabels(b).join(", "))):t.reject(h.createError("color-point-cloud-true-color-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'"))}
function ba(b){if(!(b&&b.layer&&b.field))return t.reject(h.createError("color-point-cloud-continuous-renderer:missing-parameters","'layer' and 'field' parameters are required"));var a=b.field.toLowerCase();if("intensity"!==a&&"elevation"!==a)return t.reject(h.createError("color-point-cloud-continuous-renderer:invalid-parameters","'field' should be either 'intensity' or 'elevation'"));var c=u({},b);b=[4];a=m.createLayerAdapter(c.layer,b);c.layer=a;c.density=c.density||25;c.size=c.size||"100%";return h.isValidPointSize(c.size)?
a?a.load().then(function(){return c}):t.reject(h.createError("color-point-cloud-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+m.getLayerTypeLabels(b).join(", "))):t.reject(h.createError("color-point-cloud-continuous-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'"))}function M(b){b=u({},b);var a=-1<b.symbolType.indexOf("3d-volumetric");delete b.symbolType;delete b.defaultSymbolEnabled;delete b.colorMixMode;delete b.edgesType;
b.worldScale=a;return b}function ca(b){return q(this,void 0,void 0,function(){var a,c,d,e,f;return r(this,function(g){switch(g.label){case 0:if(!(b&&b.layer&&b.view&&b.startTime&&b.endTime))throw new n("color-age-renderer:missing-parameters","'layer', 'view', startTime', 'endTime' parameters are required");a=u({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;c=[0,2,1,3];d=m.createLayerAdapter(a.layer,c);a.layer=d;if(!d)throw new n("color-age-renderer:invalid-parameters",
"'layer' must be one of these types: "+m.getLayerTypeLabels(c).join(", "));return[4,d.load()];case 1:g.sent();e=d.geometryType;a.outlineOptimizationEnabled="polygon"===e?a.outlineOptimizationEnabled:!1;a.sizeOptimizationEnabled="point"===e||"multipoint"===e||"polyline"===e?a.sizeOptimizationEnabled:!1;if("mesh"===e)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";else if("3d-volumetric-uniform"===a.symbolType&&"point"!==e)throw new n("color-continuous-renderer:not-supported",
"3d-volumetric-uniform symbols are supported for point layers only");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new n("color-age-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");if(f=E.verifyDates(d,a.startTime,a.endTime,"color-age-renderer:invalid-parameters"))throw f;if(a.unit&&-1===E.supportedAgeUnits.indexOf(a.unit))throw new n("color-age-renderer:invalid-unit",
"Supported units are: "+E.supportedAgeUnits.join(", "));return[2,a]}})})}function y(b,a){return q(this,void 0,void 0,function(){var c,d,e,f,g,k,p;return r(this,function(l){switch(l.label){case 0:return c=b.colorScheme,e=d=null,[4,h.getBasemapInfo(b.basemap,b.view)];case 1:f=l.sent();d=B.isSome(f.basemapId)?f.basemapId:null;e=B.isSome(f.basemapTheme)?f.basemapTheme:null;if(c)return[2,{scheme:x.cloneScheme(c),basemapId:d,basemapTheme:e}];g=a||b.theme||"high-to-low";if(k=x.getSchemes({theme:g,basemap:d,
basemapTheme:e,geometryType:b.geometryType,worldScale:b.worldScale,view:b.view}))d=k.basemapId,e=k.basemapTheme,b.schemeId?(p=g+"/"+d+"/"+b.schemeId,c=x.getSchemeById({id:p,geometryType:b.geometryType})):c=k.primaryScheme;return[2,{scheme:c,basemapId:d,basemapTheme:e}]}})})}function N(b,a,c){for(var d=(a-b)/(c-1),e=[b],f=1;f<=c-2;f++)e.push(b+f*d);e.push(a);return U.round(e,{strictBounds:!0})}function da(b,a){return q(this,void 0,void 0,function(){var c,d,e,f,g,k,p;return r(this,function(l){switch(l.label){case 0:return c=
a.layer,[4,y({basemap:a.basemap,colorScheme:a.colorScheme,geometryType:c.geometryType,schemeId:"elevation"===a.field.toLowerCase()?"point-cloud-elevation-scheme":"point-cloud-intensity-scheme"})];case 1:d=l.sent();e=d.scheme;if(!e)throw h.createError("color-point-cloud-continuous-renderer:insufficient-info","Unable to find color scheme");f=h.createColors(e.colors,5);if(5>f.length)throw h.createError("color-point-cloud-continuous-renderer:insufficient-info","Color scheme does not have enough colors");
k=(g=h.getDefaultDataRange(b,!1,!0))?N(g[0],g[1],5):h.createStopValues(b);p=L.createColorStops({values:k,isDate:!1,dateFormatOptions:null,colors:f,labelIndexes:[0,2,4]});return[2,{stops:p,basemapId:d.basemapId,basemapTheme:d.basemapTheme,statistics:b,defaultValuesUsed:!!g,colorScheme:x.cloneScheme(e)}]}})})}function ea(b,a,c){return q(this,void 0,void 0,function(){var d,e,f,g,k,p,l,n,C,m,q,w,t,u,D;return r(this,function(O){switch(O.label){case 0:return d=c.layer,e=c.field,f="function"===typeof e,
k=(g=e&&!f?d.getField(e):null)&&"date"===g.type,[4,y({basemap:c.basemap,theme:c.theme,geometryType:d.geometryType,colorScheme:c.colorScheme,worldScale:c.worldScale,view:c.view})];case 1:p=O.sent();l=p.scheme;if(!l)throw h.createError("color-visual-variable:insufficient-info","Unable to find color scheme");n=h.createColors(l.colors,5);if(5>n.length)throw h.createError("color-visual-variable:insufficient-info","Color scheme does not have enough colors");C=h.getDefaultDataRange(b,k,!0);m=-1<l.id.indexOf("seq-");
q=C?N(C[0],C[1],5):h.createStopValues(b,m);w=h.createColors(n,5);t=new V({field:e,valueExpression:c.valueExpression,valueExpressionTitle:c.valueExpressionTitle,normalizationField:a,stops:q.map(function(a,b){return{value:a,color:w[b]}}),legendOptions:c.legendOptions});u=new T({type:"color",minSliderValue:null!=c.minValue?c.minValue:b.min,maxSliderValue:null!=c.maxValue?c.maxValue:b.max,theme:l.theme});D=new K({visualVariables:[u]});return[2,{basemapId:p.basemapId,basemapTheme:p.basemapTheme,visualVariable:t,
statistics:b,defaultValuesUsed:!!C,colorScheme:x.cloneScheme(l),authoringInfo:D}]}})})}function P(b,a,c,d,e,f){var g=f.field,k=f.layer.geometryType,p=f.defaultSymbolEnabled,l=x.cloneScheme(b.colorScheme),n=a&&a.opacity,m=[b.visualVariable.clone()];a&&a.visualVariables&&a.visualVariables.length&&m.push.apply(m,a.visualVariables.map(function(a){return a.clone()}));c&&c.minSize&&m.push(c.minSize);return{renderer:new z.ClassBreaksRenderer({classBreakInfos:[{minValue:-Q,maxValue:Q,symbol:h.createSymbol(k,
{type:f.symbolType,color:l.noDataColor,size:h.getSymbolSizeFromScheme(l,k),outline:h.getSymbolOutlineFromScheme(l,k,n),meshInfo:{colorMixMode:f.colorMixMode,edgesType:f.edgesType}})}],defaultLabel:p?F.other:null,defaultSymbol:p?h.createSymbol(k,{type:f.symbolType,color:l.noDataColor,size:h.getSymbolSizeFromScheme(l,k),outline:h.getSymbolOutlineFromScheme(l,k,n),meshInfo:{colorMixMode:f.colorMixMode,edgesType:f.edgesType}}):null,field:g,normalizationType:d,normalizationField:e,valueExpression:f.valueExpression,
valueExpressionTitle:f.valueExpressionTitle,visualVariables:m,authoringInfo:b.authoringInfo&&b.authoringInfo.clone()}),visualVariable:b.visualVariable.clone(),statistics:b.statistics,defaultValuesUsed:b.defaultValuesUsed,colorScheme:x.cloneScheme(b.colorScheme),basemapId:b.basemapId,basemapTheme:b.basemapTheme}}function H(b){return q(this,void 0,void 0,function(){var a,c,d,e,f;return r(this,function(g){switch(g.label){case 0:return[4,W(b)];case 1:a=g.sent();d=(c=a.normalizationField)?"field":void 0;
if(!a.statistics)return[3,2];f=a.statistics;return[3,4];case 2:return[4,h.getSummaryStatistics({layer:a.layer,field:a.field,valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,normalizationType:d,normalizationField:c,minValue:a.minValue,maxValue:a.maxValue,view:a.view})];case 3:f=g.sent(),g.label=4;case 4:return e=f,[2,ea(e,c,a)]}})})}function fa(b,a){b=b.colorsForClassBreaks;var c;if(b&&0<b.length&&(b.some(function(b){b.numClasses===a&&(c=b.colors);return!!c}),!c)){var d=
b[b.length-1];b=a-d.numClasses;if(0<b){var e=d.colors[d.numClasses-1];c=d.colors.splice(0);for(d=1;d<=b;d++)c.push(e)}}c&&(c=h.createColors(c,c.length));return c}function ga(b,a){return q(this,void 0,void 0,function(){var c,d,e,f,g,k,p,l,m,q,t,u,w,v;return r(this,function(r){switch(r.label){case 0:return c=b.layer,d=b.defaultSymbolEnabled,e=c.geometryType,[4,y({basemap:b.basemap,geometryType:e,colorScheme:b.colorScheme,worldScale:-1<b.symbolType.indexOf("3d-volumetric"),view:b.view})];case 1:f=r.sent();
g=f.scheme;k=a.result;p=a.outlineResult;l=k.classBreakInfos;m=b.classificationMethod;q="standard-deviation"===m;t=b.normalizationType;if(!g)throw new n("color-class-breaks-renderer:insufficient-info","Unable to find color scheme");u=fa(g,l.length);if(!u||u.length!==l.length)throw new n("color-class-breaks-renderer:insufficient-info","Color scheme does not have enough colors");w=p&&p.opacity;v=new z.ClassBreaksRenderer({classBreakInfos:l.map(function(a,c){return{minValue:a.minValue,maxValue:a.maxValue,
symbol:h.createSymbol(e,{type:b.symbolType,color:u[c],size:h.getSymbolSizeFromScheme(g,e),outline:h.getSymbolOutlineFromScheme(g,e,w),meshInfo:{colorMixMode:b.colorMixMode,edgesType:b.edgesType}}),label:a.label}}),defaultLabel:d?F.other:null,defaultSymbol:d?h.createSymbol(e,{type:b.symbolType,color:g.noDataColor,size:h.getSymbolSizeFromScheme(g,e),outline:h.getSymbolOutlineFromScheme(g,e,w),meshInfo:{colorMixMode:b.colorMixMode,edgesType:b.edgesType}}):null,field:b.field,valueExpression:b.valueExpression,
valueExpressionTitle:b.valueExpressionTitle,normalizationType:t,normalizationField:b.normalizationField,normalizationTotal:"percent-of-total"===t?k.normalizationTotal:void 0,legendOptions:b.legendOptions,authoringInfo:new K({type:"class-breaks-color",classificationMethod:m,standardDeviationInterval:b.standardDeviationInterval})});q||L.setLabelsForClassBreaks({classBreakInfos:v.classBreakInfos,classificationMethod:m,normalizationType:t,round:!0});p&&p.visualVariables&&p.visualVariables.length&&(v.visualVariables=
p.visualVariables.map(function(a){return a.clone()}));return[2,{renderer:v,colorScheme:x.cloneScheme(g),classBreaksResult:k,defaultValuesUsed:a.defaultValuesUsed,basemapId:f.basemapId,basemapTheme:f.basemapTheme}]}})})}Object.defineProperty(v,"__esModule",{value:!0});var Q=Math.pow(2,53)-1;v.createVisualVariable=H;v.createContinuousRenderer=function(b){return q(this,void 0,void 0,function(){var a,c,d,e,f,g,h,p,l;return r(this,function(k){switch(k.label){case 0:return[4,X(b)];case 1:return a=k.sent(),
c=a.layer,d=a.view,[4,t.all([H(M(a)),a.outlineOptimizationEnabled?I({layer:c,view:d}):null,a.sizeOptimizationEnabled?J({layer:c,view:d}):null])];case 2:return e=k.sent(),f=e[0],g=e[1],h=e[2],l=(p=a.normalizationField)?"field":void 0,[2,P(f,g,h,l,p,a)]}})})};v.createClassBreaksRenderer=function(b){return q(this,void 0,void 0,function(){var a,c;return r(this,function(d){switch(d.label){case 0:return[4,Y(b)];case 1:return a=d.sent(),[4,h.getClassBreaks(Z(a),a.outlineOptimizationEnabled)];case 2:return c=
d.sent(),[2,ga(a,c)]}})})};v.createPCTrueColorRenderer=function(b){return aa(b).then(function(a){return{renderer:new A.PointCloudRGBRenderer({field:"RGB",pointsPerInch:a.density,pointSizeAlgorithm:h.getPointSizeAlgorithm(a.size)})}})};v.createPCContinuousRenderer=function(b){return q(this,void 0,void 0,function(){var a,c,d,e,f;return r(this,function(g){switch(g.label){case 0:return[4,ba(b)];case 1:a=g.sent();if(!a.statistics)return[3,2];d=a.statistics;return[3,4];case 2:return[4,h.getSummaryStatistics({layer:a.layer,
field:a.field})];case 3:d=g.sent(),g.label=4;case 4:return c=d,[4,da(c,a)];case 5:return e=g.sent(),f=new A.PointCloudStretchRenderer({field:a.field,pointsPerInch:a.density,pointSizeAlgorithm:h.getPointSizeAlgorithm(a.size),stops:e.stops}),[2,{renderer:f,basemapId:e.basemapId,basemapTheme:e.basemapTheme,statistics:e.statistics,defaultValuesUsed:e.defaultValuesUsed,colorScheme:e.colorScheme}]}})})};v.createAgeRenderer=function(b){return q(this,void 0,void 0,function(){var a,c,d,e,f,g,k,p,l,m,n,q,v,
w,x,y,D,z,A,G,B;return r(this,function(r){switch(r.label){case 0:return[4,ca(b)];case 1:return a=r.sent(),c=a.defaultSymbolEnabled,d=a.view,e=a.startTime,f=a.endTime,g=a.symbolType,k=a.colorMixMode,p=a.edgesType,l=a.layer,[4,t.all([a.unit?{unit:a.unit,statistics:null}:S({view:d,layer:l,startTime:e,endTime:f}),a.outlineOptimizationEnabled?I({layer:l,view:d}):null,a.sizeOptimizationEnabled?J({layer:l,view:d}):null])];case 2:return m=r.sent(),n=m[0],q=m[1],v=m[2],w=n.unit,x=n.statistics,y=E.getAgeExpressions({layer:l,
startTime:e,endTime:f,unit:w}).valueExpression,D=R.substitute(F["ageInfo_"+w],{unit:w,startTime:h.formatDate(e,w,l),endTime:h.formatDate(f,w,l)}),[4,H(M({layer:l,basemap:a.basemap,valueExpression:y,symbolType:g,statistics:x,legendOptions:{title:D},colorScheme:a.colorScheme,theme:a.theme,view:d}))];case 3:return z=r.sent(),A={layer:l,valueExpression:y,defaultSymbolEnabled:c,symbolType:g,colorMixMode:k,edgesType:p},G=P(z,q,v,null,null,A),B=G.renderer.authoringInfo.visualVariables,B.forEach(function(a){return h.updateAgeRendererAuthoringInfoVV(a,
e,f,w)}),[2,u({},G,{unit:w})]}})})}});