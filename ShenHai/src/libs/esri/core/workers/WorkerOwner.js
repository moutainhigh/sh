// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../tsSupport/generatorHelper ../tsSupport/awaiterHelper ../../kernel ../Error ../Logger ../promiseUtils ./utils ./workerFactory".split(" "),function(B,C,m,p,r,t,u,h,f,v){function k(b,a){b["delete"](a)}var w=u.getLogger("esri.core.workers"),q=f.MessageType.ABORT,x=f.MessageType.INVOKE,y=f.MessageType.OPEN,z=f.MessageType.OPENED,n=f.MessageType.RESPONSE;return function(){function b(a,c){this._outJobs=new Map;this._inJobs=new Map;this.worker=a;this.id=c;a.addEventListener("message",
this._onMessage.bind(this));a.addEventListener("error",function(a){a.preventDefault();w.error(a)})}b.create=function(a){return p(this,void 0,void 0,function(){var c;return m(this,function(d){switch(d.label){case 0:return[4,v.createWorker()];case 1:return c=d.sent(),[2,new b(c,a)]}})})};b.prototype.terminate=function(){this.worker.terminate()};b.prototype.open=function(a,c){void 0===c&&(c={});return p(this,void 0,void 0,function(){var d,e,b=this;return m(this,function(l){d=c.signal;e=f.newJobId();
return[2,h.create(function(c,f){c={resolve:c,reject:f};h.onAbortOrThrow(d,function(){k(b._outJobs,e);b._post({type:q,jobId:e})});b._outJobs.set(e,c);b._post({type:y,jobId:e,modulePath:a})})]})})};b.prototype._onMessage=function(a){if(a=f.receiveMessage(a))switch(a.type){case z:this._onOpenedMessage(a);break;case n:this._onResponseMessage(a);break;case q:this._onAbortMessage(a);break;case x:this._onInvokeMessage(a)}};b.prototype._onAbortMessage=function(a){var c=this._inJobs;a=a.jobId;var d=c.get(a);
d&&(d.controller&&d.controller.abort(),k(c,a))};b.prototype._onInvokeMessage=function(a){var c=this,d=a.methodName,e=a.jobId,b=a.data;a=a.abortable?h.createAbortController():null;var l=this._inJobs,m=r.workerMessages[d],g;try{if("function"!==typeof m)throw new TypeError(d+" is not a function");g=m.call(null,b,{signal:a?a.signal:null})}catch(A){this._post({type:n,jobId:e,error:f.toInvokeError(A)});return}if(h.isPromiseLike(g)){l.set(e,{controller:a,promise:g});if(a&&"cancel"in g)h.onAbort(a.signal,
function(){return g.cancel()});g.then(function(a){l.has(e)&&(k(l,e),c._post({type:n,jobId:e},a))},function(a){l.has(e)&&(k(l,e),a||(a={message:"Error encountered at method"+d}),h.isAbortError(a)||c._post({type:n,jobId:e,error:f.toInvokeError(a||{message:"Error encountered at method "+d})}))})}else this._post({type:n,jobId:e},g)};b.prototype._onOpenedMessage=function(a){var c=a.jobId;a=a.data;var d=this._outJobs.get(c);d&&(k(this._outJobs,c),d.resolve(a))};b.prototype._onResponseMessage=function(a){var c=
a.jobId,d=a.error;a=a.data;var b=this._outJobs.get(c);b&&(k(this._outJobs,c),d?b.reject(t.fromJSON(JSON.parse(d))):b.resolve(a))};b.prototype._post=function(a,c,b){return f.postMessage(this.worker,a,c,b)};return b}()});